<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Netty源码剖析学习笔记 - 空歌白石的个人博客 - 基于Hugo构建</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="空歌白石" /><meta name="description" content="前言 本文记录了学习Netty源码的过程，正片文章内容包含思路分析和源码。
本文主要包含：
 Netty简介。 Netty基本组件。 Netty服务端启动。 NioEventLoop。 Netty如何新建连接。 Pipeline。 Netty的内存分配ByteBuf。 Netty的解码逻辑。 Netty的编码逻辑。 Netty性能优化工具类。 Netty中的设计模式。 Netty应用的性能优化。   本文源码为当前最新版本：netty 4.1
" /><meta name="keywords" content="Hugo, Java, 技术" />






<meta name="generator" content="Hugo 0.99.1 with theme even" />


<link rel="canonical" href="https://liubr1491.github.io/post/netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Netty源码剖析学习笔记" />
<meta property="og:description" content="前言
本文记录了学习Netty源码的过程，正片文章内容包含思路分析和源码。
本文主要包含：

Netty简介。
Netty基本组件。
Netty服务端启动。
NioEventLoop。
Netty如何新建连接。
Pipeline。
Netty的内存分配ByteBuf。
Netty的解码逻辑。
Netty的编码逻辑。
Netty性能优化工具类。
Netty中的设计模式。
Netty应用的性能优化。


本文源码为当前最新版本：netty 4.1
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liubr1491.github.io/post/netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-31T14:02:45+08:00" />
<meta property="article:modified_time" content="2022-07-31T14:02:45+08:00" />

<meta itemprop="name" content="Netty源码剖析学习笔记">
<meta itemprop="description" content="前言
本文记录了学习Netty源码的过程，正片文章内容包含思路分析和源码。
本文主要包含：

Netty简介。
Netty基本组件。
Netty服务端启动。
NioEventLoop。
Netty如何新建连接。
Pipeline。
Netty的内存分配ByteBuf。
Netty的解码逻辑。
Netty的编码逻辑。
Netty性能优化工具类。
Netty中的设计模式。
Netty应用的性能优化。


本文源码为当前最新版本：netty 4.1
"><meta itemprop="datePublished" content="2022-07-31T14:02:45+08:00" />
<meta itemprop="dateModified" content="2022-07-31T14:02:45+08:00" />
<meta itemprop="wordCount" content="53548">
<meta itemprop="keywords" content="Netty,源码," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Netty源码剖析学习笔记"/>
<meta name="twitter:description" content="前言
本文记录了学习Netty源码的过程，正片文章内容包含思路分析和源码。
本文主要包含：

Netty简介。
Netty基本组件。
Netty服务端启动。
NioEventLoop。
Netty如何新建连接。
Pipeline。
Netty的内存分配ByteBuf。
Netty的解码逻辑。
Netty的编码逻辑。
Netty性能优化工具类。
Netty中的设计模式。
Netty应用的性能优化。


本文源码为当前最新版本：netty 4.1
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">空歌白石</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">空歌白石</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Netty源码剖析学习笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-31 </span>
        <div class="post-category">
            <a href="/categories/netty/"> Netty </a>
            </div>
          <span class="more-meta"> 约 53548 字 </span>
          <span class="more-meta"> 预计阅读 107 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#1-netty简介">1. Netty简介</a>
      <ul>
        <li><a href="#netty是什么">Netty是什么</a></li>
        <li><a href="#有必要学吗">有必要学吗？</a></li>
        <li><a href="#怎么学">怎么学？</a></li>
      </ul>
    </li>
    <li><a href="#2-netty基本组件">2. Netty基本组件</a>
      <ul>
        <li><a href="#socket通信模型">Socket通信模型</a></li>
        <li><a href="#netty对socket通信模型的抽象">Netty对Socket通信模型的抽象</a>
          <ul>
            <li><a href="#nioeventloop">NioEventLoop</a></li>
            <li><a href="#channel">Channel</a></li>
            <li><a href="#bytebuf">ByteBuf</a></li>
            <li><a href="#pipeline">Pipeline</a></li>
            <li><a href="#channelhandler">ChannelHandler</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-netty服务端启动">3. Netty服务端启动</a>
      <ul>
        <li><a href="#创建服务端channel">创建服务端Channel</a></li>
        <li><a href="#反射创建服务端channel">反射创建服务端Channel</a></li>
        <li><a href="#初始化服务端channel">初始化服务端Channel</a></li>
        <li><a href="#注册selector">注册Selector</a></li>
        <li><a href="#端口绑定">端口绑定</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#4-nioeventloop">4. NioEventLoop</a>
      <ul>
        <li><a href="#nioeventloop创建">NioEventLoop创建</a>
          <ul>
            <li><a href="#newchild">newChild</a></li>
            <li><a href="#chooserfactorynewchooser">chooserFactory.newChooser()</a></li>
          </ul>
        </li>
        <li><a href="#nioeventloop启动">NioEventLoop启动</a>
          <ul>
            <li><a href="#nioeventloop启动触发器">NioEventLoop启动触发器</a></li>
            <li><a href="#启动线程的步骤">启动线程的步骤</a></li>
          </ul>
        </li>
        <li><a href="#nioeventloop执行逻辑">NioEventLoop执行逻辑</a>
          <ul>
            <li><a href="#run">run()</a></li>
            <li><a href="#select">select()</a></li>
            <li><a href="#processselectedkeys">processSelectedKeys()</a></li>
            <li><a href="#runalltasks">runAllTasks</a></li>
          </ul>
        </li>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
    <li><a href="#5-netty新连接接入">5. Netty新连接接入</a>
      <ul>
        <li><a href="#netty新连接接入处理">Netty新连接接入处理</a></li>
        <li><a href="#检测新连接">检测新连接</a></li>
        <li><a href="#创建niosocketchannel">创建NioSocketChannel</a>
          <ul>
            <li><a href="#netty中channel的分类">Netty中Channel的分类</a></li>
          </ul>
        </li>
        <li><a href="#分配nioeventloop线程以及注册selector">分配NioEventLoop线程以及注册Selector</a>
          <ul>
            <li><a href="#serverbootstrapacceptor">ServerBootstrapAcceptor</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#6-pipeline">6. pipeline</a>
      <ul>
        <li><a href="#pipeline的初始化">pipeline的初始化</a>
          <ul>
            <li><a href="#channelhandlercontext">ChannelHandlerContext</a></li>
            <li><a href="#channelinboundinvoker">ChannelInboundInvoker</a></li>
            <li><a href="#channeloutboundinvoker">ChannelOutboundInvoker</a></li>
          </ul>
        </li>
        <li><a href="#添加channelhandler">添加ChannelHandler</a></li>
        <li><a href="#删除channelhandler">删除ChannelHandler</a></li>
        <li><a href="#inbound事件的传播">Inbound事件的传播</a>
          <ul>
            <li><a href="#simplechannelinboundhandler">SimpleChannelInboundHandler</a></li>
          </ul>
        </li>
        <li><a href="#outbound事件的传播">OutBound事件的传播</a></li>
        <li><a href="#异常传播">异常传播</a></li>
      </ul>
    </li>
    <li><a href="#7-netty的内存分配bytebuf">7. Netty的内存分配（ByteBuf）</a>
      <ul>
        <li><a href="#bybuf结构">ByBuf结构</a></li>
        <li><a href="#abstractbytebuf">AbstractByteBuf</a>
          <ul>
            <li><a href="#unpooledheapbytebuf-vs-unpooleddirectbytebuf">UnpooledHeapByteBuf vs UnpooledDirectByteBuf</a></li>
          </ul>
        </li>
        <li><a href="#bytebufallocator">ByteBufAllocator</a>
          <ul>
            <li><a href="#abstractbytebufallocator">AbstractByteBufAllocator</a></li>
            <li><a href="#unpooledbytebufallocator">UnpooledByteBufAllocator</a></li>
            <li><a href="#pooledbytebufallocator">PooledByteBufAllocator</a></li>
            <li><a href="#netty内存规格">Netty内存规格</a></li>
            <li><a href="#memoryregioncache">MemoryRegionCache</a></li>
          </ul>
        </li>
        <li><a href="#关键概念">关键概念</a>
          <ul>
            <li><a href="#arena">arena</a></li>
            <li><a href="#chunk">chunk</a></li>
            <li><a href="#page--subpage">page &amp; subPage</a></li>
          </ul>
        </li>
        <li><a href="#page级别的allocatenormal">Page级别的allocateNormal</a></li>
        <li><a href="#subpage级别的allocatesmall">subPage级别的allocatesmall</a></li>
        <li><a href="#内存的释放">内存的释放</a>
          <ul>
            <li><a href="#objectpool">ObjectPool</a></li>
          </ul>
        </li>
        <li><a href="#总结-2">总结</a></li>
      </ul>
    </li>
    <li><a href="#8-netty的解码逻辑">8. Netty的解码逻辑</a>
      <ul>
        <li><a href="#基于固定长度解码器分析">基于固定长度解码器分析</a></li>
        <li><a href="#基于行解码器分析">基于行解码器分析</a></li>
        <li><a href="#基于分隔符解码器分析">基于分隔符解码器分析</a></li>
        <li><a href="#基于长度域解码器分析">基于长度域解码器分析</a></li>
        <li><a href="#总结-3">总结</a></li>
      </ul>
    </li>
    <li><a href="#9-netty的编码逻辑">9. Netty的编码逻辑</a>
      <ul>
        <li><a href="#writeandflush">writeAndFlush</a></li>
        <li><a href="#编码器处理逻辑messgetobyteencoder">编码器处理逻辑：MessgeToByteEncoder</a></li>
        <li><a href="#写buffer队列">写Buffer队列</a></li>
        <li><a href="#刷新buffer队列">刷新buffer队列</a></li>
      </ul>
    </li>
    <li><a href="#10-netty性能优化工具类">10. Netty性能优化工具类</a>
      <ul>
        <li><a href="#fastthreadlocal">FastThreadLocal</a>
          <ul>
            <li><a href="#init">init</a></li>
            <li><a href="#get">get</a></li>
            <li><a href="#fastthreadlocalthread">FastThreadLocalThread</a></li>
            <li><a href="#set">set</a></li>
          </ul>
        </li>
        <li><a href="#recycler">Recycler</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#objectpool-1">ObjectPool</a></li>
        <li><a href="#总结-4">总结</a></li>
      </ul>
    </li>
    <li><a href="#11-netty中的设计模式实现">11. Netty中的设计模式实现</a>
      <ul>
        <li><a href="#单例模式">单例模式</a>
          <ul>
            <li><a href="#readtimeoutexception">ReadTimeoutException</a></li>
            <li><a href="#mqttencoder">MqttEncoder</a></li>
          </ul>
        </li>
        <li><a href="#策略模式">策略模式</a>
          <ul>
            <li><a href="#defaulteventexecutorchooserfactory">DefaultEventExecutorChooserFactory</a></li>
          </ul>
        </li>
        <li><a href="#装饰者模式">装饰者模式</a>
          <ul>
            <li><a href="#wrappedbytebuf">WrappedByteBuf</a></li>
            <li><a href="#unreleasablebytebuf">UnreleasableByteBuf</a></li>
            <li><a href="#simpleleakawarebytebuf">SimpleLeakAwareByteBuf</a></li>
          </ul>
        </li>
        <li><a href="#观察者模式">观察者模式</a>
          <ul>
            <li><a href="#channelfuture">ChannelFuture</a></li>
            <li><a href="#abstractchannelhandlercontext">AbstractChannelHandlerContext</a></li>
            <li><a href="#defaultchannelpromise">DefaultChannelPromise</a></li>
            <li><a href="#defaultpromise">DefaultPromise</a></li>
          </ul>
        </li>
        <li><a href="#迭代器模式">迭代器模式</a>
          <ul>
            <li><a href="#bytebuf-1">ByteBuf</a></li>
            <li><a href="#abstractbytebuf-1">AbstractByteBuf</a></li>
            <li><a href="#compositebytebuf">CompositeByteBuf</a></li>
          </ul>
        </li>
        <li><a href="#责任链模式">责任链模式</a>
          <ul>
            <li><a href="#channelhandler责任处理器接口">ChannelHandler（责任处理器接口）</a></li>
            <li><a href="#channelpipeline责任链">ChannelPipeline（责任链）</a></li>
            <li><a href="#channelhandlercontext上下文">ChannelHandlerContext（上下文）</a></li>
            <li><a href="#责任终止机制">责任终止机制</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#12-netty应用的性能优化">12. Netty应用的性能优化</a>
      <ul>
        <li><a href="#单机百万连接调优">单机百万连接调优</a>
          <ul>
            <li><a href="#如何模拟百万连接">如何模拟百万连接</a></li>
            <li><a href="#突破局部文件句柄限制">突破局部文件句柄限制</a></li>
            <li><a href="#突破全局文件句柄限制">突破全局文件句柄限制</a></li>
          </ul>
        </li>
        <li><a href="#netty应用级别性能优化">Netty应用级别性能优化</a>
          <ul>
            <li><a href="#自建executorservice">自建ExecutorService</a></li>
            <li><a href="#利用netty原生的线程池">利用Netty原生的线程池</a></li>
            <li><a href="#总结-5">总结</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="前言">前言</h1>
<p>本文记录了学习Netty源码的过程，正片文章内容包含思路分析和源码。</p>
<p>本文主要包含：</p>
<ol>
<li>Netty简介。</li>
<li>Netty基本组件。</li>
<li>Netty服务端启动。</li>
<li>NioEventLoop。</li>
<li>Netty如何新建连接。</li>
<li>Pipeline。</li>
<li>Netty的内存分配ByteBuf。</li>
<li>Netty的解码逻辑。</li>
<li>Netty的编码逻辑。</li>
<li>Netty性能优化工具类。</li>
<li>Netty中的设计模式。</li>
<li>Netty应用的性能优化。</li>
</ol>
<blockquote>
<p>本文源码为当前最新版本：<a href="https://github.com/netty/netty/tree/4.1">netty 4.1</a></p>
</blockquote>
<h1 id="1-netty简介">1. Netty简介</h1>
<p>Netty在各个开源框架中都拥有众多的应用场景。</p>
<h2 id="netty是什么">Netty是什么</h2>
<ol>
<li>异步时间驱动框架，用于快速开发高性能服务端和客户端</li>
<li>封装了JDK底层的BIO和NIO模型，提供高度可用的API</li>
<li>自带编解码器解决拆包粘包问题，用户只用关心业务逻辑</li>
<li>精心设计的reactor线程模型支持高并发海量连接</li>
<li>自带各种协议栈让你处理任何一种通用协议都几乎不用亲自动手</li>
</ol>
<h2 id="有必要学吗">有必要学吗？</h2>
<ul>
<li>各大开源项目选择Netty作为底层通信框架</li>
<li>更好的使用，少走弯路</li>
<li>遇到bug，单机连接数上不去？性能遇到瓶颈？如何调优？</li>
<li>详解reactor线程模型</li>
<li>庞大的项目是如何组织的？设计模式，体验优秀设计</li>
<li>学会阅读开源源码</li>
</ul>
<h2 id="怎么学">怎么学？</h2>
<ul>
<li>首先，前人之路</li>
<li>其次，自己实践</li>
<li>Socket编程</li>
<li>踩过的坑，需要积累经验总结</li>
</ul>
<h1 id="2-netty基本组件">2. Netty基本组件</h1>
<h2 id="socket通信模型">Socket通信模型</h2>
<ol>
<li>服务端监听端口</li>
<li>客户端与服务端新建连接</li>
<li>服务端接收来自客户端的数据</li>
<li>服务端处理业务逻辑</li>
<li>服务端向客户端发送处理后的数据</li>
</ol>
<h2 id="netty对socket通信模型的抽象">Netty对Socket通信模型的抽象</h2>
<ol>
<li>服务端监听端口 -&gt; NioEventLoop</li>
<li>客户端与服务端新建连接 -&gt; Channel</li>
<li>服务端接收来自客户端的数据 -&gt; ByteBuff</li>
<li>服务端处理业务逻辑 -&gt; ChannelHandler</li>
<li>服务端向客户端发送处理后的数据 -&gt;</li>
</ol>
<h3 id="nioeventloop">NioEventLoop</h3>
<p>最重要组件，可以认为是Netty的发动机。不断监听的NioEventLoop可以看做是有一个Thread单独管理。</p>
<p>主要任务包括：</p>
<ol>
<li>监控客户端连接</li>
<li>处理客户端的读写</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">strategy</span> <span class="o">=</span> <span class="n">selectStrategy</span><span class="o">.</span><span class="na">calculateStrategy</span><span class="o">(</span><span class="n">selectNowSupplier</span><span class="o">,</span> <span class="n">hasTasks</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="k">switch</span> <span class="o">(</span><span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">BUSY_WAIT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// fall-through to SELECT since the busy-wait is not supported with NIO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">SELECT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">long</span> <span class="n">curDeadlineNanos</span> <span class="o">=</span> <span class="n">nextScheduledTaskDeadlineNanos</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">curDeadlineNanos</span> <span class="o">==</span> <span class="o">-</span><span class="n">1L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">curDeadlineNanos</span> <span class="o">=</span> <span class="n">NONE</span><span class="o">;</span> <span class="c1">// nothing on the calendar
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nextWakeupNanos</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">curDeadlineNanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(!</span><span class="n">hasTasks</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">strategy</span> <span class="o">=</span> <span class="n">select</span><span class="o">(</span><span class="n">curDeadlineNanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// This update is just to help block unnecessary selector wakeups
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// so use of lazySet is ok (no race condition)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">nextWakeupNanos</span><span class="o">.</span><span class="na">lazySet</span><span class="o">(</span><span class="n">AWAKE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// fall through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// If we receive an IOException here its because the Selector is messed up. Let&#39;s rebuild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// the selector and retry. https://github.com/netty/netty/issues/8566
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">rebuildSelector0</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">handleLoopException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">selectCnt</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelledKeys</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">needsToSelectAgain</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">ranTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="n">100</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">processSelectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Ensure we always run tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">processSelectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Ensure we always run tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="n">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// This will run the minimum number of tasks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">ranTasks</span> <span class="o">||</span> <span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">&gt;</span> <span class="n">MIN_PREMATURE_SELECTOR_RETURNS</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row for Selector {}.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">selectCnt</span> <span class="o">-</span> <span class="n">1</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unexpectedSelectorWakeup</span><span class="o">(</span><span class="n">selectCnt</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// Unexpected wakeup (unusual case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Harmless exception - log anyway
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">CancelledKeyException</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; raised by a Selector {} - JDK bug?&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">selector</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Always handle shutdown even if the loop processing threw an exception.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">isShuttingDown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">closeAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKeys</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">selectedKeys</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">processSelectedKeysOptimized</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">processSelectedKeysPlain</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channel">Channel</h3>
<p>Channel与Socket对应。可以任务是对客户端与服务端一条连接的封装。在封装的API中可以进行数据的读写操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKey</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">k</span><span class="o">,</span> <span class="n">AbstractNioChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractNioChannel</span><span class="o">.</span><span class="na">NioUnsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">k</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If the channel implementation throws an exception because there is no event loop, we ignore this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// because we are only trying to determine if ch is registered to this event loop and thus has authority
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to close ch.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// still healthy and should not be closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/5125
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// close the channel if the key is not valid anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readyOps</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">readyOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the NIO JDK channel implementation may throw a NotYetConnectedException.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/924
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ops</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">unsafe</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">forceFlush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to a spin loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">readyOps</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unsafe</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.channel.socket</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.ServerChannel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A TCP/IP {@link ServerChannel} which accepts incoming TCP/IP connections.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerSocketChannel</span> <span class="kd">extends</span> <span class="n">ServerChannel</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServerSocketChannelConfig</span> <span class="nf">config</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetSocketAddress</span> <span class="nf">localAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetSocketAddress</span> <span class="nf">remoteAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bytebuf">ByteBuf</h3>
<p>所有的数据读写都是基于ByteBuf完成。
ByteBuf -&gt; IO Buffer</p>
<h3 id="pipeline">Pipeline</h3>
<p>Channel的数据处理逻辑，Pipeline对应的一个具体的逻辑链，这里使用的是责任链模式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelPipeline</span>
</span></span><span class="line"><span class="cl">        <span class="kd">extends</span> <span class="n">ChannelInboundInvoker</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span><span class="o">,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channelhandler">ChannelHandler</h3>
<p>每一个ChannelHandler对应一个具体的逻辑模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called after the {@link ChannelHandler} was added to the actual context and it&#39;s ready to handle events.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called after the {@link ChannelHandler} was removed from the actual context and it doesn&#39;t handle events
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anymore.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if a {@link Throwable} was thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated if you want to handle this event you should implement {@link ChannelInboundHandler} and
</span></span></span><span class="line"><span class="cl"><span class="cm">     * implement the method there.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Indicates that the same instance of the annotated {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * can be added to one or more {@link ChannelPipeline}s multiple times
</span></span></span><span class="line"><span class="cl"><span class="cm">     * without a race condition.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If this annotation is not specified, you have to create a new handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * instance every time you add it to a pipeline because it has unshared
</span></span></span><span class="line"><span class="cl"><span class="cm">     * state such as member variables.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This annotation is provided for documentation purpose, just like
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;a href=&#34;http://www.javaconcurrencyinpractice.com/annotations/doc/&#34;&gt;the JCIP annotations&lt;/a&gt;.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Inherited</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Documented</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@interface</span> <span class="n">Sharable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// no value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="3-netty服务端启动">3. Netty服务端启动</h1>
<p>两个问题</p>
<ol>
<li>服务端的Scoket在哪里初始化</li>
<li>在哪里accept连接</li>
</ol>
<p>启动过程</p>
<ol>
<li>创建服务端Channel</li>
<li>初始化服务端Channel</li>
<li>注册Selector</li>
<li>端口绑定</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a new {@link Channel} and bind it.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">validate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SocketAddress</span> <span class="n">localAddress</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">localAddress</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">localAddress</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;localAddress not set&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">doBind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">initAndRegister</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">regFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// At this point we know that the registration was complete and successful.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">newPromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Registration future is almost always fulfilled already, but just in case it&#39;s not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">PendingRegistrationPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingRegistrationPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">regFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// IllegalStateException once we try to access the EventLoop of the Channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Registration was successful, so set the correct executor to use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// See https://github.com/netty/netty/issues/2586
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">promise</span><span class="o">.</span><span class="na">registered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建服务端channel">创建服务端Channel</h2>
<ol>
<li>bind() -&gt; 用户代码入口</li>
<li>initAndRegister() -&gt; 初始化并注册</li>
<li>newChannel() -&gt; 创建服务端Channel</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span> <span class="o">=</span> <span class="n">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// channel can be null if newChannel crashed (eg SocketException(&#34;too many open files&#34;))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="k">new</span> <span class="n">FailedChannel</span><span class="o">(),</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">group</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">isRegistered</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If we are here and the promise is not failed, it&#39;s one of the following cases:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1) If we attempted registration from the event loop, the registration has been completed at this point.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    i.e. It&#39;s safe to attempt bind() or connect() now because the channel has been registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) If we attempted registration from the other thread, the registration request has been successfully
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    added to the event loop&#39;s task queue for later execution.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    i.e. It&#39;s safe to attempt bind() or connect() now:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         because bind() or connect() will be executed *after* the scheduled registration task is executed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         because register(), bind(), and connect() are all bound to the same thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射创建服务端channel">反射创建服务端Channel</h2>
<ol>
<li>newSocket() -&gt; 通过JDK来创建底层JDK channel</li>
<li>NioServerScoketChannelConfig() -&gt; TCP参数配置类</li>
<li>AbstractNioChannel()
<ol>
<li>configureBlocking(false) -&gt; 阻塞模式</li>
<li>AbstractChannel() -&gt; 创建id、unsafe、pipeline</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">ServerSocketChannel</span> <span class="nf">newChannel</span><span class="o">(</span><span class="n">SelectorProvider</span> <span class="n">provider</span><span class="o">,</span> <span class="n">InternetProtocolFamily</span> <span class="n">family</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServerSocketChannel</span> <span class="n">channel</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">SelectorProviderUtil</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">OPEN_SERVER_SOCKET_CHANNEL_WITH_FAMILY</span><span class="o">,</span> <span class="n">provider</span><span class="o">,</span> <span class="n">family</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">channel</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">provider</span><span class="o">.</span><span class="na">openServerSocketChannel</span><span class="o">()</span> <span class="o">:</span> <span class="n">channel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to open a socket.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Create a new instance using the given {@link ServerSocketChannel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">(</span><span class="n">ServerSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioServerSocketChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param parent            the parent {@link Channel} by which this instance was created. May be {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param ch                the underlying {@link SelectableChannel} on which it operates
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param readInterestOp    the ops to set to receive data from the {@link SelectableChannel}
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">AbstractNioChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">SelectableChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span> <span class="o">=</span> <span class="n">readInterestOp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 空歌白石：设置服务端为非阻塞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ch</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to close a partially initialized socket.&#34;</span><span class="o">,</span> <span class="n">e2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to enter non-blocking mode.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param parent
</span></span></span><span class="line"><span class="cl"><span class="cm">    *        the parent of this channel. {@code null} if there&#39;s no parent.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">AbstractChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">id</span> <span class="o">=</span> <span class="n">newId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsafe</span> <span class="o">=</span> <span class="n">newUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">newChannelPipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="初始化服务端channel">初始化服务端Channel</h2>
<ol>
<li>init() -&gt; 初始化入口
<ol>
<li>set ChannelOptions, ChannelAttrs</li>
<li>set ChildOptions, ChildAttrs</li>
<li>config handler -&gt; 配置服务端pipeline</li>
<li>add ServerBootstrapAcceptor -&gt; 添加连接器</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">newOptionsArray</span><span class="o">(),</span> <span class="n">logger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setAttributes</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">newAttributesArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">EventLoopGroup</span> <span class="n">currentChildGroup</span> <span class="o">=</span> <span class="n">childGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ChannelHandler</span> <span class="n">currentChildHandler</span> <span class="o">=</span> <span class="n">childHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">ChannelOption</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildOptions</span> <span class="o">=</span> <span class="n">newOptionsArray</span><span class="o">(</span><span class="n">childOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildAttrs</span> <span class="o">=</span> <span class="n">newAttributesArray</span><span class="o">(</span><span class="n">childAttrs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="n">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">handler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ServerBootstrapAcceptor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">ch</span><span class="o">,</span> <span class="n">currentChildGroup</span><span class="o">,</span> <span class="n">currentChildHandler</span><span class="o">,</span> <span class="n">currentChildOptions</span><span class="o">,</span> <span class="n">currentChildAttrs</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="注册selector">注册Selector</h2>
<ol>
<li>AbatractChannel.register(channel) -&gt; 入口
<ol>
<li>this.eventLoop = eventLoop -&gt; 绑定线程</li>
<li>register0() -&gt; 实际注册
<ol>
<li>doRegister() -&gt; 调用JDK底层注册</li>
<li>invokeHandlerAddedIfNeeded()</li>
<li>fireChannelRegistered() -&gt; 传播事件到用户代码</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">,</span> <span class="s">&#34;eventLoop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">isRegistered</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;registered to an event loop already&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">isCompatible</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;incompatible event loop type: &#34;</span> <span class="o">+</span> <span class="n">eventLoop</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">eventLoop</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Force-closing a channel whose registration task was not accepted by an event loop: {}&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">closeForcibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">register0</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// check if the channel is still open as it could be closed in the mean time when the register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// call was outside of the eventLoop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">firstRegistration</span> <span class="o">=</span> <span class="n">neverRegistered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">doRegister</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">neverRegistered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// user may already fire events through the pipeline in the ChannelFutureListener.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">invokeHandlerAddedIfNeeded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only fire a channelActive if the channel has never been registered. This prevents firing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// multiple channel actives if the channel is deregistered and re-registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// This channel was registered before and autoRead() is set. This means we need to begin read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// again so that we process inbound data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// See https://github.com/netty/netty/issues/4805
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">beginRead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Close the channel directly to avoid FD leak.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">closeForcibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doRegister</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">selected</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">selectionKey</span> <span class="o">=</span> <span class="n">javaChannel</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">().</span><span class="na">unwrappedSelector</span><span class="o">(),</span> <span class="n">0</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">selected</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Force the Selector to select now as the &#34;canceled&#34; SelectionKey may still be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// cached and not removed because no Select.select(..) operation was called yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">eventLoop</span><span class="o">().</span><span class="na">selectNow</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">selected</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// We forced a select operation on the selector before but the SelectionKey is still cached
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// for whatever reason. JDK bug ?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">invokeHandlerAddedIfNeeded</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">firstRegistration</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We are now registered to the EventLoop. It&#39;s time to call the callbacks for the ChannelHandlers,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// that were added before the registration was done.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">callHandlerAddedForAllHandlers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelRegistered</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelRegistered</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelRegistered</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="端口绑定">端口绑定</h2>
<ol>
<li>AbstractUnsafe.bind() -&gt; 入口
<ol>
<li>doBind()
<ol>
<li>javaChannel().bind() -&gt; JDK底层绑定</li>
</ol>
</li>
<li>pipeline.fireChannelActive() -&gt; 传播事件
<ol>
<li>HeadContext.readIfIsAutoRead()</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// See: https://github.com/netty/netty/issues/576
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">getOption</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BROADCAST</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">localAddress</span> <span class="k">instanceof</span> <span class="n">InetSocketAddress</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">!((</span><span class="n">InetSocketAddress</span><span class="o">)</span> <span class="n">localAddress</span><span class="o">).</span><span class="na">getAddress</span><span class="o">().</span><span class="na">isAnyLocalAddress</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">isWindows</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">maybeSuperUser</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Warn a user about the fact that a non-root user can&#39;t receive a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// broadcast packet on *nix if the socket is bound on non-wildcard address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;A non-root user can&#39;t receive a broadcast packet if the socket &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;is not bound to a wildcard address; binding to a non-wildcard &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;address (&#34;</span> <span class="o">+</span> <span class="n">localAddress</span> <span class="o">+</span> <span class="s">&#34;) anyway as requested.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">wasActive</span> <span class="o">=</span> <span class="n">isActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">doBind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">closeIfClosed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">wasActive</span> <span class="o">&amp;&amp;</span> <span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeLater</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SuppressJava6Requirement</span><span class="o">(</span><span class="n">reason</span> <span class="o">=</span> <span class="s">&#34;Usage guarded by java version check&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">7</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">javaChannel</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readIfIsAutoRead</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Channel.read() or ChannelHandlerContext.read() was called
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="n">readInterestOp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Create a new instance using the given {@link ServerSocketChannel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">(</span><span class="n">ServerSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioServerSocketChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p>核心调用链路：newChannel() -&gt; init() -&gt; register() -&gt; doBind()。</p>
<p>最终使用的Channel和绑定端口都是使用的JDK底层的nio相关接口。</p>
<h1 id="4-nioeventloop">4. NioEventLoop</h1>
<p>三个问题：</p>
<ol>
<li>默认情况下，Netty服务端起多少线程？何时启动？</li>
<li>Netty是如何解决JDK空轮训bug的？
<ul>
<li>官方JDK声称在最新版本中已经解决，但是实际还会出现，Netty用了一种很巧妙的方法解决了这个问题。</li>
</ul>
</li>
<li>Netty是如何保证异步串行无锁化？
<ul>
<li>拿到客户端的Channel，而不需要对客户端Channel进行同步，就直接可以并发读写</li>
<li>ChannelHandler的所以操作都是线程安全的，不需要进行同步。</li>
</ul>
</li>
</ol>
<h2 id="nioeventloop创建">NioEventLoop创建</h2>
<ol>
<li>new NioEventLoopGroup() -&gt; 线程组，默认2*cpuCount
<ol>
<li>new ThreadPerTaskExecutor() -&gt; 线程创建器</li>
<li>foreach newChild() -&gt; 构建NioEventLoop</li>
<li>chooserFactory.newChooser() -&gt; 线程选择器</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span> <span class="n">RejectedExecutionHandlers</span><span class="o">.</span><span class="na">reject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* @see MultithreadEventExecutorGroup#MultithreadEventExecutorGroup(int, Executor, Object...)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">MultithreadEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="n">DEFAULT_EVENT_LOOP_THREADS</span> <span class="o">:</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>核心创建过程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param nThreads          the number of threads that will be used by this instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param executor          the Executor to use, or {@code null} if the default should be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param chooserFactory    the {@link EventExecutorChooserFactory} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param args              arguments which will passed to each {@link #newChild(Executor, Object...)} call
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">MultithreadEventExecutorGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkPositive</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="s">&#34;nThreads&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPerTaskExecutor</span><span class="o">(</span><span class="n">newDefaultThreadFactory</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventExecutor</span><span class="o">[</span><span class="n">nThreads</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nThreads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">children</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: Think about if this is a good exception type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;failed to create a child event loop&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">;</span> <span class="n">j</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">children</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">shutdownGracefully</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">;</span> <span class="n">j</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">EventExecutor</span> <span class="n">e</span> <span class="o">=</span> <span class="n">children</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">while</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">e</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Let the caller handle the interruption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">chooser</span> <span class="o">=</span> <span class="n">chooserFactory</span><span class="o">.</span><span class="na">newChooser</span><span class="o">(</span><span class="n">children</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">FutureListener</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">terminationListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FutureListener</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">terminatedChildren</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">()</span> <span class="o">==</span> <span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">terminationFuture</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">EventExecutor</span> <span class="n">e</span><span class="o">:</span> <span class="n">children</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">terminationFuture</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">terminationListener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">EventExecutor</span><span class="o">&gt;</span> <span class="n">childrenSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">EventExecutor</span><span class="o">&gt;(</span><span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">childrenSet</span><span class="o">,</span> <span class="n">children</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">readonlyChildren</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">childrenSet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="newchild">newChild</h3>
<p>完成工作：</p>
<ol>
<li>保存线程执行器 ThreadPerTaskExecutor</li>
<li>创建一个MpscQueue</li>
<li>创建一个selector</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">EventLoop</span> <span class="nf">newChild</span><span class="o">(</span><span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectorProvider</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectStrategyFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">RejectedExecutionHandler</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">2</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopTaskQueueFactory</span> <span class="n">taskQueueFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopTaskQueueFactory</span> <span class="n">tailTaskQueueFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">argsLength</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">argsLength</span> <span class="o">&gt;</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskQueueFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">EventLoopTaskQueueFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">3</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">argsLength</span> <span class="o">&gt;</span> <span class="n">4</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">tailTaskQueueFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">EventLoopTaskQueueFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">4</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">NioEventLoop</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">selectStrategyFactory</span><span class="o">.</span><span class="na">newSelectStrategy</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejectedExecutionHandler</span><span class="o">,</span> <span class="n">taskQueueFactory</span><span class="o">,</span> <span class="n">tailTaskQueueFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">NioEventLoop</span><span class="o">(</span><span class="n">NioEventLoopGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">SelectStrategy</span> <span class="n">strategy</span><span class="o">,</span> <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">EventLoopTaskQueueFactory</span> <span class="n">taskQueueFactory</span><span class="o">,</span> <span class="n">EventLoopTaskQueueFactory</span> <span class="n">tailTaskQueueFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">newTaskQueue</span><span class="o">(</span><span class="n">taskQueueFactory</span><span class="o">),</span> <span class="n">newTaskQueue</span><span class="o">(</span><span class="n">tailTaskQueueFactory</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejectedExecutionHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">provider</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">selectorProvider</span><span class="o">,</span> <span class="s">&#34;selectorProvider&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">selectStrategy</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">strategy</span><span class="o">,</span> <span class="s">&#34;selectStrategy&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 空歌白石：一个EventLoop与一个Selector绑定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">SelectorTuple</span> <span class="n">selectorTuple</span> <span class="o">=</span> <span class="n">openSelector</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">selector</span> <span class="o">=</span> <span class="n">selectorTuple</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">unwrappedSelector</span> <span class="o">=</span> <span class="n">selectorTuple</span><span class="o">.</span><span class="na">unwrappedSelector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">SingleThreadEventExecutor</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="kt">boolean</span> <span class="n">addTaskWakesUp</span><span class="o">,</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">taskQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedHandler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">addTaskWakesUp</span> <span class="o">=</span> <span class="n">addTaskWakesUp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">maxPendingTasks</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_PENDING_EXECUTOR_TASKS</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">executor</span> <span class="o">=</span> <span class="n">ThreadExecutorMap</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 空歌白石：外部线程执行Netty任务时，放在taskQueue中执行，不是放在主线程中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">.</span><span class="na">taskQueue</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">taskQueue</span><span class="o">,</span> <span class="s">&#34;taskQueue&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">rejectedExecutionHandler</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">rejectedHandler</span><span class="o">,</span> <span class="s">&#34;rejectedHandler&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chooserfactorynewchooser">chooserFactory.newChooser()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">chooser</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.UnstableApi</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Factory that creates new {@link EventExecutorChooser}s.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EventExecutorChooserFactory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns a new {@link EventExecutorChooser}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutorChooser</span> <span class="nf">newChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Chooses the next {@link EventExecutor} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl">    <span class="kd">interface</span> <span class="nc">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Returns the new {@link EventExecutor} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>EventExecutorChooserFactory的实现优化点：</p>
<ol>
<li>isPowerOfTwo() -&gt; 判断是否是2的幂，2,4,8
<ol>
<li>PowerOfTwoEventExecutorChooser -&gt; 优化的chooser
<ol>
<li>index++ &amp; (length - 1)</li>
</ol>
</li>
<li>GenericEventExecutorChooser -&gt; 普通的chooser
<ol>
<li>abs(index++ % length)</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">EventExecutorChooser</span> <span class="nf">newChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">isPowerOfTwo</span><span class="o">(</span><span class="n">executors</span><span class="o">.</span><span class="na">length</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">PowerOfTwoEventExecutorChooser</span><span class="o">(</span><span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">GenericEventExecutorChooser</span><span class="o">(</span><span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPowerOfTwo</span><span class="o">(</span><span class="kt">int</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">val</span><span class="o">)</span> <span class="o">==</span> <span class="n">val</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GenericEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use a &#39;long&#39; counter to avoid non-round-robin behaviour at the 32-bit overflow boundary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The 64-bit long solves this by placing the overflow so far into the future, that no system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// will encounter this in practice.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GenericEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">executors</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PowerOfTwoEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PowerOfTwoEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 空歌白石：计算机的 &amp; 操作要比 % 高效的多，所以在这里用PowerOfTwoEventExecutorChooser进行了优化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">executors</span><span class="o">[</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nioeventloop启动">NioEventLoop启动</h2>
<h3 id="nioeventloop启动触发器">NioEventLoop启动触发器</h3>
<ol>
<li>服务端启动绑定端口</li>
<li>新链接接入通过Chooser绑定一个NioEventLoop</li>
</ol>
<h3 id="启动线程的步骤">启动线程的步骤</h3>
<ol>
<li>bind() -&gt; execute(task) -&gt; 入口
<ol>
<li>startThread() -&gt; doStartThread() -&gt; 创建线程
<ol>
<li>ThreadPerTaskExecutor.execute()
<ol>
<li>thread = Thread.currentThread()</li>
<li>NioEventLoop.run() -&gt; 启动</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doBind0</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the pipeline in its channelRegistered() implementation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="na">CLOSE_ON_FAILURE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">immediate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">inEventLoop</span> <span class="o">=</span> <span class="n">inEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">addTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">inEventLoop</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">startThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">reject</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">removeTask</span><span class="o">(</span><span class="n">task</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">reject</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedOperationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// The task queue does not support removal so the best thing we can do is to just move on and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// hope we will be able to pick-up the task before its completely terminated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// In worst case we will log on termination.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">reject</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">reject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">addTaskWakesUp</span> <span class="o">&amp;&amp;</span> <span class="n">immediate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">wakeup</span><span class="o">(</span><span class="n">inEventLoop</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">inEventLoop</span><span class="o">(</span><span class="n">Thread</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">thread</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">thread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="n">SingleThreadEventExecutor</span><span class="o">&gt;</span> <span class="n">STATE_UPDATER</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;state&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startThread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NOT_STARTED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ST_NOT_STARTED</span><span class="o">,</span> <span class="n">ST_STARTED</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">doStartThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ST_STARTED</span><span class="o">,</span> <span class="n">ST_NOT_STARTED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStartThread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">updateLastExecutionTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Unexpected exception from an event executor: &#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">oldState</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">oldState</span> <span class="o">&gt;=</span> <span class="n">ST_SHUTTING_DOWN</span> <span class="o">||</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">oldState</span><span class="o">,</span> <span class="n">ST_SHUTTING_DOWN</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Check if confirmShutdown() was called at the end of the loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">gracefulShutdownStartTime</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isErrorEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Buggy &#34;</span> <span class="o">+</span> <span class="n">EventExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; implementation; &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                <span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.confirmShutdown() must &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                <span class="s">&#34;be called before run() implementation terminates.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Run all remaining tasks and shutdown hooks. At this point the event loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// is in ST_SHUTTING_DOWN state still accepting tasks which is needed for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// graceful shutdown with quietPeriod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// Now we want to make sure no more tasks can be added from this point. This is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// achieved by switching the state. Any new tasks beyond this point will be rejected.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">oldState</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">oldState</span> <span class="o">&gt;=</span> <span class="n">ST_SHUTDOWN</span> <span class="o">||</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">oldState</span><span class="o">,</span> <span class="n">ST_SHUTDOWN</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// We have the final set of tasks in the queue now, no more can be added, run all remaining.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// No need to loop here, this is the final pass.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">confirmShutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cleanup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Lets remove all FastThreadLocals for the Thread as we are about to terminate and notify
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// the future. The user may block on the future and once it unblocks the JVM may terminate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// and start unloading classes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// See https://github.com/netty/netty/issues/6596.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">FastThreadLocal</span><span class="o">.</span><span class="na">removeAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">ST_TERMINATED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">threadLock</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">numUserTasks</span> <span class="o">=</span> <span class="n">drainTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">numUserTasks</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;An event executor terminated with &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                    <span class="s">&#34;non-empty task queue (&#34;</span> <span class="o">+</span> <span class="n">numUserTasks</span> <span class="o">+</span> <span class="sc">&#39;)&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">terminationFuture</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ThreadPerTaskExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ThreadPerTaskExecutor</span><span class="o">(</span><span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">threadFactory</span><span class="o">,</span> <span class="s">&#34;threadFactory&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadFactory</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="n">command</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nioeventloop执行逻辑">NioEventLoop执行逻辑</h2>
<ol>
<li>run() -&gt; for(;;)
<ol>
<li>select() -&gt;  检查是否有IO事件</li>
<li>processSelectedKeys() -&gt; 处理IO事件</li>
<li>runAllTasks() -&gt; 处理异步任务队列</li>
</ol>
</li>
</ol>
<h3 id="run">run()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">selectStrategy</span><span class="o">.</span><span class="na">calculateStrategy</span><span class="o">(</span><span class="n">selectNowSupplier</span><span class="o">,</span> <span class="n">hasTasks</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                    <span class="k">switch</span> <span class="o">(</span><span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">BUSY_WAIT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// fall-through to SELECT since the busy-wait is not supported with NIO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">SELECT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">long</span> <span class="n">curDeadlineNanos</span> <span class="o">=</span> <span class="n">nextScheduledTaskDeadlineNanos</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">curDeadlineNanos</span> <span class="o">==</span> <span class="o">-</span><span class="n">1L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">curDeadlineNanos</span> <span class="o">=</span> <span class="n">NONE</span><span class="o">;</span> <span class="c1">// nothing on the calendar
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">nextWakeupNanos</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">curDeadlineNanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">(!</span><span class="n">hasTasks</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">strategy</span> <span class="o">=</span> <span class="n">select</span><span class="o">(</span><span class="n">curDeadlineNanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                            <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// This update is just to help block unnecessary selector wakeups
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// so use of lazySet is ok (no race condition)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">nextWakeupNanos</span><span class="o">.</span><span class="na">lazySet</span><span class="o">(</span><span class="n">AWAKE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// fall through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// If we receive an IOException here its because the Selector is messed up. Let&#39;s rebuild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// the selector and retry. https://github.com/netty/netty/issues/8566
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">rebuildSelector0</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">handleLoopException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">selectCnt</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="n">cancelledKeys</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">needsToSelectAgain</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">boolean</span> <span class="n">ranTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="n">100</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">processSelectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Ensure we always run tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">processSelectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Ensure we always run tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="n">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// This will run the minimum number of tasks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">ranTasks</span> <span class="o">||</span> <span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">&gt;</span> <span class="n">MIN_PREMATURE_SELECTOR_RETURNS</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row for Selector {}.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">selectCnt</span> <span class="o">-</span> <span class="n">1</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unexpectedSelectorWakeup</span><span class="o">(</span><span class="n">selectCnt</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// Unexpected wakeup (unusual case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Harmless exception - log anyway
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">CancelledKeyException</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; raised by a Selector {} - JDK bug?&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">selector</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Always handle shutdown even if the loop processing threw an exception.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">isShuttingDown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">closeAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="select">select()</h3>
<ol>
<li>deadline以及任务穿插逻辑处理</li>
<li>阻塞式select</li>
<li>避免jdk空轮训bug</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="nf">select</span><span class="o">(</span><span class="kt">long</span> <span class="n">deadlineNanos</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">deadlineNanos</span> <span class="o">==</span> <span class="n">NONE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Timeout will only be 0 if deadline is within 5 microsecs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">timeoutMillis</span> <span class="o">=</span> <span class="n">deadlineToDelayNanos</span><span class="o">(</span><span class="n">deadlineNanos</span> <span class="o">+</span> <span class="n">995000L</span><span class="o">)</span> <span class="o">/</span> <span class="n">1000000L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">timeoutMillis</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">?</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">()</span> <span class="o">:</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Given an arbitrary deadline {@code deadlineNanos}, calculate the number of nano seconds from now
</span></span></span><span class="line"><span class="cl"><span class="cm">* {@code deadlineNanos} would expire.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param deadlineNanos An arbitrary deadline in nano seconds.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return the number of nano seconds from now {@code deadlineNanos} would expire.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">deadlineToDelayNanos</span><span class="o">(</span><span class="kt">long</span> <span class="n">deadlineNanos</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="na">deadlineToDelayNanos</span><span class="o">(</span><span class="n">defaultCurrentTimeNanos</span><span class="o">(),</span> <span class="n">deadlineNanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>避免jdk空轮训bug。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">selectorAutoRebuildThreshold</span> <span class="o">=</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.selectorAutoRebuildThreshold&#34;</span><span class="o">,</span> <span class="n">512</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">selectorAutoRebuildThreshold</span> <span class="o">&lt;</span> <span class="n">MIN_PREMATURE_SELECTOR_RETURNS</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">selectorAutoRebuildThreshold</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">=</span> <span class="n">selectorAutoRebuildThreshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// returns true if selectCnt should be reset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">unexpectedSelectorWakeup</span><span class="o">(</span><span class="kt">int</span> <span class="n">selectCnt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Thread was interrupted so reset selected keys and break so we not run into a busy loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// As this is most likely a bug in the handler of the user or it&#39;s client library we will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// also log it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/2426
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely because &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Thread.currentThread().interrupt() was called. Use &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">selectCnt</span> <span class="o">&gt;=</span> <span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The selector returned prematurely many times in a row.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Rebuild the selector to work around the problem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">selectCnt</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rebuildSelector</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">rebuildSelector0</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Selector</span> <span class="n">oldSelector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">SelectorTuple</span> <span class="n">newSelectorTuple</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">oldSelector</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">newSelectorTuple</span> <span class="o">=</span> <span class="n">openSelector</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to create a new Selector.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Register all channels to the new Selector.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">nChannels</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">:</span> <span class="n">oldSelector</span><span class="o">.</span><span class="na">keys</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">a</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">key</span><span class="o">.</span><span class="na">isValid</span><span class="o">()</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">keyFor</span><span class="o">(</span><span class="n">newSelectorTuple</span><span class="o">.</span><span class="na">unwrappedSelector</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SelectionKey</span> <span class="n">newKey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">newSelectorTuple</span><span class="o">.</span><span class="na">unwrappedSelector</span><span class="o">,</span> <span class="n">interestOps</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="k">instanceof</span> <span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Update SelectionKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">((</span><span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="n">a</span><span class="o">).</span><span class="na">selectionKey</span> <span class="o">=</span> <span class="n">newKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">nChannels</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to re-register a Channel to the new Selector.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="k">instanceof</span> <span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AbstractNioChannel</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="n">a</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">close</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">NioTask</span><span class="o">&lt;</span><span class="n">SelectableChannel</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">(</span><span class="n">NioTask</span><span class="o">&lt;</span><span class="n">SelectableChannel</span><span class="o">&gt;)</span> <span class="n">a</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">invokeChannelUnregistered</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">selector</span> <span class="o">=</span> <span class="n">newSelectorTuple</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">unwrappedSelector</span> <span class="o">=</span> <span class="n">newSelectorTuple</span><span class="o">.</span><span class="na">unwrappedSelector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// time to close the old selector as everything else is registered to the new one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">oldSelector</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to close the old Selector.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Migrated &#34;</span> <span class="o">+</span> <span class="n">nChannels</span> <span class="o">+</span> <span class="s">&#34; channel(s) to the new Selector.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="processselectedkeys">processSelectedKeys()</h3>
<ol>
<li>selected keySet优化功能。事件复杂度都是o(1)</li>
<li>优化的方法：processSelectedKeysOptimized()</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKeys</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">selectedKeys</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">processSelectedKeysOptimized</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">processSelectedKeysPlain</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">SelectorTuple</span> <span class="nf">openSelector</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Selector</span> <span class="n">unwrappedSelector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unwrappedSelector</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="na">openSelector</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;failed to open a new selector&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">DISABLE_KEY_SET_OPTIMIZATION</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">SelectorTuple</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">maybeSelectorImplClass</span> <span class="o">=</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;sun.nio.ch.SelectorImpl&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kc">false</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">cause</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!(</span><span class="n">maybeSelectorImplClass</span> <span class="k">instanceof</span> <span class="n">Class</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ensure the current selector implementation is what we can instrument.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">!((</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">maybeSelectorImplClass</span><span class="o">).</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">maybeSelectorImplClass</span> <span class="k">instanceof</span> <span class="n">Throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">Throwable</span><span class="o">)</span> <span class="n">maybeSelectorImplClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;failed to instrument a special java.util.Set into: {}&#34;</span><span class="o">,</span> <span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">SelectorTuple</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">selectorImplClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">maybeSelectorImplClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">SelectedSelectionKeySet</span> <span class="n">selectedKeySet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelectedSelectionKeySet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">maybeException</span> <span class="o">=</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Field</span> <span class="n">selectedKeysField</span> <span class="o">=</span> <span class="n">selectorImplClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;selectedKeys&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Field</span> <span class="n">publicSelectedKeysField</span> <span class="o">=</span> <span class="n">selectorImplClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;publicSelectedKeys&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">9</span> <span class="o">&amp;&amp;</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Let us try to use sun.misc.Unsafe to replace the SelectionKeySet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// This allows us to also do this in Java9+ without any extra flags.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">long</span> <span class="n">selectedKeysFieldOffset</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">selectedKeysField</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">long</span> <span class="n">publicSelectedKeysFieldOffset</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                            <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">publicSelectedKeysField</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">selectedKeysFieldOffset</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">publicSelectedKeysFieldOffset</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">selectedKeysFieldOffset</span><span class="o">,</span> <span class="n">selectedKeySet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">publicSelectedKeysFieldOffset</span><span class="o">,</span> <span class="n">selectedKeySet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// We could not retrieve the offset, lets try reflection as last-resort.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">ReflectionUtil</span><span class="o">.</span><span class="na">trySetAccessible</span><span class="o">(</span><span class="n">selectedKeysField</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">cause</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">cause</span> <span class="o">=</span> <span class="n">ReflectionUtil</span><span class="o">.</span><span class="na">trySetAccessible</span><span class="o">(</span><span class="n">publicSelectedKeysField</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">cause</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">selectedKeysField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">selectedKeySet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">publicSelectedKeysField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">selectedKeySet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">maybeException</span> <span class="k">instanceof</span> <span class="n">Exception</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">selectedKeys</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Exception</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">Exception</span><span class="o">)</span> <span class="n">maybeException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;failed to instrument a special java.util.Set into: {}&#34;</span><span class="o">,</span> <span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">SelectorTuple</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selectedKeySet</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;instrumented a special java.util.Set into: {}&#34;</span><span class="o">,</span> <span class="n">unwrappedSelector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">SelectorTuple</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">new</span> <span class="n">SelectedSelectionKeySetSelector</span><span class="o">(</span><span class="n">unwrappedSelector</span><span class="o">,</span> <span class="n">selectedKeySet</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="selectedselectionkeyset">SelectedSelectionKeySet</h4>
<p>Netty仅仅关注add，因此自定义了AbstractSet，将不必要的方法都屏蔽掉了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">SelectedSelectionKeySet</span> <span class="kd">extends</span> <span class="n">AbstractSet</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SelectionKey</span><span class="o">[]</span> <span class="n">keys</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SelectedSelectionKeySet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelectionKey</span><span class="o">[</span><span class="n">1024</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">keys</span><span class="o">[</span><span class="n">size</span><span class="o">++]</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">keys</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">increaseCapacity</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">private</span> <span class="kt">int</span> <span class="n">idx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">SelectionKey</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchElementException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">keys</span><span class="o">[</span><span class="n">idx</span><span class="o">++];</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">reset</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">reset</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">keys</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">increaseCapacity</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SelectionKey</span><span class="o">[]</span> <span class="n">newKeys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelectionKey</span><span class="o">[</span><span class="n">keys</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">keys</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">newKeys</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">keys</span> <span class="o">=</span> <span class="n">newKeys</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="processselectedkeysoptimized">processSelectedKeysOptimized()</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKeysOptimized</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">size</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="n">k</span> <span class="o">=</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">keys</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// null out entry in the array to allow to have it GC&#39;ed once the Channel close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/2363
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">selectedKeys</span><span class="o">.</span><span class="na">keys</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Object</span> <span class="n">a</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="k">instanceof</span> <span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">processSelectedKey</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="o">(</span><span class="n">AbstractNioChannel</span><span class="o">)</span> <span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">NioTask</span><span class="o">&lt;</span><span class="n">SelectableChannel</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">(</span><span class="n">NioTask</span><span class="o">&lt;</span><span class="n">SelectableChannel</span><span class="o">&gt;)</span> <span class="n">a</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">processSelectedKey</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">needsToSelectAgain</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// null out entries in the array to allow to have it GC&#39;ed once the Channel close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/2363
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">selectedKeys</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">selectAgain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="runalltasks">runAllTasks</h3>
<p>几个步骤：</p>
<ol>
<li>task的分类和添加
<ul>
<li>定时任务</li>
<li>普通任务，普通任务会合并到定时任务中。</li>
</ul>
</li>
<li>任务的聚合</li>
<li>任务的执行</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Poll all tasks from the task queue and run them via {@link Runnable#run()} method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return {@code true} if and only if at least one task was run
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">runAllTasks</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">inEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">fetchedAll</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">ranAtLeastOne</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fetchedAll</span> <span class="o">=</span> <span class="n">fetchFromScheduledTaskQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">runAllTasksFrom</span><span class="o">(</span><span class="n">taskQueue</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ranAtLeastOne</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">fetchedAll</span><span class="o">);</span> <span class="c1">// keep on processing until we fetched all scheduled tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ranAtLeastOne</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lastExecutionTime</span> <span class="o">=</span> <span class="n">getCurrentTimeNanos</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">afterRunningAllTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ranAtLeastOne</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">ScheduledFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">schedule</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">callable</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">callable</span><span class="o">,</span> <span class="s">&#34;callable&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">unit</span><span class="o">,</span> <span class="s">&#34;unit&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">validateScheduled0</span><span class="o">(</span><span class="n">delay</span><span class="o">,</span> <span class="n">unit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">schedule</span><span class="o">(</span><span class="k">new</span> <span class="n">ScheduledFutureTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;(</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">,</span> <span class="n">callable</span><span class="o">,</span> <span class="n">deadlineNanos</span><span class="o">(</span><span class="n">getCurrentTimeNanos</span><span class="o">(),</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">delay</span><span class="o">))));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">executor</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">delayNanos</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Not yet expired, need to add or remove from queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">isCancelled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">scheduledExecutor</span><span class="o">().</span><span class="na">scheduledTaskQueue</span><span class="o">().</span><span class="na">removeTyped</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">scheduledExecutor</span><span class="o">().</span><span class="na">scheduleFromEventLoop</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">periodNanos</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">setUncancellableInternal</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">V</span> <span class="n">result</span> <span class="o">=</span> <span class="n">runTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">setSuccessInternal</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// check if is done as it may was cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">isCancelled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">runTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">().</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">periodNanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">deadlineNanos</span> <span class="o">+=</span> <span class="n">periodNanos</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">deadlineNanos</span> <span class="o">=</span> <span class="n">scheduledExecutor</span><span class="o">().</span><span class="na">getCurrentTimeNanos</span><span class="o">()</span> <span class="o">-</span> <span class="n">periodNanos</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(!</span><span class="n">isCancelled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">scheduledExecutor</span><span class="o">().</span><span class="na">scheduledTaskQueue</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFailureInternal</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Poll all tasks from the task queue and run them via {@link Runnable#run()} method.  This method stops running
</span></span></span><span class="line"><span class="cl"><span class="cm">* the tasks in the task queue and returns if it ran longer than {@code timeoutNanos}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">runAllTasks</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeoutNanos</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fetchFromScheduledTaskQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">pollTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">afterRunningAllTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">long</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">timeoutNanos</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">getCurrentTimeNanos</span><span class="o">()</span> <span class="o">+</span> <span class="n">timeoutNanos</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">runTasks</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">lastExecutionTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">safeExecute</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">runTasks</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Check timeout every 64 tasks because nanoTime() is relatively expensive.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// XXX: Hard-coded value - will make it configurable if it is really a problem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">runTasks</span> <span class="o">&amp;</span> <span class="n">0x3F</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastExecutionTime</span> <span class="o">=</span> <span class="n">getCurrentTimeNanos</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">lastExecutionTime</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">task</span> <span class="o">=</span> <span class="n">pollTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastExecutionTime</span> <span class="o">=</span> <span class="n">getCurrentTimeNanos</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">afterRunningAllTasks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">lastExecutionTime</span> <span class="o">=</span> <span class="n">lastExecutionTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结-1">总结</h2>
<p>三个问题：</p>
<ol>
<li>默认情况下，Netty服务端起多少线程？何时启动？
<ul>
<li>CPU核数的两倍</li>
</ul>
</li>
<li>Netty是如何解决JDK空轮训bug的？
<ul>
<li>官方JDK声称在最新版本中已经解决，但是实际还会出现，Netty用了一种很巧妙的方法解决了这个问题。</li>
<li>通过一个计数的方式，判断一个阻塞的操作并没有花费太多时间，判断这是一个空轮训，默认数量是512次。</li>
</ul>
</li>
<li>Netty是如何保证异步串行无锁化？
<ul>
<li>拿到客户端的Channel，而不需要对客户端Channel进行同步，就直接可以并发读写</li>
<li>ChannelHandler的所以操作都是线程安全的，不需要进行同步。</li>
<li>判断是外部时间，那么会放到一个具体的queue中执行。</li>
</ul>
</li>
</ol>
<h1 id="5-netty新连接接入">5. Netty新连接接入</h1>
<p>两个问题：</p>
<ol>
<li>Netty是在哪里检测有新连接接入的？</li>
<li>新连接是怎样注册到NioEventLoop线程的？</li>
</ol>
<h2 id="netty新连接接入处理">Netty新连接接入处理</h2>
<ol start="0">
<li>接收到accept</li>
<li>检测新连接</li>
<li>创建NioSocketChannel</li>
<li>分配NioEventLoop线程以及注册Selector</li>
<li>向Selector注册读事件</li>
</ol>
<h2 id="检测新连接">检测新连接</h2>
<ol>
<li>processSelectedKey(key,Channel) -&gt; 入口
<ol>
<li>NioMessageUnsafe.read()
<ol>
<li>doReadMessages() -&gt; while 循环
<ol>
<li>javaChannel().accept()</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKey</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">k</span><span class="o">,</span> <span class="n">AbstractNioChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractNioChannel</span><span class="o">.</span><span class="na">NioUnsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">k</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If the channel implementation throws an exception because there is no event loop, we ignore this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// because we are only trying to determine if ch is registered to this event loop and thus has authority
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to close ch.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// still healthy and should not be closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/5125
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// close the channel if the key is not valid anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readyOps</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">readyOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the NIO JDK channel implementation may throw a NotYetConnectedException.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/924
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ops</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">unsafe</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">forceFlush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to a spin loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">readyOps</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unsafe</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ChannelConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">RecvByteBufAllocator</span><span class="o">.</span><span class="na">Handle</span> <span class="n">allocHandle</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">().</span><span class="na">recvBufAllocHandle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">allocHandle</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">closed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Throwable</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">localRead</span> <span class="o">=</span> <span class="n">doReadMessages</span><span class="o">(</span><span class="n">readBuf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">closed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">allocHandle</span><span class="o">.</span><span class="na">incMessagesRead</span><span class="o">(</span><span class="n">localRead</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">continueReading</span><span class="o">(</span><span class="n">allocHandle</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">exception</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">readBuf</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">readBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">readBuf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">allocHandle</span><span class="o">.</span><span class="na">readComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelReadComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">closed</span> <span class="o">=</span> <span class="n">closeOnReadError</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">inputShutdown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">isOpen</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">close</span><span class="o">(</span><span class="n">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Check if there is a readPending which was not processed yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// This could be for two reasons:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/2254
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">readPending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">removeReadOp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doReadMessages</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SctpChannel</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">javaChannel</span><span class="o">().</span><span class="na">accept</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NioSctpChannel</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ch</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">NioSctpChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">SctpChannel</span> <span class="n">sctpChannel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">sctpChannel</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sctpChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioSctpChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">sctpChannel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">notificationHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SctpNotificationHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sctpChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;Failed to close a partially initialized sctp channel.&#34;</span><span class="o">,</span> <span class="n">e2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to enter non-blocking mode.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">continueReading</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">continueReading</span><span class="o">(</span><span class="n">defaultMaybeMoreSupplier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">continueReading</span><span class="o">(</span><span class="n">UncheckedBooleanSupplier</span> <span class="n">maybeMoreDataSupplier</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="o">(!</span><span class="n">respectMaybeMoreData</span> <span class="o">||</span> <span class="n">maybeMoreDataSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">totalMessages</span> <span class="o">&lt;</span> <span class="n">maxMessagePerRead</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ignoreBytesRead</span> <span class="o">||</span> <span class="n">totalBytesRead</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建niosocketchannel">创建NioSocketChannel</h2>
<ol>
<li>new NioSocketChannel(parent, ch) -&gt; 入口
<ol>
<li>AbstractNioByteChannel(p, ch, op_read)
<ol>
<li>configurBlocking(false) &amp; save op</li>
<li>create id, unsafe. pipeline</li>
</ol>
</li>
<li>new NioSocketChannelConfig()
<ol>
<li>setTcpNoDelay(true) -&gt; 禁止Nagle算法，小的数据包尽可能会发出去，降低延时。</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doReadMessages</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SctpChannel</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">javaChannel</span><span class="o">().</span><span class="na">accept</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 空歌白石：ch为客户端channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buf</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NioSctpChannel</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ch</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param parent    the {@link Channel} which created this instance or {@code null} if it was created by the user
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param socket    the {@link SocketChannel} which will be used
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">NioSocketChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">SocketChannel</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">socket</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioSocketChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">socket</span><span class="o">.</span><span class="na">socket</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param parent            the parent {@link Channel} by which this instance was created. May be {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param ch                the underlying {@link SelectableChannel} on which it operates
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param readInterestOp    the ops to set to receive data from the {@link SelectableChannel}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">AbstractNioChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">SelectableChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span> <span class="o">=</span> <span class="n">readInterestOp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ch</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;Failed to close a partially initialized socket.&#34;</span><span class="o">,</span> <span class="n">e2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to enter non-blocking mode.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="netty中channel的分类">Netty中Channel的分类</h3>
<ol>
<li>NioServerSocketChannel -&gt; 服务端channel</li>
<li>NioSocketChannel -&gt; 客户端channel</li>
<li>Unsafe</li>
</ol>
<p><img src="/img/Channel.png" alt="Channel"></p>
<h2 id="分配nioeventloop线程以及注册selector">分配NioEventLoop线程以及注册Selector</h2>
<p>head -&gt; ServerBootstrapAcceptor -&gt; tail</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">newOptionsArray</span><span class="o">(),</span> <span class="n">logger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setAttributes</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">newAttributesArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">EventLoopGroup</span> <span class="n">currentChildGroup</span> <span class="o">=</span> <span class="n">childGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ChannelHandler</span> <span class="n">currentChildHandler</span> <span class="o">=</span> <span class="n">childHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">ChannelOption</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildOptions</span> <span class="o">=</span> <span class="n">newOptionsArray</span><span class="o">(</span><span class="n">childOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildAttrs</span> <span class="o">=</span> <span class="n">newAttributesArray</span><span class="o">(</span><span class="n">childAttrs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="n">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">handler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ServerBootstrapAcceptor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">ch</span><span class="o">,</span> <span class="n">currentChildGroup</span><span class="o">,</span> <span class="n">currentChildHandler</span><span class="o">,</span> <span class="n">currentChildOptions</span><span class="o">,</span> <span class="n">currentChildAttrs</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="serverbootstrapacceptor">ServerBootstrapAcceptor</h3>
<ol>
<li>添加childHandler</li>
<li>设置options和atts</li>
<li>选择NioEventLoop并注册Selector</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Channel</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="n">Channel</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 空歌白石：添加childHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">child</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">childHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 空歌白石：设置options和atts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childOptions</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setAttributes</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childAttrs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">childGroup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">child</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">next</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">EventLoop</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">EventLoop</span><span class="o">)</span> <span class="kd">super</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">register0</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// check if the channel is still open as it could be closed in the mean time when the register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// call was outside of the eventLoop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">firstRegistration</span> <span class="o">=</span> <span class="n">neverRegistered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">doRegister</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">neverRegistered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// user may already fire events through the pipeline in the ChannelFutureListener.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">invokeHandlerAddedIfNeeded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only fire a channelActive if the channel has never been registered. This prevents firing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// multiple channel actives if the channel is deregistered and re-registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// This channel was registered before and autoRead() is set. This means we need to begin read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// again so that we process inbound data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// See https://github.com/netty/netty/issues/4805
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">beginRead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Close the channel directly to avoid FD leak.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">closeForcibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelActive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelActive</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeChannelActive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelInboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">channelActive</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">readIfIsAutoRead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelHandlerContext</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">(</span><span class="n">MASK_READ</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeRead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tasks</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">invokeTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span><span class="o">.</span><span class="na">invokeTasks</span> <span class="o">=</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Tasks</span><span class="o">(</span><span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">tasks</span><span class="o">.</span><span class="na">invokeReadTask</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeRead</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelOutboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">read</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="6-pipeline">6. pipeline</h1>
<p>Netty的大动脉，负责数据的传播。</p>
<p>几个问题：</p>
<ol>
<li>Netty是如何判断ChannelHandler类型的？
<ul>
<li>使用 <code>instanceof</code> 判断inbound还是outbound</li>
</ul>
</li>
<li>对于ChannelHandler的添加应该遵循什么样的顺序？
<ul>
<li>inbound与添加handler的顺序正相关</li>
<li>outbound与添加handler顺序逆相关</li>
</ul>
</li>
<li>用户手动触发事件传播，不同的触发方式由什么区别？</li>
</ol>
<h2 id="pipeline的初始化">pipeline的初始化</h2>
<ol>
<li>pipeline在创建Channel的时候被创建</li>
<li>pipeline节点数据结构：ChannelHandlerContext</li>
<li>pipeline中的两大哨兵：head和tail
<ul>
<li>head用于开始</li>
<li>tail负责结束，并且会处理异常等</li>
</ul>
</li>
</ol>
<p>一个channel对应一个pipeline</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param parent
</span></span></span><span class="line"><span class="cl"><span class="cm">    *        the parent of this channel. {@code null} if there&#39;s no parent.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">AbstractChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">ChannelId</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsafe</span> <span class="o">=</span> <span class="n">newUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">newChannelPipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns a new {@link DefaultChannelPipeline} instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">DefaultChannelPipeline</span> <span class="nf">newChannelPipeline</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPipeline</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>双向链表的数据结构。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">DefaultChannelPipeline</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;channel&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">succeededFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SucceededChannelFuture</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">voidPromise</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">VoidChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TailContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HeadContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tail</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channelhandlercontext">ChannelHandlerContext</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandlerContext</span> <span class="kd">extends</span> <span class="n">AttributeMap</span><span class="o">,</span> <span class="n">ChannelInboundInvoker</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the {@link Channel} which is bound to the {@link ChannelHandlerContext}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link EventExecutor} which is used to execute an arbitrary task.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="nf">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The unique name of the {@link ChannelHandlerContext}.The name was used when then {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * was added to the {@link ChannelPipeline}. This name can also be used to access the registered
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelHandler} from the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">name</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link ChannelHandler} that is bound this {@link ChannelHandlerContext}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">handler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return {@code true} if the {@link ChannelHandler} which belongs to this context was removed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * from the {@link ChannelPipeline}. Note that this method is only meant to be called from with in the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isRemoved</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channelinboundinvoker">ChannelInboundInvoker</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelInboundInvoker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} was registered to its {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#channelRegistered(ChannelHandlerContext)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} was unregistered from its {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#channelUnregistered(ChannelHandlerContext)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelUnregistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} is active now, which means it is connected.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#channelActive(ChannelHandlerContext)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} is inactive now, which means it is closed.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#channelInactive(ChannelHandlerContext)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelInactive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} received an {@link Throwable} in one of its inbound operations.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#exceptionCaught(ChannelHandlerContext, Throwable)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method  called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} received an user defined event.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the  {@link ChannelInboundHandler#userEventTriggered(ChannelHandlerContext, Object)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method  called of the next  {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireUserEventTriggered</span><span class="o">(</span><span class="n">Object</span> <span class="n">event</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A {@link Channel} received a message.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the {@link ChannelInboundHandler#channelRead(ChannelHandlerContext, Object)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method  called of the next {@link ChannelInboundHandler} contained in the  {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Triggers an {@link ChannelInboundHandler#channelReadComplete(ChannelHandlerContext)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * event to the next {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelReadComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Triggers an {@link ChannelInboundHandler#channelWritabilityChanged(ChannelHandlerContext)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * event to the next {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelInboundInvoker</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channeloutboundinvoker">ChannelOutboundInvoker</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelOutboundInvoker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to bind to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * completes, either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#bind(ChannelHandlerContext, SocketAddress, ChannelPromise)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to connect to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * completes, either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the connection fails because of a connection timeout, the {@link ChannelFuture} will get failed with
</span></span></span><span class="line"><span class="cl"><span class="cm">     * a {@link ConnectTimeoutException}. If it fails because of connection refused a {@link ConnectException}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to connect to the given {@link SocketAddress} while bind to the localAddress and notify the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelFuture} once the operation completes, either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to disconnect from the remote peer and notify the {@link ChannelFuture} once the operation completes,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#disconnect(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to close the {@link Channel} and notify the {@link ChannelFuture} once the operation completes,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After it is closed it is not possible to reuse it again.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#close(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to deregister from the previous assigned {@link EventExecutor} and notify the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelFuture} once the operation completes, either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#deregister(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">deregister</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to bind to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * completes, either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelPromise} will be notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#bind(ChannelHandlerContext, SocketAddress, ChannelPromise)} method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to connect to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * completes, either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelFuture} will be notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the connection fails because of a connection timeout, the {@link ChannelFuture} will get failed with
</span></span></span><span class="line"><span class="cl"><span class="cm">     * a {@link ConnectTimeoutException}. If it fails because of connection refused a {@link ConnectException}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to connect to the given {@link SocketAddress} while bind to the localAddress and notify the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelFuture} once the operation completes, either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelPromise} will be notified and also returned.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to disconnect from the remote peer and notify the {@link ChannelFuture} once the operation completes,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * either because the operation was successful or because of an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelPromise} will be notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#disconnect(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to close the {@link Channel} and notify the {@link ChannelFuture} once the operation completes,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After it is closed it is not possible to reuse it again.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelPromise} will be notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#close(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">close</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to deregister from the previous assigned {@link EventExecutor} and notify the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelFuture} once the operation completes, either because the operation was successful or because of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an error.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The given {@link ChannelPromise} will be notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#deregister(ChannelHandlerContext, ChannelPromise)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">deregister</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to Read data from the {@link Channel} into the first inbound buffer, triggers an
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelInboundHandler#channelRead(ChannelHandlerContext, Object)} event if data was
</span></span></span><span class="line"><span class="cl"><span class="cm">     * read, and triggers a
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelInboundHandler#channelReadComplete(ChannelHandlerContext) channelReadComplete} event so the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * handler can decide to continue reading.  If there&#39;s a pending read operation already, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will result in having the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler#read(ChannelHandlerContext)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method called of the next {@link ChannelOutboundHandler} contained in the {@link ChannelPipeline} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundInvoker</span> <span class="nf">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to write a message via this {@link ChannelHandlerContext} through the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This method will not request to actual flush, so be sure to call {@link #flush()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * once you want to request to flush all pending data to the actual transport.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to write a message via this {@link ChannelHandlerContext} through the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This method will not request to actual flush, so be sure to call {@link #flush()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * once you want to request to flush all pending data to the actual transport.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to flush all pending messages via this ChannelOutboundInvoker.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundInvoker</span> <span class="nf">flush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Shortcut for call {@link #write(Object, ChannelPromise)} and {@link #flush()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Shortcut for call {@link #write(Object)} and {@link #flush()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return a new {@link ChannelPromise}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPromise</span> <span class="nf">newPromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return an new {@link ChannelProgressivePromise}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelProgressivePromise</span> <span class="nf">newProgressivePromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new {@link ChannelFuture} which is marked as succeeded already. So {@link ChannelFuture#isSuccess()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will return {@code true}. All {@link FutureListener} added to it will be notified directly. Also
</span></span></span><span class="line"><span class="cl"><span class="cm">     * every call of blocking methods will just return without blocking.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">newSucceededFuture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new {@link ChannelFuture} which is marked as failed already. So {@link ChannelFuture#isSuccess()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will return {@code false}. All {@link FutureListener} added to it will be notified directly. Also
</span></span></span><span class="line"><span class="cl"><span class="cm">     * every call of blocking methods will just return without blocking.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">newFailedFuture</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return a special ChannelPromise which can be reused for different operations.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * It&#39;s only supported to use
</span></span></span><span class="line"><span class="cl"><span class="cm">     * it for {@link ChannelOutboundInvoker#write(Object, ChannelPromise)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Be aware that the returned {@link ChannelPromise} will not support most operations and should only be used
</span></span></span><span class="line"><span class="cl"><span class="cm">     * if you want to save an object allocation for every write operation. You will not be able to detect if the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * operation  was complete, only if it failed as the implementation will call
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelPipeline#fireExceptionCaught(Throwable)} in this case.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;strong&gt;Be aware this is an expert feature and should be used with care!&lt;/strong&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPromise</span> <span class="nf">voidPromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TailContext</span> <span class="kd">extends</span> <span class="n">AbstractChannelHandlerContext</span> <span class="kd">implements</span> <span class="n">ChannelInboundHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">TailContext</span><span class="o">(</span><span class="n">DefaultChannelPipeline</span> <span class="n">pipeline</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">pipeline</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">TAIL_NAME</span><span class="o">,</span> <span class="n">TailContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setAddComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">HeadContext</span> <span class="kd">extends</span> <span class="n">AbstractChannelHandlerContext</span>
</span></span><span class="line"><span class="cl">        <span class="kd">implements</span> <span class="n">ChannelOutboundHandler</span><span class="o">,</span> <span class="n">ChannelInboundHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Unsafe</span> <span class="n">unsafe</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HeadContext</span><span class="o">(</span><span class="n">DefaultChannelPipeline</span> <span class="n">pipeline</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">pipeline</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">HEAD_NAME</span><span class="o">,</span> <span class="n">HeadContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsafe</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">unsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setAddComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="添加channelhandler">添加ChannelHandler</h2>
<ol>
<li>判断是否重复添加</li>
<li>创建节点并添加至链表</li>
<li>回调添加完成事件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">executor</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">handlers</span><span class="o">,</span> <span class="s">&#34;handlers&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">h</span><span class="o">:</span> <span class="n">handlers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">addLast</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">newCtx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkMultiplicity</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">newCtx</span> <span class="o">=</span> <span class="n">newContext</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">filterName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">addLast0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If the registered is false it means that the channel was not registered on an eventLoop yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// In this case we add the context to the pipeline and add a task that will call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ChannelHandler.handlerAdded(...) once the channel is registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">newCtx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">callHandlerAddedInEventLoop</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="n">executor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkMultiplicity</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="k">instanceof</span> <span class="n">ChannelHandlerAdapter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ChannelHandlerAdapter</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">ChannelHandlerAdapter</span><span class="o">)</span> <span class="n">handler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">h</span><span class="o">.</span><span class="na">isSharable</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">added</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelPipelineException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34; is not a @Sharable handler, so can&#39;t be added or removed multiple times.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span><span class="o">.</span><span class="na">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Return {@code true} if the implementation is {@link Sharable} and so can be added
</span></span></span><span class="line"><span class="cl"><span class="cm">* to different {@link ChannelPipeline}s.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSharable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Cache the result of {@link Sharable} annotation detection to workaround a condition. We use a
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link ThreadLocal} and {@link WeakHashMap} to eliminate the volatile write/reads. Using different
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link WeakHashMap} instances per {@link Thread} is good enough for us and the number of
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link Thread}s are quite limited anyway.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * See &lt;a href=&#34;https://github.com/netty/netty/issues/2289&#34;&gt;#2289&lt;/a&gt;.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">handlerSharableCache</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Boolean</span> <span class="n">sharable</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">sharable</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sharable</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Sharable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">sharable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sharable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="nf">filterName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">generateName</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkDuplicateName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkDuplicateName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">context0</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Duplicate handler name: &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">context0</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">callHandlerAddedInEventLoop</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">newCtx</span><span class="o">,</span> <span class="n">EventExecutor</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">callHandlerAdded0</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="o">.</span><span class="na">callHandlerAdded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicRemoveFromHandlerList</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ctx</span><span class="o">.</span><span class="na">callHandlerRemoved</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to remove a handler: &#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">t2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">removed</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fireExceptionCaught</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelPipelineException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">handler</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;.handlerAdded() has thrown an exception; removed.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fireExceptionCaught</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelPipelineException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">handler</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;.handlerAdded() has thrown an exception; also failed to remove.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="删除channelhandler">删除ChannelHandler</h2>
<p>权限校验中经常会使用ChannelHandler的删除操作。</p>
<ol>
<li>找到ChannelHandler节点</li>
<li>标准的链表方式删除</li>
<li>回调删除Handler事件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">remove</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">remove</span><span class="o">(</span><span class="n">getContextOrDie</span><span class="o">(</span><span class="n">handler</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">getContextOrDie</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractChannelHandlerContext</span><span class="o">)</span> <span class="n">context</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchElementException</span><span class="o">(</span><span class="n">handler</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelHandlerContext</span> <span class="nf">context</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">context0</span><span class="o">(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">context0</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">remove</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">ctx</span> <span class="o">!=</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicRemoveFromHandlerList</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If the registered is false it means that the channel was not registered on an eventloop yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// In this case we remove the context from the pipeline and add a task that will call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ChannelHandler.handlerRemoved(...) once the channel is registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">callHandlerRemoved0</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">callHandlerRemoved0</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Method is synchronized to make the handler removal from the double linked list atomic.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">atomicRemoveFromHandlerList</span><span class="o">(</span><span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">callHandlerRemoved0</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Notify the complete removal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="o">.</span><span class="na">callHandlerRemoved</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireExceptionCaught</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelPipelineException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">handler</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.handlerRemoved() has thrown an exception.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">callHandlerRemoved</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only call handlerRemoved(...) if we called handlerAdded(...) before.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">handlerState</span> <span class="o">==</span> <span class="n">ADD_COMPLETE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span><span class="o">().</span><span class="na">handlerRemoved</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Mark the handler as removed in any case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setRemoved</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">setRemoved</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">handlerState</span> <span class="o">=</span> <span class="n">REMOVE_COMPLETE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="inbound事件的传播">Inbound事件的传播</h2>
<ol>
<li>何为InBound事件以及ChannelInBoundHandler</li>
<li>ChannelRead事件的传播</li>
<li>SimpleInBoundHandler处理器</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ChannelHandler} which adds callbacks for state changes. This allows the user
</span></span></span><span class="line"><span class="cl"><span class="cm"> * to hook in to state changes easily.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelInboundHandler</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was registered with its {@link EventLoop}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was unregistered from its {@link EventLoop}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelUnregistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} is now active
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was registered is now inactive and reached its
</span></span></span><span class="line"><span class="cl"><span class="cm">     * end of lifetime.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoked when the current {@link Channel} has read a message from the peer.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoked when the last message read by the current read operation has been consumed by
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link #channelRead(ChannelHandlerContext, Object)}.  If {@link ChannelOption#AUTO_READ} is off, no further
</span></span></span><span class="line"><span class="cl"><span class="cm">     * attempt to read an inbound data from the current {@link Channel} will be made until
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelHandlerContext#read()} is called.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if an user event was triggered.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called once the writable state of a {@link Channel} changed. You can check the state with
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel#isWritable()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if a {@link Throwable} was thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Calls {@link ChannelHandlerContext#fireChannelRead(Object)} to forward
</span></span></span><span class="line"><span class="cl"><span class="cm">* to the next {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* Sub-classes may override this method to change behavior.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Skip</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">invokeChannelRead</span><span class="o">(</span><span class="n">findContextInbound</span><span class="o">(</span><span class="n">MASK_CHANNEL_READ</span><span class="o">),</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">findContextInbound</span><span class="o">(</span><span class="kt">int</span> <span class="n">mask</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">currentExecutor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">skipContext</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">currentExecutor</span><span class="o">,</span> <span class="n">mask</span><span class="o">,</span> <span class="n">MASK_ONLY_INBOUND</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">),</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelInboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">channelRead</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="simplechannelinboundhandler">SimpleChannelInboundHandler</h3>
<p><code>SimpleChannelInboundHandler</code>可以自动释放ByteBuf。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TypeParameterMatcher</span> <span class="n">matcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #SimpleChannelInboundHandler(boolean)} with {@code true} as boolean parameter.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance which will try to detect the types to match out of the type parameter of the class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param autoRelease   {@code true} if handled messages should be released automatically by passing them to
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                      {@link ReferenceCountUtil#release(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;I&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">autoRelease</span> <span class="o">=</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #SimpleChannelInboundHandler(Class, boolean)} with {@code true} as boolean value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">inboundMessageType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">inboundMessageType</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param inboundMessageType    The type of messages to match
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param autoRelease           {@code true} if handled messages should be released automatically by passing them to
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              {@link ReferenceCountUtil#release(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">inboundMessageType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inboundMessageType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">autoRelease</span> <span class="o">=</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if the given message should be handled. If {@code false} it will be passed to the next
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">acceptInboundMessage</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">matcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">release</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">acceptInboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">imsg</span> <span class="o">=</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">channelRead0</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">imsg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">release</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">autoRelease</span> <span class="o">&amp;&amp;</span> <span class="n">release</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Is called for each message of type {@link I}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx           the {@link ChannelHandlerContext} which this {@link SimpleChannelInboundHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                      belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param msg           the message to handle
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception    is thrown if an error occurred
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">I</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Try to call {@link ReferenceCounted#release()} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">* If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">((</span><span class="n">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="outbound事件的传播">OutBound事件的传播</h2>
<ol>
<li>何为outBound事件以及ChannelOutBoundHandler</li>
<li>write()事件的传播</li>
</ol>
<p>推荐使用<code>ctx.channel().write()</code>写outbound，避免用<code>ctx.write();</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ChannelHandler} which will get notified for IO-outbound-operations.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelOutboundHandler</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a bind operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx           the {@link ChannelHandlerContext} for which the bind operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param localAddress  the {@link SocketAddress} to which it should bound
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise       the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception    thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a connect operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the connect operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param remoteAddress     the {@link SocketAddress} to which it should connect
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param localAddress      the {@link SocketAddress} which is used as source on connect
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a disconnect operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the disconnect operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a close operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the close operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a deregister operation is made from the current registered {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the close operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">deregister</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Intercepts {@link ChannelHandlerContext#read()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">read</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called once a write operation is made. The write operation will write the messages through the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelPipeline}. Those are then ready to be flushed to the actual {@link Channel} once
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel#flush()} is called
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the write operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param msg               the message to write
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a flush operation is made. The flush operation will try to flush out all previous written messages
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that are pending.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the flush operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Calls {@link ChannelHandlerContext#write(Object, ChannelPromise)} to forward
</span></span></span><span class="line"><span class="cl"><span class="cm">    * to the next {@link ChannelOutboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Sub-classes may override this method to change behavior.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Skip</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flush</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isNotValidPromise</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">(</span><span class="n">flush</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">MASK_WRITE</span> <span class="o">|</span> <span class="n">MASK_FLUSH</span><span class="o">)</span> <span class="o">:</span> <span class="n">MASK_WRITE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span><span class="o">.</span><span class="na">invokeWriteAndFlush</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span><span class="o">.</span><span class="na">invokeWrite</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">WriteTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">WriteTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">flush</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="o">!</span><span class="n">flush</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We failed to submit the WriteTask. We need to cancel it so we decrement the pending bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and put it back in the Recycler for re-use later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/8343.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">findContextOutbound</span><span class="o">(</span><span class="kt">int</span> <span class="n">mask</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">currentExecutor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">skipContext</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">currentExecutor</span><span class="o">,</span> <span class="n">mask</span><span class="o">,</span> <span class="n">MASK_ONLY_OUTBOUND</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">invokeWrite</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeWrite0</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeWrite0</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">((</span><span class="n">ChannelOutboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">write</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">notifyOutboundHandlerException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="异常传播">异常传播</h2>
<ol>
<li>异常的触发链
<ul>
<li>与Handler的添加顺序有关。</li>
<li>与intbound和outbound的类型无关。</li>
<li>handler不处理异常的话，会有tail节点负责最后的处理职责。</li>
<li>由于是由tail节点处理，因此只有inbound的unhandle方法。</li>
</ul>
</li>
<li>异常处理的最佳实践
<ul>
<li>在最后增加一个针对异常的Handler。</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelInboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">channelRead</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeExceptionCaught</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span><span class="o">().</span><span class="na">exceptionCaught</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;An exception {}&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;was thrown by a user handler&#39;s exceptionCaught() &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;method while handling the following exception:&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ThrowableUtil</span><span class="o">.</span><span class="na">stackTraceToString</span><span class="o">(</span><span class="n">error</span><span class="o">),</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;An exception &#39;{}&#39; [enable DEBUG level for full stacktrace] &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;was thrown by a user handler&#39;s exceptionCaught() &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;method while handling the following exception:&#34;</span><span class="o">,</span> <span class="n">error</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireExceptionCaught</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Makes best possible effort to detect if {@link ChannelHandler#handlerAdded(ChannelHandlerContext)} was called
</span></span></span><span class="line"><span class="cl"><span class="cm">* yet. If not return {@code false} and if called or could not detect return {@code true}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* If this method returns {@code false} we will not invoke the {@link ChannelHandler} but just forward the event.
</span></span></span><span class="line"><span class="cl"><span class="cm">* This is needed as {@link DefaultChannelPipeline} may already put the {@link ChannelHandler} in the linked-list
</span></span></span><span class="line"><span class="cl"><span class="cm">* but not called {@link ChannelHandler#handlerAdded(ChannelHandlerContext)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">invokeHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Store in local variable to reduce volatile reads.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">handlerState</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerState</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">handlerState</span> <span class="o">==</span> <span class="n">ADD_COMPLETE</span> <span class="o">||</span> <span class="o">(!</span><span class="n">ordered</span> <span class="o">&amp;&amp;</span> <span class="n">handlerState</span> <span class="o">==</span> <span class="n">ADD_PENDING</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelHandlerContext</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">findContextInbound</span><span class="o">(</span><span class="n">MASK_EXCEPTION_CAUGHT</span><span class="o">),</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeExceptionCaught</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">cause</span><span class="o">,</span> <span class="s">&#34;cause&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeExceptionCaught</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">next</span><span class="o">.</span><span class="na">invokeExceptionCaught</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to submit an exceptionCaught() event.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;The exceptionCaught() event that was failed to submit was:&#34;</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>onUnhandledInboundException</code>只有<code>Inbound</code>的未捕获异常处理，没有<code>outBound</code>的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Called once a {@link Throwable} hit the end of the {@link ChannelPipeline} without been handled by the user
</span></span></span><span class="line"><span class="cl"><span class="cm">* in {@link ChannelHandler#exceptionCaught(ChannelHandlerContext, Throwable)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onUnhandledInboundException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;An exceptionCaught() event was fired, and it reached at the tail of the pipeline. &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;It usually means the last handler in the pipeline did not handle the exception.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Try to call {@link ReferenceCounted#release()} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">* If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">((</span><span class="n">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="7-netty的内存分配bytebuf">7. Netty的内存分配（ByteBuf）</h1>
<p>三个问题：</p>
<ol>
<li>Netty的内存类型有哪些？
<ul>
<li>堆内堆外以外的类型</li>
</ul>
</li>
<li>如何减少多线程内存分配之间的竞争？</li>
<li>不同大小的内存是如何进行分配的？</li>
</ol>
<p>byteBuf在netty独立的<code>buffer</code>包中。</p>
<p>主要内容：</p>
<ol>
<li>内存与内存管理器的抽象</li>
<li>不同规则大小和不同类别的内存的分配策略</li>
<li>内存的回收过程</li>
</ol>
<h2 id="bybuf结构">ByBuf结构</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+-------------------+------------------+------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span> <span class="n">discardable</span> <span class="n">bytes</span> <span class="o">|</span>  <span class="n">readable</span> <span class="n">bytes</span>  <span class="o">|</span>  <span class="n">writable</span> <span class="n">bytes</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span>                   <span class="o">|</span>     <span class="o">(</span><span class="n">CONTENT</span><span class="o">)</span>    <span class="o">|</span>                  <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+-------------------+------------------+------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span>                   <span class="o">|</span>                  <span class="o">|</span>                  <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="n">0</span>      <span class="o">&lt;=</span>      <span class="n">readerIndex</span>   <span class="o">&lt;=</span>   <span class="n">writerIndex</span>    <span class="o">&lt;=</span>    <span class="n">capacity</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns the maximum allowed capacity of this buffer. This value provides an upper
</span></span></span><span class="line"><span class="cl"><span class="cm">* bound on {@link #capacity()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">maxCapacity</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">BEFORE</span> <span class="nf">discardReadBytes</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+-------------------+------------------+------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span> <span class="n">discardable</span> <span class="n">bytes</span> <span class="o">|</span>  <span class="n">readable</span> <span class="n">bytes</span>  <span class="o">|</span>  <span class="n">writable</span> <span class="n">bytes</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+-------------------+------------------+------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span>                   <span class="o">|</span>                  <span class="o">|</span>                  <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="n">0</span>      <span class="o">&lt;=</span>      <span class="n">readerIndex</span>   <span class="o">&lt;=</span>   <span class="n">writerIndex</span>    <span class="o">&lt;=</span>    <span class="n">capacity</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">AFTER</span> <span class="nf">discardReadBytes</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+------------------+--------------------------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span>  <span class="n">readable</span> <span class="n">bytes</span>  <span class="o">|</span>    <span class="n">writable</span> <span class="nf">bytes</span> <span class="o">(</span><span class="n">got</span> <span class="n">more</span> <span class="n">space</span><span class="o">)</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">+------------------+--------------------------------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="o">|</span>                  <span class="o">|</span>                                      <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">readerIndex</span> <span class="o">(</span><span class="n">0</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">writerIndex</span> <span class="o">(</span><span class="n">decreased</span><span class="o">)</span>        <span class="o">&lt;=</span>        <span class="n">capacity</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>包含5类常用方法</p>
<ol>
<li>read</li>
<li>set</li>
<li>write</li>
<li>mark</li>
<li>reset</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Gets a byte at the current {@code readerIndex} and increases
</span></span></span><span class="line"><span class="cl"><span class="cm">* the {@code readerIndex} by {@code 1} in this buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @throws IndexOutOfBoundsException
</span></span></span><span class="line"><span class="cl"><span class="cm">*         if {@code this.readableBytes} is less than {@code 1}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">byte</span>  <span class="nf">readByte</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Sets the specified byte at the specified absolute {@code index} in this
</span></span></span><span class="line"><span class="cl"><span class="cm">* buffer.  The 24 high-order bits of the specified value are ignored.
</span></span></span><span class="line"><span class="cl"><span class="cm">* This method does not modify {@code readerIndex} or {@code writerIndex} of
</span></span></span><span class="line"><span class="cl"><span class="cm">* this buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @throws IndexOutOfBoundsException
</span></span></span><span class="line"><span class="cl"><span class="cm">*         if the specified {@code index} is less than {@code 0} or
</span></span></span><span class="line"><span class="cl"><span class="cm">*         {@code index + 1} is greater than {@code this.capacity}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ByteBuf</span> <span class="nf">setByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Sets the specified byte at the current {@code writerIndex}
</span></span></span><span class="line"><span class="cl"><span class="cm">* and increases the {@code writerIndex} by {@code 1} in this buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">* The 24 high-order bits of the specified value are ignored.
</span></span></span><span class="line"><span class="cl"><span class="cm">* If {@code this.writableBytes} is less than {@code 1}, {@link #ensureWritable(int)}
</span></span></span><span class="line"><span class="cl"><span class="cm">* will be called in an attempt to expand capacity to accommodate.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ByteBuf</span> <span class="nf">writeByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Marks the current {@code readerIndex} in this buffer.  You can
</span></span></span><span class="line"><span class="cl"><span class="cm">* reposition the current {@code readerIndex} to the marked
</span></span></span><span class="line"><span class="cl"><span class="cm">* {@code readerIndex} by calling {@link #resetReaderIndex()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">* The initial value of the marked {@code readerIndex} is {@code 0}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ByteBuf</span> <span class="nf">markReaderIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Repositions the current {@code readerIndex} to the marked
</span></span></span><span class="line"><span class="cl"><span class="cm">* {@code readerIndex} in this buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @throws IndexOutOfBoundsException
</span></span></span><span class="line"><span class="cl"><span class="cm">*         if the current {@code writerIndex} is less than the marked
</span></span></span><span class="line"><span class="cl"><span class="cm">*         {@code readerIndex}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ByteBuf</span> <span class="nf">resetReaderIndex</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ByteBuf分类</p>
<ol>
<li>Pooled和Unpooled，预分配内存和非预分配内存，是否池化。</li>
<li>Unsafe和非Unsafe，是否会依赖于sun.Unsafe类。</li>
<li>Heap和Direct
<ul>
<li>Heap在堆上分配，会被GC管理</li>
<li>Direct不受JVM控制，堆外内存，需要手动释放，否则可能会引发OOM</li>
</ul>
</li>
</ol>
<p><img src="/img/ByteBuf.png" alt="ByteBuf"></p>
<h2 id="abstractbytebuf">AbstractByteBuf</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">byte</span> <span class="nf">readByte</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkReadableBytes0</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">readerIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">byte</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_getByte</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">readerIndex</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">setByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_setByte</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">_setByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">writeByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ensureWritable0</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_setByte</span><span class="o">(</span><span class="n">writerIndex</span><span class="o">++,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">byte</span> <span class="nf">getByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_getByte</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">resetReaderIndex</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">readerIndex</span><span class="o">(</span><span class="n">markedReaderIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">markWriterIndex</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">markedWriterIndex</span> <span class="o">=</span> <span class="n">writerIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unpooledheapbytebuf-vs-unpooleddirectbytebuf">UnpooledHeapByteBuf vs UnpooledDirectByteBuf</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnpooledHeapByteBuf</span> <span class="kd">extends</span> <span class="n">AbstractReferenceCountedByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ByteBuffer</span> <span class="n">tmpNioBuf</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A NIO {@link ByteBuffer} based buffer. It is recommended to use
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link UnpooledByteBufAllocator#directBuffer(int, int)}, {@link Unpooled#directBuffer(int)} and
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link Unpooled#wrappedBuffer(ByteBuffer)} instead of calling the constructor explicitly.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnpooledDirectByteBuf</span> <span class="kd">extends</span> <span class="n">AbstractReferenceCountedByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">;</span> <span class="c1">// accessed by UnpooledUnsafeNoCleanerDirectByteBuf.reallocateDirect()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">ByteBuffer</span> <span class="n">tmpNioBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">doNotFree</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new big-endian direct buffer with reasonably small initial capacity, which
</span></span></span><span class="line"><span class="cl"><span class="cm">     * expands its capacity boundlessly on demand.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ALLOC</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">directBuffer</span><span class="o">(</span><span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">,</span> <span class="n">DEFAULT_MAX_CAPACITY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxCapacity</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">emptyBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">validate</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newDirectBuffer</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">noCleaner</span> <span class="o">?</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">disableLeakDetector</span> <span class="o">?</span> <span class="n">buf</span> <span class="o">:</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bytebufallocator">ByteBufAllocator</h2>
<p>负责Netty的内存分配。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Implementations are responsible to allocate buffers. Implementations of this interface are expected to be
</span></span></span><span class="line"><span class="cl"><span class="cm"> * thread-safe.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ByteBufAllocator</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ByteBufAllocator</span> <span class="n">DEFAULT</span> <span class="o">=</span> <span class="n">ByteBufUtil</span><span class="o">.</span><span class="na">DEFAULT_ALLOCATOR</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf}. If it is a direct or heap buffer
</span></span></span><span class="line"><span class="cl"><span class="cm">     * depends on the actual implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf} with the given initial capacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If it is a direct or heap buffer depends on the actual implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf} with the given initial capacity and the given
</span></span></span><span class="line"><span class="cl"><span class="cm">     * maximal capacity. If it is a direct or heap buffer depends on the actual
</span></span></span><span class="line"><span class="cl"><span class="cm">     * implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf}, preferably a direct buffer which is suitable for I/O.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">ioBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf}, preferably a direct buffer which is suitable for I/O.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">ioBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf}, preferably a direct buffer which is suitable for I/O.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">ioBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a heap {@link ByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">heapBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a heap {@link ByteBuf} with the given initial capacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">heapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a heap {@link ByteBuf} with the given initial capacity and the given
</span></span></span><span class="line"><span class="cl"><span class="cm">     * maximal capacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">heapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a direct {@link ByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a direct {@link ByteBuf} with the given initial capacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a direct {@link ByteBuf} with the given initial capacity and the given
</span></span></span><span class="line"><span class="cl"><span class="cm">     * maximal capacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="nf">directBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If it is a direct or heap buffer depends on the actual implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link CompositeByteBuf} with the given maximum number of components that can be stored in it.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If it is a direct or heap buffer depends on the actual implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxNumComponents</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a heap {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeHeapBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a heap {@link CompositeByteBuf} with the given maximum number of components that can be stored in it.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeHeapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxNumComponents</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a direct {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeDirectBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a direct {@link CompositeByteBuf} with the given maximum number of components that can be stored in it.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeByteBuf</span> <span class="nf">compositeDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxNumComponents</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if direct {@link ByteBuf}&#39;s are pooled
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isDirectBufferPooled</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Calculate the new capacity of a {@link ByteBuf} that is used when a {@link ByteBuf} needs to expand by the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@code minNewCapacity} with {@code maxCapacity} as upper-bound.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">calculateNewCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minNewCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="abstractbytebufallocator">AbstractByteBufAllocator</h3>
<p>AbstractByteBufAllocator是对ByteBufAllocator的具体实现。UML继承关系图：</p>
<p><img src="/img/ByteBufAllocator.png" alt="ByteBufAllocator"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directByDefault</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">directBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">heapBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directByDefault</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">directBuffer</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">heapBuffer</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directByDefault</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">directBuffer</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">heapBuffer</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>PlatformDependent.hasUnsafe()</code>判断是否有Unsafe。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Create a direct {@link ByteBuf} with the given initialCapacity and maxCapacity.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolThreadCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">threadCache</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">directArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directArena</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">directArena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">()</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">                <span class="n">UnsafeByteBufUtil</span><span class="o">.</span><span class="na">newUnsafeDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">UnpooledDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unpooledbytebufallocator">UnpooledByteBufAllocator</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newHeapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">()</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">InstrumentedUnpooledHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">noCleaner</span> <span class="o">?</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">disableLeakDetector</span> <span class="o">?</span> <span class="n">buf</span> <span class="o">:</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Creates a new heap buffer with a newly allocated byte array.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param initialCapacity the initial capacity of the underlying byte array
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param maxCapacity the max capacity of the underlying byte array
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">UnpooledHeapByteBuf</span><span class="o">(</span><span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;initialCapacity(%d) &gt; maxCapacity(%d)&#34;</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">alloc</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">alloc</span><span class="o">,</span> <span class="s">&#34;alloc&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setArray</span><span class="o">(</span><span class="n">allocateArray</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">setIndex</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Creates a new direct buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param initialCapacity the initial capacity of the underlying direct buffer
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param maxCapacity     the maximum capacity of the underlying direct buffer
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">UnpooledDirectByteBuf</span><span class="o">(</span><span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">alloc</span><span class="o">,</span> <span class="s">&#34;alloc&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="s">&#34;initialCapacity&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">,</span> <span class="s">&#34;maxCapacity&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;initialCapacity(%d) &gt; maxCapacity(%d)&#34;</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">alloc</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setByteBuffer</span><span class="o">(</span><span class="n">allocateDirect</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setByteBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuffer</span> <span class="n">oldBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">oldBuffer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">doNotFree</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">doNotFree</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">freeDirect</span><span class="o">(</span><span class="n">oldBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpNioBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">capacity</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="unpooledunsafedirectbytebuf">UnpooledUnsafeDirectByteBuf</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">setByteBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">.</span><span class="na">setByteBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">tryFree</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">memoryAddress</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">directBufferAddress</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">directBufferAddress</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">PlatformDependent0</span><span class="o">.</span><span class="na">directBufferAddress</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">long</span> <span class="nf">directBufferAddress</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">getLong</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">ADDRESS_FIELD_OFFSET</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">getLong</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="kt">long</span> <span class="n">fieldOffset</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">UNSAFE</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">fieldOffset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pooledbytebufallocator">PooledByteBufAllocator</h3>
<ol>
<li>首先拿到线程局部缓存PoolThreadCache</li>
<li>在线程局部缓存的Area上进行内存分配</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolThreadCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">threadCache</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">directArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directArena</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">directArena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">()</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">                <span class="n">UnsafeByteBufUtil</span><span class="o">.</span><span class="na">newUnsafeDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">UnpooledDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">newByteBuf</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocate</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">* We use 2 * available processors by default to reduce contention as we use 2 * available processors for the
</span></span></span><span class="line"><span class="cl"><span class="cm">* number of EventLoops in NIO and EPOLL as well. If we choose a smaller number we will run into hot spots as
</span></span></span><span class="line"><span class="cl"><span class="cm">* allocation and de-allocation needs to be synchronized on the PoolArena.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* See https://github.com/netty/netty/issues/3888.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">int</span> <span class="n">defaultMinNumArena</span> <span class="o">=</span> <span class="n">NettyRuntime</span><span class="o">.</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">PooledByteBufAllocator</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">preferDirect</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nHeapArena</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nDirectArena</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxOrder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">int</span> <span class="n">smallCacheSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normalCacheSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">boolean</span> <span class="n">useCacheForAllThreads</span><span class="o">,</span> <span class="kt">int</span> <span class="n">directMemoryCacheAlignment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">preferDirect</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threadCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolThreadLocalCache</span><span class="o">(</span><span class="n">useCacheForAllThreads</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">smallCacheSize</span> <span class="o">=</span> <span class="n">smallCacheSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">normalCacheSize</span> <span class="o">=</span> <span class="n">normalCacheSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directMemoryCacheAlignment</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasAlignDirectByteBuffer</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span><span class="s">&#34;Buffer alignment is not supported. &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Either Unsafe or ByteBuffer.alignSlice() must be available.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ensure page size is a whole multiple of the alignment, or bump it to the next whole multiple.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pageSize</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">align</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">directMemoryCacheAlignment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">chunkSize</span> <span class="o">=</span> <span class="n">validateAndCalculateChunkSize</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">maxOrder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">nHeapArena</span><span class="o">,</span> <span class="s">&#34;nHeapArena&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">nDirectArena</span><span class="o">,</span> <span class="s">&#34;nDirectArena&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">directMemoryCacheAlignment</span><span class="o">,</span> <span class="s">&#34;directMemoryCacheAlignment&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">directMemoryCacheAlignment</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isDirectMemoryCacheAlignmentSupported</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;directMemoryCacheAlignment is not supported&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">directMemoryCacheAlignment</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">directMemoryCacheAlignment</span><span class="o">)</span> <span class="o">!=</span> <span class="n">directMemoryCacheAlignment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;directMemoryCacheAlignment: &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="n">directMemoryCacheAlignment</span> <span class="o">+</span> <span class="s">&#34; (expected: power of two)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pageShifts</span> <span class="o">=</span> <span class="n">validateAndCalculatePageShifts</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">directMemoryCacheAlignment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nHeapArena</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heapArenas</span> <span class="o">=</span> <span class="n">newArenaArray</span><span class="o">(</span><span class="n">nHeapArena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">PoolArenaMetric</span><span class="o">&gt;</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PoolArenaMetric</span><span class="o">&gt;(</span><span class="n">heapArenas</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">heapArenas</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PoolArena</span><span class="o">.</span><span class="na">HeapArena</span> <span class="n">arena</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolArena</span><span class="o">.</span><span class="na">HeapArena</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pageSize</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">heapArenas</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">arena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">heapArenaMetrics</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">metrics</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heapArenas</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">heapArenaMetrics</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nDirectArena</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">directArenas</span> <span class="o">=</span> <span class="n">newArenaArray</span><span class="o">(</span><span class="n">nDirectArena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">PoolArenaMetric</span><span class="o">&gt;</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PoolArenaMetric</span><span class="o">&gt;(</span><span class="n">directArenas</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">directArenas</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PoolArena</span><span class="o">.</span><span class="na">DirectArena</span> <span class="n">arena</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolArena</span><span class="o">.</span><span class="na">DirectArena</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">,</span> <span class="n">pageSize</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">,</span> <span class="n">directMemoryCacheAlignment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">directArenas</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">arena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">directArenaMetrics</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">metrics</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">directArenas</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">directArenaMetrics</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PooledByteBufAllocatorMetric</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="poolthreadlocalcache">PoolThreadLocalCache</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolThreadLocalCache</span> <span class="kd">extends</span> <span class="n">FastThreadLocal</span><span class="o">&lt;</span><span class="n">PoolThreadCache</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">useCacheForAllThreads</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PoolThreadLocalCache</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">useCacheForAllThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">useCacheForAllThreads</span> <span class="o">=</span> <span class="n">useCacheForAllThreads</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">PoolThreadCache</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">heapArenas</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">directArenas</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadExecutorMap</span><span class="o">.</span><span class="na">currentExecutor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">useCacheForAllThreads</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// If the current thread is a FastThreadLocalThread we will always use the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">current</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// The Thread is used by an EventExecutor, let&#39;s use the cache as the chances are good that we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// will allocate a lot!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolThreadCache</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">heapArena</span><span class="o">,</span> <span class="n">directArena</span><span class="o">,</span> <span class="n">smallCacheSize</span><span class="o">,</span> <span class="n">normalCacheSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">DEFAULT_MAX_CACHED_BUFFER_CAPACITY</span><span class="o">,</span> <span class="n">DEFAULT_CACHE_TRIM_INTERVAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">executor</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="n">trimTask</span><span class="o">,</span> <span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// No caching so just use 0 as sizes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">PoolThreadCache</span><span class="o">(</span><span class="n">heapArena</span><span class="o">,</span> <span class="n">directArena</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRemoval</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadCache</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">leastUsedArena</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">arenas</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">arenas</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">arenas</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">minArena</span> <span class="o">=</span> <span class="n">arenas</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//optimized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//If it is the first execution, directly return minarena and reduce the number of for loop comparisons below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">minArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">CACHE_NOT_USED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">minArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arenas</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arena</span> <span class="o">=</span> <span class="n">arenas</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">arena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">minArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">minArena</span> <span class="o">=</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">minArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="poolthreadcache">PoolThreadCache</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PoolThreadCache</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span><span class="o">,</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">smallCacheSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normalCacheSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCachedBufferCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">freeSweepAllocationThreshold</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">maxCachedBufferCapacity</span><span class="o">,</span> <span class="s">&#34;maxCachedBufferCapacity&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">freeSweepAllocationThreshold</span> <span class="o">=</span> <span class="n">freeSweepAllocationThreshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">heapArena</span> <span class="o">=</span> <span class="n">heapArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">directArena</span> <span class="o">=</span> <span class="n">directArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">directArena</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">smallSubPageDirectCaches</span> <span class="o">=</span> <span class="n">createSubPageCaches</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">smallCacheSize</span><span class="o">,</span> <span class="n">directArena</span><span class="o">.</span><span class="na">numSmallSubpagePools</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">normalDirectCaches</span> <span class="o">=</span> <span class="n">createNormalCaches</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">normalCacheSize</span><span class="o">,</span> <span class="n">maxCachedBufferCapacity</span><span class="o">,</span> <span class="n">directArena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">directArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// No directArea is configured so just null out all caches
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">smallSubPageDirectCaches</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">normalDirectCaches</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">heapArena</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Create the caches for the heap allocations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">smallSubPageHeapCaches</span> <span class="o">=</span> <span class="n">createSubPageCaches</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">smallCacheSize</span><span class="o">,</span> <span class="n">heapArena</span><span class="o">.</span><span class="na">numSmallSubpagePools</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">normalHeapCaches</span> <span class="o">=</span> <span class="n">createNormalCaches</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">normalCacheSize</span><span class="o">,</span> <span class="n">maxCachedBufferCapacity</span><span class="o">,</span> <span class="n">heapArena</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">heapArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// No heapArea is configured so just null out all caches
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">smallSubPageHeapCaches</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">normalHeapCaches</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Only check if there are caches in use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">smallSubPageDirectCaches</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">normalDirectCaches</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">                <span class="o">||</span> <span class="n">smallSubPageHeapCaches</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">normalHeapCaches</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">&amp;&amp;</span> <span class="n">freeSweepAllocationThreshold</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;freeSweepAllocationThreshold: &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span> <span class="n">freeSweepAllocationThreshold</span> <span class="o">+</span> <span class="s">&#34; (expected: &gt; 0)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="poolarena">PoolArena</h4>
<p>DirectArea分配Direct内存的流程</p>
<ol>
<li>从对象池里面拿到PooledByteBuf进行复用。</li>
<li>从缓存上进行内存分配</li>
<li>从内存堆里面进行内存分配</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">newByteBuf</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocate</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="nf">newByteBuf</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">HAS_UNSAFE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">PooledUnsafeDirectByteBuf</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">PooledDirectByteBuf</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="n">PooledUnsafeDirectByteBuf</span> <span class="nf">newInstance</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PooledUnsafeDirectByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">RECYCLER</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 空歌白石：内存复用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buf</span><span class="o">.</span><span class="na">reuse</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">PooledUnsafeDirectByteBuf</span><span class="o">&gt;</span> <span class="n">RECYCLER</span> <span class="o">=</span> <span class="n">ObjectPool</span><span class="o">.</span><span class="na">newPool</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">PooledUnsafeDirectByteBuf</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PooledUnsafeDirectByteBuf</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">PooledUnsafeDirectByteBuf</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">PooledUnsafeDirectByteBuf</span><span class="o">(</span><span class="n">handle</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Method must be called before reuse this {@link PooledByteBufAllocator}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">reuse</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">maxCapacity</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resetRefCnt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">setIndex0</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">discardMarks</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Handle for an pooled {@link Object} that will be used to notify the {@link ObjectPool} once it can
</span></span></span><span class="line"><span class="cl"><span class="cm">* reuse the pooled {@link Object} again.
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Recycle the {@link Object} if possible and so make it ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">T</span> <span class="n">self</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty内存分配的核心步骤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">sizeIdx</span> <span class="o">=</span> <span class="n">size2SizeIdx</span><span class="o">(</span><span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">sizeIdx</span> <span class="o">&lt;=</span> <span class="n">smallMaxSizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">tcacheAllocateSmall</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">sizeIdx</span> <span class="o">&lt;</span> <span class="n">nSizes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">tcacheAllocateNormal</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">normCapacity</span> <span class="o">=</span> <span class="n">directMemoryCacheAlignment</span> <span class="o">&gt;</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl">                <span class="o">?</span> <span class="n">normalizeSize</span><span class="o">(</span><span class="n">reqCapacity</span><span class="o">)</span> <span class="o">:</span> <span class="n">reqCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Huge allocations are never served via the cache so just call allocateHuge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">allocateHuge</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">tcacheAllocateSmall</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">allocateSmall</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// was able to allocate out of the cache so move on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Synchronize on the head. This is needed as {@link PoolChunk#allocateSubpage(int)} and
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link PoolChunk#free(long)} may modify the doubly linked list as well.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="n">smallSubpagePools</span><span class="o">[</span><span class="n">sizeIdx</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needsNormalAllocation</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">needsNormalAllocation</span> <span class="o">=</span> <span class="n">s</span> <span class="o">==</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">needsNormalAllocation</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">==</span> <span class="n">sizeIdx2size</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">)</span> <span class="o">:</span> <span class="s">&#34;doNotDestroy=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span> <span class="o">+</span> <span class="s">&#34;, elemSize=&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">+</span> <span class="s">&#34;, sizeIdx=&#34;</span> <span class="o">+</span> <span class="n">sizeIdx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">allocate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="o">.</span><span class="na">chunk</span><span class="o">.</span><span class="na">initBufWithSubpage</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">needsNormalAllocation</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">allocateNormal</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">incSmallAllocation</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">tcacheAllocateNormal</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">allocateNormal</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// was able to allocate out of the cache so move on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allocateNormal</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">++</span><span class="n">allocationsNormal</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocateNormal</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">q050</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q025</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q000</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">qInit</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q075</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add a new chunk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">newChunk</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">nPSizes</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">success</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">qInit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">incSmallAllocation</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocationsSmall</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocateHuge</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">newUnpooledChunk</span><span class="o">(</span><span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">activeBytesHuge</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">chunk</span><span class="o">.</span><span class="na">chunkSize</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">initUnpooled</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocationsHuge</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nettyruntime">NettyRuntime</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.util</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.ObjectUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.SystemPropertyUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A utility class for wrapping calls to {@link Runtime}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NettyRuntime</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Holder class for available processors to enable testing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AvailableProcessorsHolder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">availableProcessors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Set the number of available processors.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param availableProcessors the number of available processors
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @throws IllegalArgumentException if the specified number of available processors is non-positive
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @throws IllegalStateException    if the number of available processors is already configured
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setAvailableProcessors</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">availableProcessors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkPositive</span><span class="o">(</span><span class="n">availableProcessors</span><span class="o">,</span> <span class="s">&#34;availableProcessors&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">availableProcessors</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Locale</span><span class="o">.</span><span class="na">ROOT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;availableProcessors is already set to [%d], rejecting [%d]&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">this</span><span class="o">.</span><span class="na">availableProcessors</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">availableProcessors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">availableProcessors</span> <span class="o">=</span> <span class="n">availableProcessors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Get the configured number of available processors. The default is {@link Runtime#availableProcessors()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * This can be overridden by setting the system property &#34;io.netty.availableProcessors&#34; or by invoking
</span></span></span><span class="line"><span class="cl"><span class="cm">         * {@link #setAvailableProcessors(int)} before any calls to this method.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @return the configured number of available processors
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressForbidden</span><span class="o">(</span><span class="n">reason</span> <span class="o">=</span> <span class="s">&#34;to obtain default number of available processors&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">availableProcessors</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">availableProcessors</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="kt">int</span> <span class="n">availableProcessors</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                        <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="s">&#34;io.netty.availableProcessors&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">setAvailableProcessors</span><span class="o">(</span><span class="n">availableProcessors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">availableProcessors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AvailableProcessorsHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AvailableProcessorsHolder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the number of available processors.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param availableProcessors the number of available processors
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException if the specified number of available processors is non-positive
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalStateException    if the number of available processors is already configured
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unused,WeakerAccess&#34;</span><span class="o">)</span> <span class="c1">// this method is part of the public API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setAvailableProcessors</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">availableProcessors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">holder</span><span class="o">.</span><span class="na">setAvailableProcessors</span><span class="o">(</span><span class="n">availableProcessors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Get the configured number of available processors. The default is {@link Runtime#availableProcessors()}. This
</span></span></span><span class="line"><span class="cl"><span class="cm">     * can be overridden by setting the system property &#34;io.netty.availableProcessors&#34; or by invoking
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link #setAvailableProcessors(int)} before any calls to this method.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the configured number of available processors
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">availableProcessors</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">holder</span><span class="o">.</span><span class="na">availableProcessors</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * No public constructor to prevent instances from being created.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">NettyRuntime</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="netty内存规格">Netty内存规格</h3>
<p>规格：</p>
<ul>
<li>tiny： 0-512B</li>
<li>small: 512B-8K</li>
<li>normal: 8K-16M</li>
<li>huge：&gt;16M</li>
</ul>
<p>名称：</p>
<ul>
<li>16MB -&gt; chunk</li>
<li>8K -&gt; page</li>
<li>0-8K -&gt; subpage</li>
</ul>
<p>为什么会是16M？</p>
<blockquote>
<p>因为各种内存分配器的chunk都是按照16MB为单位，包括ptmalloc、tcmalloc、jemalloc等</p>
</blockquote>
<h3 id="memoryregioncache">MemoryRegionCache</h3>
<p>MemoryRegionCache负责Netty缓存命中的分配逻辑。</p>
<p>MemoryRegionCache分类</p>
<ol>
<li>queue
<ul>
<li>chunk handler</li>
</ul>
</li>
<li>sizeClass
<ul>
<li>tiny：0-512B</li>
<li>small：512B-8K</li>
<li>normal：8K-16M</li>
</ul>
</li>
<li>size
<ul>
<li>tiny：N*16B</li>
<li>small：512B、1K、2K、4K</li>
<li>normal：8K、16K、32K</li>
</ul>
</li>
</ol>
<p>不同类型的节点数量</p>
<ul>
<li>tiny[32]</li>
<li>small[4]</li>
<li>normal[3]</li>
</ul>
<p>**注意:**最新源码已经没有tiny类型，只包含small和normal类型。</p>
<p>核心流程：</p>
<ol>
<li>找到对应的size的MemoryRegionCache</li>
<li>从queue中弹出一个entry给ByteBuf初始化</li>
<li>将弹出的entry扔到对象池进行复用</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">SizeClass</span> <span class="n">sizeClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">allocations</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegionCache</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="n">SizeClass</span> <span class="n">sizeClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">MathUtil</span><span class="o">.</span><span class="na">safeFindNextPositivePowerOfTwo</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">newFixedMpscQueue</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sizeClass</span> <span class="o">=</span> <span class="n">sizeClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Init the {@link PooledByteBuf} using the provided chunk and handle with the capacity restrictions.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">initBuf</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Add to cache if not already full.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">newEntry</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">queued</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">queued</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If it was not possible to cache the chunk, immediately recycle the entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">entry</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queued</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Allocate something out of the cache if possible and remove the entry from the cache.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">initBuf</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">chunk</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">nioBuffer</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">handle</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// allocations is not thread-safe which is fine as this is only called from the same thread all time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">++</span> <span class="n">allocations</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Clear out this cache and free up all previous cached {@link PoolChunk}s and {@code handle}s.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">free</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">free</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">finalizer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">free</span><span class="o">(</span><span class="kt">int</span> <span class="n">max</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">numFreed</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;</span> <span class="n">numFreed</span> <span class="o">&lt;</span> <span class="n">max</span><span class="o">;</span> <span class="n">numFreed</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">freeEntry</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">finalizer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// all cleared
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">numFreed</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">numFreed</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Free up cached {@link PoolChunk}s if not allocated frequently enough.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">trim</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">allocations</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">allocations</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We not even allocated all the number that are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">free</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">free</span><span class="o">(</span><span class="n">free</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">&#34;unchecked&#34;</span><span class="o">,</span> <span class="s">&#34;rawtypes&#34;</span> <span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span>  <span class="kt">void</span> <span class="nf">freeEntry</span><span class="o">(</span><span class="n">Entry</span> <span class="n">entry</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Capture entry state before we recycle the entry object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PoolChunk</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">normCapacity</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">normCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// recycle now so PoolChunk can be GC&#39;ed. This will only be done if this is not freed because of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// a finalizer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">entry</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span><span class="o">.</span><span class="na">arena</span><span class="o">.</span><span class="na">freeChunk</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">sizeClass</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">finalizer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">recyclerHandle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">recyclerHandle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">recyclerHandle</span> <span class="o">=</span> <span class="n">recyclerHandle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">recycle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">chunk</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">nioBuffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">recyclerHandle</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;rawtypes&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Entry</span> <span class="nf">newEntry</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;?&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">RECYCLER</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">nioBuffer</span> <span class="o">=</span> <span class="n">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">normCapacity</span> <span class="o">=</span> <span class="n">normCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;rawtypes&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">RECYCLER</span> <span class="o">=</span> <span class="n">ObjectPool</span><span class="o">.</span><span class="na">newPool</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Entry</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Hold the caches for the different size classes, which are small and normal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;[]</span> <span class="n">smallSubPageHeapCaches</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;[]</span> <span class="n">smallSubPageDirectCaches</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;[]</span> <span class="n">normalHeapCaches</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;[]</span> <span class="n">normalDirectCaches</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="nf">createSubPageCaches</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cacheSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">numCaches</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cacheSize</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">numCaches</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemoryRegionCache</span><span class="o">[</span><span class="n">numCaches</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cache</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: maybe use cacheSize / cache.length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cache</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubPageMemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">cacheSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">recyclerHandle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">recyclerHandle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">recyclerHandle</span> <span class="o">=</span> <span class="n">recyclerHandle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recycle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nioBuffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recyclerHandle</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Handle for an pooled {@link Object} that will be used to notify the {@link ObjectPool} once it can
</span></span></span><span class="line"><span class="cl"><span class="cm">    * reuse the pooled {@link Object} again.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Recycle the {@link Object} if possible and so make it ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">T</span> <span class="n">self</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;object does not belong to handle&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">localPool</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">handles</span> <span class="o">=</span> <span class="n">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">handle</span><span class="o">.</span><span class="na">toAvailable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handles</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">handles</span><span class="o">.</span><span class="na">relaxedOffer</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="关键概念">关键概念</h2>
<h3 id="arena">arena</h3>
<p>通过Arena可以从系统开辟一块内存供netty使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">SizeClass</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Small</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Normal</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">PooledByteBufAllocator</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">int</span> <span class="n">numSmallSubpagePools</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">int</span> <span class="n">directMemoryCacheAlignment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">smallSubpagePools</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q050</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q025</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q000</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">qInit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q075</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q100</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>PoolChunkList使用双向链表关联chunk</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">PoolChunkListMetric</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PoolChunkMetric</span><span class="o">&gt;</span> <span class="n">EMPTY_METRICS</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.&lt;</span><span class="n">PoolChunkMetric</span><span class="o">&gt;</span><span class="n">emptyList</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">nextList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">minUsage</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxUsage</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">freeMinThreshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">freeMaxThreshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// This is only update once when create the linked like list of PoolChunkList in PoolArena constructor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">prevList</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="nf">PoolArena</span><span class="o">(</span><span class="n">PooledByteBufAllocator</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="kt">int</span> <span class="n">chunkSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cacheAlignment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">,</span> <span class="n">cacheAlignment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">directMemoryCacheAlignment</span> <span class="o">=</span> <span class="n">cacheAlignment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">numSmallSubpagePools</span> <span class="o">=</span> <span class="n">nSubpages</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">smallSubpagePools</span> <span class="o">=</span> <span class="n">newSubpagePoolArray</span><span class="o">(</span><span class="n">numSmallSubpagePools</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">smallSubpagePools</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">smallSubpagePools</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newSubpagePoolHead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">q100</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q075</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">q100</span><span class="o">,</span> <span class="n">75</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q050</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">q075</span><span class="o">,</span> <span class="n">50</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q025</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">q050</span><span class="o">,</span> <span class="n">25</span><span class="o">,</span> <span class="n">75</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q000</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">q025</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">50</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">qInit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolChunkList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">q000</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">25</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">q100</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="n">q075</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q075</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="n">q050</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q050</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="n">q025</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q025</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="n">q000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">q000</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">qInit</span><span class="o">.</span><span class="na">prevList</span><span class="o">(</span><span class="n">qInit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">PoolChunkListMetric</span><span class="o">&gt;</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PoolChunkListMetric</span><span class="o">&gt;(</span><span class="n">6</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">qInit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">q000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">q025</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">q050</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">q075</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">q100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunkListMetrics</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">metrics</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chunk">chunk</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">PoolChunkMetric</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SIZE_BIT_LENGTH</span> <span class="o">=</span> <span class="n">15</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">INUSED_BIT_LENGTH</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SUBPAGE_BIT_LENGTH</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BITMAP_IDX_BIT_LENGTH</span> <span class="o">=</span> <span class="n">32</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">IS_SUBPAGE_SHIFT</span> <span class="o">=</span> <span class="n">BITMAP_IDX_BIT_LENGTH</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">IS_USED_SHIFT</span> <span class="o">=</span> <span class="n">SUBPAGE_BIT_LENGTH</span> <span class="o">+</span> <span class="n">IS_SUBPAGE_SHIFT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SIZE_SHIFT</span> <span class="o">=</span> <span class="n">INUSED_BIT_LENGTH</span> <span class="o">+</span> <span class="n">IS_USED_SHIFT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RUN_OFFSET_SHIFT</span> <span class="o">=</span> <span class="n">SIZE_BIT_LENGTH</span> <span class="o">+</span> <span class="n">SIZE_SHIFT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Object</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">T</span> <span class="n">memory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">unpooled</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"></code></pre></td></tr></table>
</div>
</div><h3 id="page--subpage">page &amp; subPage</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">PoolSubpageMetric</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">runOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">runSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">bitmap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">doNotDestroy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxNumElems</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bitmapLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">nextAvail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">numAvail</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PoolSubpage</span><span class="o">(</span><span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span><span class="o">,</span> <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runOffset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">elemSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">pageShifts</span> <span class="o">=</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">runOffset</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">runSize</span> <span class="o">=</span> <span class="n">runSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">=</span> <span class="n">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bitmap</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">runSize</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">6</span> <span class="o">+</span> <span class="n">LOG2_QUANTUM</span><span class="o">];</span> <span class="c1">// runSize / 64 / QUANTUM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">doNotDestroy</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">elemSize</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxNumElems</span> <span class="o">=</span> <span class="n">numAvail</span> <span class="o">=</span> <span class="n">runSize</span> <span class="o">/</span> <span class="n">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nextAvail</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bitmapLength</span> <span class="o">=</span> <span class="n">maxNumElems</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">6</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">maxNumElems</span> <span class="o">&amp;</span> <span class="n">63</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bitmapLength</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bitmapLength</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bitmap</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">addToPool</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="page级别的allocatenormal">Page级别的allocateNormal</h2>
<p>Page级别的内存分配，要么都重新分配，要么都使用缓存。</p>
<ol>
<li>尝试在现有的chunk上分配</li>
<li>创建一个chunk进行内存分配</li>
<li>初始化PooledByteBuf</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocateNormal</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">q050</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q025</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q000</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">qInit</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q075</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add a new chunk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">newChunk</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">nPSizes</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">success</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">qInit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">sizeIdx</span> <span class="o">&lt;=</span> <span class="n">arena</span><span class="o">.</span><span class="na">smallMaxSizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// small
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handle</span> <span class="o">=</span> <span class="n">allocateSubpage</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">isSubpage</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// normal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// runSize must be multiple of pageSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">runSize</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">sizeIdx2size</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">handle</span> <span class="o">=</span> <span class="n">allocateRun</span><span class="o">(</span><span class="n">runSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">!</span><span class="n">isSubpage</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span> <span class="o">=</span> <span class="n">cachedNioBuffers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">?</span> <span class="n">cachedNioBuffers</span><span class="o">.</span><span class="na">pollLast</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">initBuf</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initBuf</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">isSubpage</span><span class="o">(</span><span class="n">handle</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">initBufWithSubpage</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">maxLength</span> <span class="o">=</span> <span class="n">runSize</span><span class="o">(</span><span class="n">pageShifts</span><span class="o">,</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">pageShifts</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">maxLength</span><span class="o">,</span> <span class="n">arena</span><span class="o">.</span><span class="na">parent</span><span class="o">.</span><span class="na">threadCache</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initBufWithSubpage</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">runOffset</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">bitmapIdx</span> <span class="o">=</span> <span class="n">bitmapIdx</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">reqCapacity</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">:</span> <span class="n">reqCapacity</span> <span class="o">+</span> <span class="s">&#34;&lt;=&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">(</span><span class="n">runOffset</span> <span class="o">&lt;&lt;</span> <span class="n">pageShifts</span><span class="o">)</span> <span class="o">+</span> <span class="n">bitmapIdx</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>原文描述：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Notation</span><span class="o">:</span> <span class="n">The</span> <span class="n">following</span> <span class="n">terms</span> <span class="n">are</span> <span class="n">important</span> <span class="n">to</span> <span class="n">understand</span> <span class="n">the</span> <span class="n">code</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">page</span>  <span class="o">-</span> <span class="n">a</span> <span class="n">page</span> <span class="n">is</span> <span class="n">the</span> <span class="n">smallest</span> <span class="n">unit</span> <span class="n">of</span> <span class="n">memory</span> <span class="n">chunk</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">allocated</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">run</span>   <span class="o">-</span> <span class="n">a</span> <span class="n">run</span> <span class="n">is</span> <span class="n">a</span> <span class="n">collection</span> <span class="n">of</span> <span class="n">pages</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">chunk</span> <span class="o">-</span> <span class="n">a</span> <span class="n">chunk</span> <span class="n">is</span> <span class="n">a</span> <span class="n">collection</span> <span class="n">of</span> <span class="n">runs</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">in</span> <span class="k">this</span> <span class="n">code</span> <span class="n">chunkSize</span> <span class="o">=</span> <span class="n">maxPages</span> <span class="o">*</span> <span class="n">pageSize</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">A</span> <span class="n">chunk</span> <span class="n">has</span> <span class="n">the</span> <span class="n">following</span> <span class="n">layout</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">/-----------------</span><span class="err">\</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="n">run</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|-----------------|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="n">run</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|-----------------|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="n">unalloctated</span>    <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="o">(</span><span class="n">freed</span><span class="o">)</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|-----------------|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="n">subpage</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|-----------------|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="n">unallocated</span>     <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="o">(</span><span class="n">freed</span><span class="o">)</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="o">...</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="o">...</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span> <span class="o">...</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="err">\</span><span class="o">-----------------/</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">handle</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">-------</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">a</span> <span class="n">handle</span> <span class="n">is</span> <span class="n">a</span> <span class="kt">long</span> <span class="n">number</span><span class="o">,</span> <span class="n">the</span> <span class="n">bit</span> <span class="n">layout</span> <span class="n">of</span> <span class="n">a</span> <span class="n">run</span> <span class="n">looks</span> <span class="n">like</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">oooooooo</span> <span class="n">ooooooos</span> <span class="n">ssssssss</span> <span class="n">ssssssue</span> <span class="n">bbbbbbbb</span> <span class="n">bbbbbbbb</span> <span class="n">bbbbbbbb</span> <span class="n">bbbbbbbb</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">o</span><span class="o">:</span> <span class="n">runOffset</span> <span class="o">(</span><span class="n">page</span> <span class="n">offset</span> <span class="n">in</span> <span class="n">the</span> <span class="n">chunk</span><span class="o">),</span> <span class="n">15bit</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">s</span><span class="o">:</span> <span class="n">size</span> <span class="o">(</span><span class="n">number</span> <span class="n">of</span> <span class="n">pages</span><span class="o">)</span> <span class="n">of</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">15bit</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">u</span><span class="o">:</span> <span class="n">isUsed</span><span class="o">?,</span> <span class="n">1bit</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">e</span><span class="o">:</span> <span class="n">isSubpage</span><span class="o">?,</span> <span class="n">1bit</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">b</span><span class="o">:</span> <span class="n">bitmapIdx</span> <span class="n">of</span> <span class="n">subpage</span><span class="o">,</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">not</span> <span class="n">subpage</span><span class="o">,</span> <span class="n">32bit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">long</span> <span class="nf">allocateRun</span><span class="o">(</span><span class="kt">int</span> <span class="n">runSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pages</span> <span class="o">=</span> <span class="n">runSize</span> <span class="o">&gt;&gt;</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pageIdx</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">pages2pageIdx</span><span class="o">(</span><span class="n">pages</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">runsAvailLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//find first queue which has at least one big enough run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">queueIdx</span> <span class="o">=</span> <span class="n">runFirstBestFit</span><span class="o">(</span><span class="n">pageIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">queueIdx</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//get run with min offset in this queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LongPriorityQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">runsAvail</span><span class="o">[</span><span class="n">queueIdx</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">handle</span> <span class="o">!=</span> <span class="n">LongPriorityQueue</span><span class="o">.</span><span class="na">NO_VALUE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isUsed</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span> <span class="o">:</span> <span class="s">&#34;invalid handle: &#34;</span> <span class="o">+</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">removeAvailRun</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">handle</span> <span class="o">=</span> <span class="n">splitLargeRun</span><span class="o">(</span><span class="n">handle</span><span class="o">,</span> <span class="n">pages</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">pinnedSize</span> <span class="o">=</span> <span class="n">runSize</span><span class="o">(</span><span class="n">pageShifts</span><span class="o">,</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">freeBytes</span> <span class="o">-=</span> <span class="n">pinnedSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runsAvailLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create / initialize a new PoolSubpage of normCapacity. Any PoolSubpage created / initialized here is added to
</span></span></span><span class="line"><span class="cl"><span class="cm">* subpage pool in the PoolArena that owns this PoolChunk
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param sizeIdx sizeIdx of normalized size
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return index in memoryMap
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">long</span> <span class="nf">allocateSubpage</span><span class="o">(</span><span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is need as we may add it back and so alter the linked-list structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">findSubpagePoolHead</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//allocate a new run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">runSize</span> <span class="o">=</span> <span class="n">calculateRunSize</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//runSize must be multiples of pageSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">long</span> <span class="n">runHandle</span> <span class="o">=</span> <span class="n">allocateRun</span><span class="o">(</span><span class="n">runSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">runHandle</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">runOffset</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">runHandle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">elemSize</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">sizeIdx2size</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">subpage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">head</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">runOffset</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">runSize</span><span class="o">(</span><span class="n">pageShifts</span><span class="o">,</span> <span class="n">runHandle</span><span class="o">),</span> <span class="n">elemSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">]</span> <span class="o">=</span> <span class="n">subpage</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">subpage</span><span class="o">.</span><span class="na">allocate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="subpage级别的allocatesmall">subPage级别的allocatesmall</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">tcacheAllocateSmall</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">allocateSmall</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// was able to allocate out of the cache so move on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Synchronize on the head. This is needed as {@link PoolChunk#allocateSubpage(int)} and
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link PoolChunk#free(long)} may modify the doubly linked list as well.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="n">smallSubpagePools</span><span class="o">[</span><span class="n">sizeIdx</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needsNormalAllocation</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">needsNormalAllocation</span> <span class="o">=</span> <span class="n">s</span> <span class="o">==</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">needsNormalAllocation</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">==</span> <span class="n">sizeIdx2size</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">)</span> <span class="o">:</span> <span class="s">&#34;doNotDestroy=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span> <span class="o">+</span> <span class="s">&#34;, elemSize=&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">+</span> <span class="s">&#34;, sizeIdx=&#34;</span> <span class="o">+</span> <span class="n">sizeIdx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">allocate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="o">.</span><span class="na">chunk</span><span class="o">.</span><span class="na">initBufWithSubpage</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">needsNormalAllocation</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">allocateNormal</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">incSmallAllocation</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Try to allocate a small buffer out of the cache. Returns {@code true} if successful {@code false} otherwise
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">allocateSmall</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;?&gt;</span> <span class="n">area</span><span class="o">,</span> <span class="n">PooledByteBuf</span><span class="o">&lt;?&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">allocate</span><span class="o">(</span><span class="n">cacheForSmall</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">),</span> <span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;?&gt;</span> <span class="n">cacheForSmall</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;?&gt;</span> <span class="n">area</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">isDirect</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">(</span><span class="n">smallSubPageDirectCaches</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cache</span><span class="o">(</span><span class="n">smallSubPageHeapCaches</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">&#34;unchecked&#34;</span><span class="o">,</span> <span class="s">&#34;rawtypes&#34;</span> <span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">allocate</span><span class="o">(</span><span class="n">MemoryRegionCache</span><span class="o">&lt;?&gt;</span> <span class="n">cache</span><span class="o">,</span> <span class="n">PooledByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// no cache found so just return false here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">allocated</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(++</span> <span class="n">allocations</span> <span class="o">&gt;=</span> <span class="n">freeSweepAllocationThreshold</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allocations</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">trim</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">allocated</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocateNormal</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">q050</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q025</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q000</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">qInit</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">q075</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add a new chunk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">newChunk</span><span class="o">(</span><span class="n">pageSize</span><span class="o">,</span> <span class="n">nPSizes</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">success</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">qInit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create / initialize a new PoolSubpage of normCapacity. Any PoolSubpage created / initialized here is added to
</span></span></span><span class="line"><span class="cl"><span class="cm">* subpage pool in the PoolArena that owns this PoolChunk
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param sizeIdx sizeIdx of normalized size
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return index in memoryMap
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">long</span> <span class="nf">allocateSubpage</span><span class="o">(</span><span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is need as we may add it back and so alter the linked-list structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">findSubpagePoolHead</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//allocate a new run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">runSize</span> <span class="o">=</span> <span class="n">calculateRunSize</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//runSize must be multiples of pageSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">long</span> <span class="n">runHandle</span> <span class="o">=</span> <span class="n">allocateRun</span><span class="o">(</span><span class="n">runSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">runHandle</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">runOffset</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">runHandle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">elemSize</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">sizeIdx2size</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">subpage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">head</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="n">runOffset</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">runSize</span><span class="o">(</span><span class="n">pageShifts</span><span class="o">,</span> <span class="n">runHandle</span><span class="o">),</span> <span class="n">elemSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">]</span> <span class="o">=</span> <span class="n">subpage</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">subpage</span><span class="o">.</span><span class="na">allocate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建<code>PoolChunk</code>时，也会同步初始化<code>PoolSubpage</code>的array。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">PoolChunk</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arena</span><span class="o">,</span> <span class="n">Object</span> <span class="n">base</span><span class="o">,</span> <span class="n">T</span> <span class="n">memory</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageShifts</span><span class="o">,</span> <span class="kt">int</span> <span class="n">chunkSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxPageIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unpooled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">arena</span> <span class="o">=</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">pageSize</span> <span class="o">=</span> <span class="n">pageSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">pageShifts</span> <span class="o">=</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">chunkSize</span> <span class="o">=</span> <span class="n">chunkSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">freeBytes</span> <span class="o">=</span> <span class="n">chunkSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">runsAvail</span> <span class="o">=</span> <span class="n">newRunsAvailqueueArray</span><span class="o">(</span><span class="n">maxPageIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">runsAvailLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">runsAvailMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongLongHashMap</span><span class="o">(-</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">subpages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolSubpage</span><span class="o">[</span><span class="n">chunkSize</span> <span class="o">&gt;&gt;</span> <span class="n">pageShifts</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//insert initial run, offset = 0, pages = chunkSize / pageSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">pages</span> <span class="o">=</span> <span class="n">chunkSize</span> <span class="o">&gt;&gt;</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">initHandle</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">pages</span> <span class="o">&lt;&lt;</span> <span class="n">SIZE_SHIFT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">insertAvailRun</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">pages</span><span class="o">,</span> <span class="n">initHandle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cachedNioBuffers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;(</span><span class="n">8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从bitmap中找到未被使用的subpage，可用状态为0，则从pool中移除。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns the bitmap index of the subpage allocation.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">allocate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">numAvail</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">doNotDestroy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">bitmapIdx</span> <span class="o">=</span> <span class="n">getNextAvail</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="n">bitmapIdx</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">6</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bitmapIdx</span> <span class="o">&amp;</span> <span class="n">63</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">(</span><span class="n">bitmap</span><span class="o">[</span><span class="n">q</span><span class="o">]</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bitmap</span><span class="o">[</span><span class="n">q</span><span class="o">]</span> <span class="o">|=</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(--</span> <span class="n">numAvail</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">removeFromPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">toHandle</span><span class="o">(</span><span class="n">bitmapIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addToPool</span><span class="o">(</span><span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>bitmapIdx与memoryMapIdx 拼接。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">long</span> <span class="nf">toHandle</span><span class="o">(</span><span class="kt">int</span> <span class="n">bitmapIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pages</span> <span class="o">=</span> <span class="n">runSize</span> <span class="o">&gt;&gt;</span> <span class="n">pageShifts</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">runOffset</span> <span class="o">&lt;&lt;</span> <span class="n">RUN_OFFSET_SHIFT</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">pages</span> <span class="o">&lt;&lt;</span> <span class="n">SIZE_SHIFT</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">IS_USED_SHIFT</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">IS_SUBPAGE_SHIFT</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="n">bitmapIdx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initBufWithSubpage</span><span class="o">(</span><span class="n">PooledByteBuf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reqCapacity</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">runOffset</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">bitmapIdx</span> <span class="o">=</span> <span class="n">bitmapIdx</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">subpages</span><span class="o">[</span><span class="n">runOffset</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="na">doNotDestroy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">reqCapacity</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span> <span class="o">:</span> <span class="n">reqCapacity</span> <span class="o">+</span> <span class="s">&#34;&lt;=&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">(</span><span class="n">runOffset</span> <span class="o">&lt;&lt;</span> <span class="n">pageShifts</span><span class="o">)</span> <span class="o">+</span> <span class="n">bitmapIdx</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">reqCapacity</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">elemSize</span><span class="o">,</span> <span class="n">threadCache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxLength</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">init0</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">maxLength</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initUnpooled</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">init0</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">init0</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxLength</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">chunk</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">!</span><span class="n">PoolChunk</span><span class="o">.</span><span class="na">isSubpage</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span> <span class="o">||</span> <span class="n">chunk</span><span class="o">.</span><span class="na">arena</span><span class="o">.</span><span class="na">size2SizeIdx</span><span class="o">(</span><span class="n">maxLength</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">chunk</span><span class="o">.</span><span class="na">arena</span><span class="o">.</span><span class="na">smallMaxSizeIdx</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Allocated small sub-page handle for a buffer size that isn&#39;t \&#34;small.\&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span><span class="o">.</span><span class="na">incrementPinnedMemory</span><span class="o">(</span><span class="n">maxLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="na">memory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpNioBuf</span> <span class="o">=</span> <span class="n">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocator</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="na">arena</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">maxLength</span> <span class="o">=</span> <span class="n">maxLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="内存的释放">内存的释放</h2>
<p>核心过程：</p>
<ol>
<li>连续的内存区段加到缓存</li>
<li>标记联系的内存区段为未使用的内存段</li>
<li>ByteBuf加到对象池</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">deallocate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">memory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span><span class="o">.</span><span class="na">decrementPinnedMemory</span><span class="o">(</span><span class="n">maxLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span><span class="o">.</span><span class="na">arena</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">tmpNioBuf</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">maxLength</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmpNioBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">decrementPinnedMemory</span><span class="o">(</span><span class="kt">int</span> <span class="n">delta</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pinnedBytes</span><span class="o">.</span><span class="na">add</span><span class="o">(-</span><span class="n">delta</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">chunk</span><span class="o">.</span><span class="na">unpooled</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="na">chunkSize</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">destroyChunk</span><span class="o">(</span><span class="n">chunk</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">activeBytesHuge</span><span class="o">.</span><span class="na">add</span><span class="o">(-</span><span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">deallocationsHuge</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SizeClass</span> <span class="n">sizeClass</span> <span class="o">=</span> <span class="n">sizeClass</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cache</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">sizeClass</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// cached so not free it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">freeChunk</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">sizeClass</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Add {@link PoolChunk} and {@code handle} to the cache if there is enough room.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns {@code true} if it fit into the cache {@code false} otherwise.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">&#34;unchecked&#34;</span><span class="o">,</span> <span class="s">&#34;rawtypes&#34;</span> <span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;?&gt;</span> <span class="n">area</span><span class="o">,</span> <span class="n">PoolChunk</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">SizeClass</span> <span class="n">sizeClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sizeIdx</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="na">size2SizeIdx</span><span class="o">(</span><span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegionCache</span><span class="o">&lt;?&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">sizeClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;?&gt;</span> <span class="n">cache</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;?&gt;</span> <span class="n">area</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">,</span> <span class="n">SizeClass</span> <span class="n">sizeClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="o">(</span><span class="n">sizeClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Normal</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cacheForNormal</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Small</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cacheForSmall</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;?&gt;</span> <span class="n">cacheForSmall</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;?&gt;</span> <span class="n">area</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">isDirect</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">(</span><span class="n">smallSubPageDirectCaches</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cache</span><span class="o">(</span><span class="n">smallSubPageHeapCaches</span><span class="o">,</span> <span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">cache</span><span class="o">(</span><span class="n">MemoryRegionCache</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">cache</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sizeIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">sizeIdx</span> <span class="o">&gt;</span> <span class="n">cache</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cache</span><span class="o">[</span><span class="n">sizeIdx</span><span class="o">];</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Add to cache if not already full.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">newEntry</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">queued</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">queued</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If it was not possible to cache the chunk, immediately recycle the entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">entry</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">queued</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;rawtypes&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Entry</span> <span class="nf">newEntry</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;?&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">RECYCLER</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">.</span><span class="na">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">.</span><span class="na">nioBuffer</span> <span class="o">=</span> <span class="n">nioBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">.</span><span class="na">normCapacity</span> <span class="o">=</span> <span class="n">normCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">freeChunk</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">SizeClass</span> <span class="n">sizeClass</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">boolean</span> <span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">destroyChunk</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We only call this if freeChunk is not called because of the PoolThreadCache finalizer as otherwise this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// may fail due lazy class-loading in for example tomcat.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">finalizer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="o">(</span><span class="n">sizeClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">Normal</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="o">++</span><span class="n">deallocationsNormal</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">Small</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="o">++</span><span class="n">deallocationsSmall</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">destroyChunk</span> <span class="o">=</span> <span class="o">!</span><span class="n">chunk</span><span class="o">.</span><span class="na">parent</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">chunk</span><span class="o">,</span> <span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">destroyChunk</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// destroyChunk not need to be called while holding the synchronized lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">destroyChunk</span><span class="o">(</span><span class="n">chunk</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">free</span><span class="o">(</span><span class="n">PoolChunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">chunk</span><span class="o">,</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">handle</span><span class="o">,</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">nioBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">chunk</span><span class="o">.</span><span class="na">freeBytes</span> <span class="o">&gt;</span> <span class="n">freeMaxThreshold</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">remove</span><span class="o">(</span><span class="n">chunk</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Move the PoolChunk down the PoolChunkList linked-list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">move0</span><span class="o">(</span><span class="n">chunk</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Free a subpage or a run of pages When a subpage is freed from PoolSubpage, it might be added back to subpage pool
</span></span></span><span class="line"><span class="cl"><span class="cm">* of the owning PoolArena. If the subpage pool in PoolArena has at least one other PoolSubpage of given elemSize,
</span></span></span><span class="line"><span class="cl"><span class="cm">* we can completely free the owning Page so it is available for subsequent allocations
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param handle handle to free
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free</span><span class="o">(</span><span class="kt">long</span> <span class="n">handle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">normCapacity</span><span class="o">,</span> <span class="n">ByteBuffer</span> <span class="n">nioBuffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">runSize</span> <span class="o">=</span> <span class="n">runSize</span><span class="o">(</span><span class="n">pageShifts</span><span class="o">,</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">isSubpage</span><span class="o">(</span><span class="n">handle</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sizeIdx</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">size2SizeIdx</span><span class="o">(</span><span class="n">normCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">findSubpagePoolHead</span><span class="o">(</span><span class="n">sizeIdx</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sIdx</span> <span class="o">=</span> <span class="n">runOffset</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PoolSubpage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">subpage</span> <span class="o">=</span> <span class="n">subpages</span><span class="o">[</span><span class="n">sIdx</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">subpage</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">subpage</span><span class="o">.</span><span class="na">doNotDestroy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This is need as we may add it back and so alter the linked-list structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">subpage</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">bitmapIdx</span><span class="o">(</span><span class="n">handle</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//the subpage is still used, do not free it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="o">!</span><span class="n">subpage</span><span class="o">.</span><span class="na">doNotDestroy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Null out slot in the array as it was freed and we should not use it anymore.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">subpages</span><span class="o">[</span><span class="n">sIdx</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">head</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//start free run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">runsAvailLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// collapse continuous runs, successfully collapsed runs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// will be removed from runsAvail and runsAvailMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">long</span> <span class="n">finalRun</span> <span class="o">=</span> <span class="n">collapseRuns</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//set run as not used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">finalRun</span> <span class="o">&amp;=</span> <span class="o">~(</span><span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">IS_USED_SHIFT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//if it is a subpage, set it to run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">finalRun</span> <span class="o">&amp;=</span> <span class="o">~(</span><span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">IS_SUBPAGE_SHIFT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">insertAvailRun</span><span class="o">(</span><span class="n">runOffset</span><span class="o">(</span><span class="n">finalRun</span><span class="o">),</span> <span class="n">runPages</span><span class="o">(</span><span class="n">finalRun</span><span class="o">),</span> <span class="n">finalRun</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">freeBytes</span> <span class="o">+=</span> <span class="n">runSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runsAvailLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nioBuffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cachedNioBuffers</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cachedNioBuffers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">PooledByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT_MAX_CACHED_BYTEBUFFERS_PER_CHUNK</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cachedNioBuffers</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">nioBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">recyclerHandle</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;object does not belong to handle&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">localPool</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="objectpool">ObjectPool</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.util.internal</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.Recycler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Light-weight object pool.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param &lt;T&gt; the type of the pooled object
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ObjectPool</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Get a {@link Object} from the {@link ObjectPool}. The returned {@link Object} may be created via
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ObjectCreator#newObject(Handle)} if no pooled {@link Object} is ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">T</span> <span class="nf">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Handle for an pooled {@link Object} that will be used to notify the {@link ObjectPool} once it can
</span></span></span><span class="line"><span class="cl"><span class="cm">     * reuse the pooled {@link Object} again.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Recycle the {@link Object} if possible and so make it ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">T</span> <span class="n">self</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new Object which references the given {@link Handle} and calls {@link Handle#recycle(Object)} once
</span></span></span><span class="line"><span class="cl"><span class="cm">     * it can be re-used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt; the type of the pooled object
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Creates an returns a new {@link Object} that can be used and later recycled via
</span></span></span><span class="line"><span class="cl"><span class="cm">         * {@link Handle#recycle(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new {@link ObjectPool} which will use the given {@link ObjectCreator} to create the {@link Object}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that should be pooled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">newPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">RecyclerObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">creator</span><span class="o">,</span> <span class="s">&#34;creator&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecyclerObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Recycler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">recycler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">RecyclerObjectPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="n">recycler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Recycler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="n">T</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">creator</span><span class="o">.</span><span class="na">newObject</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">recycler</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结-2">总结</h2>
<ol>
<li>ByteBuf的api和分类</li>
<li>分配Pooled内存的总步骤</li>
<li>不同规格的Pooled内存分配和释放</li>
</ol>
<p>三个问题：</p>
<ol>
<li>Netty的内存类型有哪些？
<ul>
<li>堆内堆外以外的类型</li>
</ul>
</li>
<li>如何减少多线程内存分配之间的竞争？
<ul>
<li>PooledByteBufAllocator，通过PoolThreadCache对象将Thread与Arena绑定，本质上就是ThreadLocal原理一致。</li>
</ul>
</li>
<li>不同大小的内存是如何进行分配的？</li>
</ol>
<blockquote>
<p>Netty为了优化内存分配，使用了对象池、缓存、双向链表、环形二叉树、位图等数据结构。</p>
</blockquote>
<h1 id="8-netty的解码逻辑">8. Netty的解码逻辑</h1>
<p>两个问题：</p>
<ol>
<li>解码器抽象的解码过程。</li>
<li>Netty里面有哪些拆箱即用的解码器？</li>
</ol>
<h2 id="基于固定长度解码器分析">基于固定长度解码器分析</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A decoder that splits the received {@link ByteBuf}s by the fixed number
</span></span></span><span class="line"><span class="cl"><span class="cm"> * of bytes. For example, if you received the following four fragmented packets:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +---+----+------+----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * | A | BC | DEFG | HI |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +---+----+------+----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A {@link FixedLengthFrameDecoder}{@code (3)} will decode them into the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * following three packets with the fixed length:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----+-----+-----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * | ABC | DEF | GHI |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----+-----+-----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">in</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">decoded</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">decoded</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a frame out of the {@link ByteBuf} and return it.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   ctx             the {@link ChannelHandlerContext} which this {@link ByteToMessageDecoder} belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   in              the {@link ByteBuf} from which to read data
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return  frame           the {@link ByteBuf} which represent the frame or {@code null} if no frame could
</span></span></span><span class="line"><span class="cl"><span class="cm">*                          be created.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">decode</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;UnusedParameters&#34;</span><span class="o">)</span> <span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">frameLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">in</span><span class="o">.</span><span class="na">readRetainedSlice</span><span class="o">(</span><span class="n">frameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基于行解码器分析">基于行解码器分析</h2>
<p><code>discarding</code>是一种丢弃模式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LineBasedFrameDecoder</span> <span class="kd">extends</span> <span class="n">ByteToMessageDecoder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** Maximum length of a frame we&#39;re willing to decode.  */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** Whether or not to throw an exception as soon as we exceed maxLength. */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** True if we&#39;re discarding input because we&#39;re already over maxLength.  */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">discarding</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">discardedBytes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** Last scan position. */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new decoder.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                   A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                   the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LineBasedFrameDecoder</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">maxLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxLength</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new decoder.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                   A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                   the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stripDelimiter  whether the decoded frame should strip out the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        delimiter or not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param failFast  If &lt;tt&gt;true&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown as soon as the decoder notices the length of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  frame will exceed &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  whether the entire frame has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  If &lt;tt&gt;false&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown after the entire frame that exceeds
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  &lt;tt&gt;maxFrameLength&lt;/tt&gt; has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LineBasedFrameDecoder</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">maxLength</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">maxLength</span> <span class="o">=</span> <span class="n">maxLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">failFast</span> <span class="o">=</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">stripDelimiter</span> <span class="o">=</span> <span class="n">stripDelimiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">in</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">decoded</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">decoded</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a frame out of the {@link ByteBuf} and return it.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   ctx             the {@link ChannelHandlerContext} which this {@link ByteToMessageDecoder} belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   buffer          the {@link ByteBuf} from which to read data
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return  frame           the {@link ByteBuf} which represent the frame or {@code null} if no frame could
</span></span></span><span class="line"><span class="cl"><span class="cm">*                          be created.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">eol</span> <span class="o">=</span> <span class="n">findEndOfLine</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">discarding</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">eol</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">frame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">eol</span> <span class="o">-</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">delimLength</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">eol</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="o">?</span> <span class="n">2</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">maxLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(</span><span class="n">eol</span> <span class="o">+</span> <span class="n">delimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">fail</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">stripDelimiter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">frame</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readRetainedSlice</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">delimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">frame</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readRetainedSlice</span><span class="o">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">delimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">frame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">maxLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">discardedBytes</span> <span class="o">=</span> <span class="n">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">discarding</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fail</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="s">&#34;over &#34;</span> <span class="o">+</span> <span class="n">discardedBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">eol</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">discardedBytes</span> <span class="o">+</span> <span class="n">eol</span> <span class="o">-</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">delimLength</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">eol</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="o">?</span> <span class="n">2</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(</span><span class="n">eol</span> <span class="o">+</span> <span class="n">delimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">discardedBytes</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">discarding</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fail</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">discardedBytes</span> <span class="o">+=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We skip everything in the buffer, we need to set the offset to 0 again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">offset</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns the index in the buffer of the end of line found.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns -1 if no end of line was found in the buffer.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="nf">findEndOfLine</span><span class="o">(</span><span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">totalLength</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">forEachByte</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">()</span> <span class="o">+</span> <span class="n">offset</span><span class="o">,</span> <span class="n">totalLength</span> <span class="o">-</span> <span class="n">offset</span><span class="o">,</span> <span class="n">ByteProcessor</span><span class="o">.</span><span class="na">FIND_LF</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">totalLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基于分隔符解码器分析">基于分隔符解码器分析</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A decoder that splits the received {@link ByteBuf}s by one or more
</span></span></span><span class="line"><span class="cl"><span class="cm"> * delimiters.  It is particularly useful for decoding the frames which ends
</span></span></span><span class="line"><span class="cl"><span class="cm"> * with a delimiter such as {@link Delimiters#nulDelimiter() NUL} or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@linkplain Delimiters#lineDelimiter() newline characters}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;h3&gt;Predefined delimiters&lt;/h3&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link Delimiters} defines frequently used delimiters for convenience&#39; sake.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;h3&gt;Specifying more than one delimiter&lt;/h3&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link DelimiterBasedFrameDecoder} allows you to specify more than one
</span></span></span><span class="line"><span class="cl"><span class="cm"> * delimiter.  If more than one delimiter is found in the buffer, it chooses
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the delimiter which produces the shortest frame.  For example, if you have
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the following data in the buffer:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +--------------+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * | ABC\nDEF\r\n |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +--------------+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a {@link DelimiterBasedFrameDecoder}({@link Delimiters#lineDelimiter() Delimiters.lineDelimiter()})
</span></span></span><span class="line"><span class="cl"><span class="cm"> * will choose {@code &#39;\n&#39;} as the first delimiter and produce two frames:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----+-----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * | ABC | DEF |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----+-----+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * rather than incorrectly choosing {@code &#39;\r\n&#39;} as the first delimiter:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +----------+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * | ABC\nDEF |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +----------+
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DelimiterBasedFrameDecoder</span> <span class="kd">extends</span> <span class="n">ByteToMessageDecoder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteBuf</span><span class="o">[]</span> <span class="n">delimiters</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">discardingTooLongFrame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">tooLongFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** Set only when decoding with &#34;\n&#34; and &#34;\r\n&#34; as the delimiter.  */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">LineBasedFrameDecoder</span> <span class="n">lineBasedDecoder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiter  the delimiter
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">delimiter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">delimiter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stripDelimiter  whether the decoded frame should strip out the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        delimiter or not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiter  the delimiter
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">delimiter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">delimiter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stripDelimiter  whether the decoded frame should strip out the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        delimiter or not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param failFast  If &lt;tt&gt;true&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown as soon as the decoder notices the length of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  frame will exceed &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  whether the entire frame has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  If &lt;tt&gt;false&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown after the entire frame that exceeds
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  &lt;tt&gt;maxFrameLength&lt;/tt&gt; has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiter  the delimiter
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteBuf</span> <span class="n">delimiter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="n">failFast</span><span class="o">,</span> <span class="k">new</span> <span class="n">ByteBuf</span><span class="o">[]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">delimiter</span><span class="o">.</span><span class="na">slice</span><span class="o">(</span><span class="n">delimiter</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(),</span> <span class="n">delimiter</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">())});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiters  the delimiters
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">ByteBuf</span><span class="o">...</span> <span class="n">delimiters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">delimiters</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stripDelimiter  whether the decoded frame should strip out the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        delimiter or not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiters  the delimiters
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="n">ByteBuf</span><span class="o">...</span> <span class="n">delimiters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">delimiters</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength  the maximum length of the decoded frame.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        A {@link TooLongFrameException} is thrown if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        the length of the frame exceeds this value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stripDelimiter  whether the decoded frame should strip out the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                        delimiter or not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param failFast  If &lt;tt&gt;true&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown as soon as the decoder notices the length of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  frame will exceed &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  whether the entire frame has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  If &lt;tt&gt;false&lt;/tt&gt;, a {@link TooLongFrameException} is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  thrown after the entire frame that exceeds
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  &lt;tt&gt;maxFrameLength&lt;/tt&gt; has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param delimiters  the delimiters
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DelimiterBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">,</span> <span class="n">ByteBuf</span><span class="o">...</span> <span class="n">delimiters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">validateMaxFrameLength</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNonEmpty</span><span class="o">(</span><span class="n">delimiters</span><span class="o">,</span> <span class="s">&#34;delimiters&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isLineBased</span><span class="o">(</span><span class="n">delimiters</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isSubclass</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lineBasedDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LineBasedFrameDecoder</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">stripDelimiter</span><span class="o">,</span> <span class="n">failFast</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">delimiters</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">delimiters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteBuf</span><span class="o">[</span><span class="n">delimiters</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delimiters</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ByteBuf</span> <span class="n">d</span> <span class="o">=</span> <span class="n">delimiters</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">validateDelimiter</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">delimiters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="na">slice</span><span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(),</span> <span class="n">d</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">lineBasedDecoder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">maxFrameLength</span> <span class="o">=</span> <span class="n">maxFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">stripDelimiter</span> <span class="o">=</span> <span class="n">stripDelimiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">failFast</span> <span class="o">=</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解码步骤：</p>
<ol>
<li>行处理器</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">in</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">decoded</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">decoded</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Create a frame out of the {@link ByteBuf} and return it.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   ctx             the {@link ChannelHandlerContext} which this {@link ByteToMessageDecoder} belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param   buffer          the {@link ByteBuf} from which to read data
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return  frame           the {@link ByteBuf} which represent the frame or {@code null} if no frame could
</span></span></span><span class="line"><span class="cl"><span class="cm">*                          be created.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">lineBasedDecoder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">lineBasedDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try all delimiters and choose the delimiter which yields the shortest frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">minFrameLength</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">minDelim</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">ByteBuf</span> <span class="n">delim</span><span class="o">:</span> <span class="n">delimiters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">frameLength</span> <span class="o">=</span> <span class="n">indexOf</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">delim</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">frameLength</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">frameLength</span> <span class="o">&lt;</span> <span class="n">minFrameLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">minFrameLength</span> <span class="o">=</span> <span class="n">frameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">minDelim</span> <span class="o">=</span> <span class="n">delim</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">minDelim</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">minDelimLength</span> <span class="o">=</span> <span class="n">minDelim</span><span class="o">.</span><span class="na">capacity</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">frame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">discardingTooLongFrame</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We&#39;ve just finished discarding a very large frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Go back to the initial state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">discardingTooLongFrame</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">minFrameLength</span> <span class="o">+</span> <span class="n">minDelimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">tooLongFrameLength</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">tooLongFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">tooLongFrameLength</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fail</span><span class="o">(</span><span class="n">tooLongFrameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">minFrameLength</span> <span class="o">&gt;</span> <span class="n">maxFrameLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Discard read frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">minFrameLength</span> <span class="o">+</span> <span class="n">minDelimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fail</span><span class="o">(</span><span class="n">minFrameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stripDelimiter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">frame</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readRetainedSlice</span><span class="o">(</span><span class="n">minFrameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">minDelimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">frame</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readRetainedSlice</span><span class="o">(</span><span class="n">minFrameLength</span> <span class="o">+</span> <span class="n">minDelimLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">frame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">discardingTooLongFrame</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">maxFrameLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Discard the content of the buffer until a delimiter is found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">tooLongFrameLength</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">discardingTooLongFrame</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fail</span><span class="o">(</span><span class="n">tooLongFrameLength</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Still discarding the buffer since a delimiter is not found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tooLongFrameLength</span> <span class="o">+=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">skipBytes</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基于长度域解码器分析">基于长度域解码器分析</h2>
<ol>
<li>lengthFieldOffset：开始的偏移量</li>
<li>lengthFieldLength：长度</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">A</span> <span class="n">decoder</span> <span class="n">that</span> <span class="n">splits</span> <span class="n">the</span> <span class="n">received</span> <span class="o">{</span><span class="nd">@link</span> <span class="n">ByteBuf</span><span class="o">}</span><span class="n">s</span> <span class="n">dynamically</span> <span class="n">by</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">in</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>  <span class="n">It</span> <span class="n">is</span> <span class="n">particularly</span> <span class="n">useful</span> <span class="n">when</span> <span class="n">you</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">decode</span> <span class="n">a</span> <span class="n">binary</span> <span class="n">message</span> <span class="n">which</span> <span class="n">has</span> <span class="n">an</span> <span class="n">integer</span> <span class="n">header</span> <span class="n">field</span> <span class="n">that</span> <span class="n">represents</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span> <span class="n">body</span> <span class="n">or</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">message</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">{</span><span class="nd">@link</span> <span class="n">LengthFieldBasedFrameDecoder</span><span class="o">}</span> <span class="n">has</span> <span class="n">many</span> <span class="n">configuration</span> <span class="n">parameters</span> <span class="n">so</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">decode</span> <span class="n">any</span> <span class="n">message</span> <span class="n">with</span> <span class="n">a</span> <span class="n">length</span> <span class="n">field</span><span class="o">,</span> <span class="n">which</span> <span class="n">is</span> <span class="n">often</span> <span class="n">seen</span> <span class="n">in</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">proprietary</span> <span class="n">client</span><span class="o">-</span><span class="n">server</span> <span class="n">protocols</span><span class="o">.</span> <span class="n">Here</span> <span class="n">are</span> <span class="n">some</span> <span class="n">example</span> <span class="n">that</span> <span class="n">will</span> <span class="n">give</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">you</span> <span class="n">the</span> <span class="n">basic</span> <span class="n">idea</span> <span class="n">on</span> <span class="n">which</span> <span class="n">option</span> <span class="n">does</span> <span class="n">what</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">2</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">0</span><span class="o">,</span> <span class="k">do</span> <span class="n">not</span> <span class="n">strip</span> <span class="n">header</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">The</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">in</span> <span class="k">this</span> <span class="n">example</span> <span class="n">is</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">12</span> <span class="o">(</span><span class="n">0x0C</span><span class="o">)&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="n">which</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="s">&#34;HELLO, WORLD&#34;</span><span class="o">.</span>  <span class="n">By</span> <span class="k">default</span><span class="o">,</span> <span class="n">the</span> <span class="n">decoder</span> <span class="n">assumes</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">that</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">the</span> <span class="n">bytes</span> <span class="n">that</span> <span class="n">follows</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">length</span> <span class="n">field</span><span class="o">.</span>  <span class="n">Therefore</span><span class="o">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">decoded</span> <span class="n">with</span> <span class="n">the</span> <span class="n">simplistic</span> <span class="n">parameter</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">combination</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthFieldOffset</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>   <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">0</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthFieldLength</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>   <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthAdjustment</span>    <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">initialBytesToStrip</span> <span class="o">=</span> <span class="n">0</span> <span class="o">(=</span> <span class="k">do</span> <span class="n">not</span> <span class="n">strip</span> <span class="n">header</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">14</span> <span class="n">bytes</span><span class="o">)</span>         <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">14</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+--------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0x000C</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="n">0x000C</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+--------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">2</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">0</span><span class="o">,</span> <span class="n">strip</span> <span class="n">header</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Because</span> <span class="n">we</span> <span class="n">can</span> <span class="n">get</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">content</span> <span class="n">by</span> <span class="n">calling</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">{</span><span class="nd">@link</span> <span class="n">ByteBuf</span><span class="err">#</span><span class="n">readableBytes</span><span class="o">()},</span> <span class="n">you</span> <span class="n">might</span> <span class="n">want</span> <span class="n">to</span> <span class="n">strip</span> <span class="n">the</span> <span class="n">length</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">field</span> <span class="n">by</span> <span class="n">specifying</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">initialBytesToStrip</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;.</span>  <span class="n">In</span> <span class="k">this</span> <span class="n">example</span><span class="o">,</span> <span class="n">we</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">specified</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;,</span> <span class="n">that</span> <span class="n">is</span> <span class="n">same</span> <span class="n">with</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span><span class="o">,</span> <span class="n">to</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">strip</span> <span class="n">the</span> <span class="n">first</span> <span class="n">two</span> <span class="n">bytes</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldOffset</span>   <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldLength</span>   <span class="o">=</span> <span class="n">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthAdjustment</span>    <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">initialBytesToStrip</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Length</span> <span class="n">field</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">14</span> <span class="n">bytes</span><span class="o">)</span>         <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">12</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0x000C</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">2</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">0</span><span class="o">,</span> <span class="k">do</span> <span class="n">not</span> <span class="n">strip</span> <span class="n">header</span><span class="o">,</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">message</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">In</span> <span class="n">most</span> <span class="n">cases</span><span class="o">,</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span> <span class="n">body</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">only</span><span class="o">,</span> <span class="n">as</span> <span class="n">shown</span> <span class="n">in</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">examples</span><span class="o">.</span>  <span class="n">However</span><span class="o">,</span> <span class="n">in</span> <span class="n">some</span> <span class="n">protocols</span><span class="o">,</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">length</span> <span class="n">field</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">message</span><span class="o">,</span> <span class="n">including</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">message</span> <span class="n">header</span><span class="o">.</span>  <span class="n">In</span> <span class="n">such</span> <span class="n">a</span> <span class="k">case</span><span class="o">,</span> <span class="n">we</span> <span class="n">specify</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;.</span>  <span class="n">Because</span> <span class="n">the</span> <span class="n">length</span> <span class="n">value</span> <span class="n">in</span> <span class="k">this</span> <span class="n">example</span> <span class="n">message</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">is</span> <span class="n">always</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">body</span> <span class="n">length</span> <span class="n">by</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;,</span> <span class="n">we</span> <span class="n">specify</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;-</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">as</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">compensation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldOffset</span>   <span class="o">=</span>  <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldLength</span>   <span class="o">=</span>  <span class="n">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>    <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;-</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Length</span> <span class="n">field</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">initialBytesToStrip</span> <span class="o">=</span>  <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">14</span> <span class="n">bytes</span><span class="o">)</span>         <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">14</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+--------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0x000E</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="n">0x000E</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+--------+----------------+</span>      <span class="o">+--------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">3</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">5</span> <span class="n">bytes</span> <span class="n">header</span><span class="o">,</span> <span class="k">do</span> <span class="n">not</span> <span class="n">strip</span> <span class="n">header</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">The</span> <span class="n">following</span> <span class="n">message</span> <span class="n">is</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">variation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">first</span> <span class="n">example</span><span class="o">.</span>  <span class="n">An</span> <span class="n">extra</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">value</span> <span class="n">is</span> <span class="n">prepended</span> <span class="n">to</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>  <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="n">is</span> <span class="n">zero</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">again</span> <span class="n">because</span> <span class="n">the</span> <span class="n">decoder</span> <span class="n">always</span> <span class="n">takes</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">prepended</span> <span class="n">data</span> <span class="n">into</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">account</span> <span class="n">during</span> <span class="n">frame</span> <span class="n">length</span> <span class="n">calculation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthFieldOffset</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>   <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">Header</span> <span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthFieldLength</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>   <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">3</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthAdjustment</span>    <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">initialBytesToStrip</span> <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">17</span> <span class="n">bytes</span><span class="o">)</span>                      <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">17</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+----------+----------+----------------+</span>      <span class="o">+----------+----------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">Header</span> <span class="n">1</span> <span class="o">|</span>  <span class="n">Length</span>  <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">Header</span> <span class="n">1</span> <span class="o">|</span>  <span class="n">Length</span>  <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span>  <span class="n">0xCAFE</span>  <span class="o">|</span> <span class="n">0x00000C</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span>  <span class="n">0xCAFE</span>  <span class="o">|</span> <span class="n">0x00000C</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+----------+----------+----------------+</span>      <span class="o">+----------+----------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">3</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">the</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">5</span> <span class="n">bytes</span> <span class="n">header</span><span class="o">,</span> <span class="k">do</span> <span class="n">not</span> <span class="n">strip</span> <span class="n">header</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">This</span> <span class="n">is</span> <span class="n">an</span> <span class="n">advanced</span> <span class="n">example</span> <span class="n">that</span> <span class="n">shows</span> <span class="n">the</span> <span class="k">case</span> <span class="n">where</span> <span class="n">there</span> <span class="n">is</span> <span class="n">an</span> <span class="n">extra</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">between</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">and</span> <span class="n">the</span> <span class="n">message</span> <span class="n">body</span><span class="o">.</span>  <span class="n">You</span> <span class="n">have</span> <span class="n">to</span> <span class="n">specify</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">positive</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="n">so</span> <span class="n">that</span> <span class="n">the</span> <span class="n">decoder</span> <span class="n">counts</span> <span class="n">the</span> <span class="n">extra</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">into</span> <span class="n">the</span> <span class="n">frame</span> <span class="n">length</span> <span class="n">calculation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldOffset</span>   <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldLength</span>   <span class="o">=</span> <span class="n">3</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>    <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">2</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">Header</span> <span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">initialBytesToStrip</span> <span class="o">=</span> <span class="n">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">17</span> <span class="n">bytes</span><span class="o">)</span>                      <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">17</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+----------+----------+----------------+</span>      <span class="o">+----------+----------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span>  <span class="n">Length</span>  <span class="o">|</span> <span class="n">Header</span> <span class="n">1</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span>  <span class="n">Length</span>  <span class="o">|</span> <span class="n">Header</span> <span class="n">1</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0x00000C</span> <span class="o">|</span>  <span class="n">0xCAFE</span>  <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="n">0x00000C</span> <span class="o">|</span>  <span class="n">0xCAFE</span>  <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+----------+----------+----------------+</span>      <span class="o">+----------+----------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">2</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">1</span> <span class="n">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">4</span> <span class="n">bytes</span> <span class="n">header</span><span class="o">,</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="n">strip</span> <span class="n">the</span> <span class="n">first</span> <span class="n">header</span> <span class="n">field</span> <span class="n">and</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">combination</span> <span class="n">of</span> <span class="n">all</span> <span class="n">the</span> <span class="n">examples</span> <span class="n">above</span><span class="o">.</span>  <span class="n">There</span> <span class="n">are</span> <span class="n">the</span> <span class="n">prepended</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">before</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">and</span> <span class="n">the</span> <span class="n">extra</span> <span class="n">header</span> <span class="n">after</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">The</span> <span class="n">prepended</span> <span class="n">header</span> <span class="n">affects</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthFieldOffset</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="n">and</span> <span class="n">the</span> <span class="n">extra</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">affects</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;.</span>  <span class="n">We</span> <span class="n">also</span> <span class="n">specified</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">initialBytesToStrip</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="n">to</span> <span class="n">strip</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">and</span> <span class="n">the</span> <span class="n">prepended</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">header</span> <span class="n">from</span> <span class="n">the</span> <span class="n">frame</span><span class="o">.</span>  <span class="n">If</span> <span class="n">you</span> <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">want</span> <span class="n">to</span> <span class="n">strip</span> <span class="n">the</span> <span class="n">prepended</span> <span class="n">header</span><span class="o">,</span> <span class="n">you</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">could</span> <span class="n">specify</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">0</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;</span> <span class="k">for</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">initialBytesToSkip</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldOffset</span>   <span class="o">=</span> <span class="n">1</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldLength</span>   <span class="o">=</span> <span class="n">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>    <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">1</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR2</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">initialBytesToStrip</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">3</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR1</span> <span class="o">+</span> <span class="n">LEN</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">16</span> <span class="n">bytes</span><span class="o">)</span>                       <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">13</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+------+--------+------+----------------+</span>      <span class="o">+------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">HDR1</span> <span class="o">|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">HDR2</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">HDR2</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0xCA</span> <span class="o">|</span> <span class="n">0x000C</span> <span class="o">|</span> <span class="n">0xFE</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="n">0xFE</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+------+--------+------+----------------+</span>      <span class="o">+------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="n">2</span> <span class="n">bytes</span> <span class="n">length</span> <span class="n">field</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">1</span> <span class="n">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">4</span> <span class="n">bytes</span> <span class="n">header</span><span class="o">,</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="n">strip</span> <span class="n">the</span> <span class="n">first</span> <span class="n">header</span> <span class="n">field</span> <span class="n">and</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span><span class="o">,</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">message</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Let</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">give</span> <span class="n">another</span> <span class="n">twist</span> <span class="n">to</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">example</span><span class="o">.</span>  <span class="n">The</span> <span class="n">only</span> <span class="n">difference</span> <span class="n">from</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">example</span> <span class="n">is</span> <span class="n">that</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">whole</span> <span class="n">message</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span> <span class="n">body</span><span class="o">,</span> <span class="n">just</span> <span class="n">like</span> <span class="n">the</span> <span class="n">third</span> <span class="n">example</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">We</span> <span class="n">have</span> <span class="n">to</span> <span class="n">count</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR1</span> <span class="n">and</span> <span class="n">Length</span> <span class="n">into</span> <span class="o">&lt;</span><span class="n">tt</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">tt</span><span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Please</span> <span class="n">note</span> <span class="n">that</span> <span class="n">we</span> <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">need</span> <span class="n">to</span> <span class="n">take</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR2</span> <span class="n">into</span> <span class="n">account</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">because</span> <span class="n">the</span> <span class="n">length</span> <span class="n">field</span> <span class="n">already</span> <span class="n">includes</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">header</span> <span class="n">length</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldOffset</span>   <span class="o">=</span>  <span class="n">1</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">lengthFieldLength</span>   <span class="o">=</span>  <span class="n">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">lengthAdjustment</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>    <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;-</span><span class="n">3</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">(=</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">HDR1</span> <span class="o">+</span> <span class="n">LEN</span><span class="o">,</span> <span class="n">negative</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">initialBytesToStrip</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span> <span class="n">3</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">BEFORE</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">16</span> <span class="n">bytes</span><span class="o">)</span>                       <span class="n">AFTER</span> <span class="nf">DECODE</span> <span class="o">(</span><span class="n">13</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+------+--------+------+----------------+</span>      <span class="o">+------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">HDR1</span> <span class="o">|</span> <span class="n">Length</span> <span class="o">|</span> <span class="n">HDR2</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|-----&gt;|</span> <span class="n">HDR2</span> <span class="o">|</span> <span class="n">Actual</span> <span class="n">Content</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">|</span> <span class="n">0xCA</span> <span class="o">|</span> <span class="n">0x0010</span> <span class="o">|</span> <span class="n">0xFE</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>      <span class="o">|</span> <span class="n">0xFE</span> <span class="o">|</span> <span class="s">&#34;HELLO, WORLD&#34;</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">+------+--------+------+----------------+</span>      <span class="o">+------+----------------+</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造方法和属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LengthFieldBasedFrameDecoder</span> <span class="kd">extends</span> <span class="n">ByteToMessageDecoder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteOrder</span> <span class="n">byteOrder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">lengthFieldOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">lengthFieldLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">lengthFieldEndOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">lengthAdjustment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">initialBytesToStrip</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">discardingTooLongFrame</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">tooLongFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">bytesToDiscard</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">frameLengthInt</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the maximum length of the frame.  If the length of the frame is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        greater than this value, {@link TooLongFrameException} will be
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldOffset
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the offset of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the length of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="n">lengthFieldLength</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the maximum length of the frame.  If the length of the frame is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        greater than this value, {@link TooLongFrameException} will be
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldOffset
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the offset of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the length of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthAdjustment
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the compensation value to add to the value of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param initialBytesToStrip
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the number of first bytes to strip out from the decoded frame
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">lengthAdjustment</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialBytesToStrip</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">maxFrameLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="n">lengthFieldLength</span><span class="o">,</span> <span class="n">lengthAdjustment</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">initialBytesToStrip</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the maximum length of the frame.  If the length of the frame is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        greater than this value, {@link TooLongFrameException} will be
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldOffset
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the offset of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the length of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthAdjustment
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the compensation value to add to the value of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param initialBytesToStrip
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the number of first bytes to strip out from the decoded frame
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param failFast
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        If &lt;tt&gt;true&lt;/tt&gt;, a {@link TooLongFrameException} is thrown as
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        soon as the decoder notices the length of the frame will exceed
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of whether the entire frame
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        has been read.  If &lt;tt&gt;false&lt;/tt&gt;, a {@link TooLongFrameException}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        is thrown after the entire frame that exceeds &lt;tt&gt;maxFrameLength&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">lengthAdjustment</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialBytesToStrip</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">ByteOrder</span><span class="o">.</span><span class="na">BIG_ENDIAN</span><span class="o">,</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="n">lengthFieldLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">lengthAdjustment</span><span class="o">,</span> <span class="n">initialBytesToStrip</span><span class="o">,</span> <span class="n">failFast</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param byteOrder
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the {@link ByteOrder} of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxFrameLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the maximum length of the frame.  If the length of the frame is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        greater than this value, {@link TooLongFrameException} will be
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldOffset
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the offset of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthFieldLength
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the length of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param lengthAdjustment
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the compensation value to add to the value of the length field
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param initialBytesToStrip
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the number of first bytes to strip out from the decoded frame
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param failFast
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        If &lt;tt&gt;true&lt;/tt&gt;, a {@link TooLongFrameException} is thrown as
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        soon as the decoder notices the length of the frame will exceed
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of whether the entire frame
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        has been read.  If &lt;tt&gt;false&lt;/tt&gt;, a {@link TooLongFrameException}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        is thrown after the entire frame that exceeds &lt;tt&gt;maxFrameLength&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        has been read.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteOrder</span> <span class="n">byteOrder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxFrameLength</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lengthFieldLength</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">lengthAdjustment</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialBytesToStrip</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">failFast</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">byteOrder</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">byteOrder</span><span class="o">,</span> <span class="s">&#34;byteOrder&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">checkPositive</span><span class="o">(</span><span class="n">maxFrameLength</span><span class="o">,</span> <span class="s">&#34;maxFrameLength&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">lengthFieldOffset</span><span class="o">,</span> <span class="s">&#34;lengthFieldOffset&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">initialBytesToStrip</span><span class="o">,</span> <span class="s">&#34;initialBytesToStrip&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">lengthFieldOffset</span> <span class="o">&gt;</span> <span class="n">maxFrameLength</span> <span class="o">-</span> <span class="n">lengthFieldLength</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;maxFrameLength (&#34;</span> <span class="o">+</span> <span class="n">maxFrameLength</span> <span class="o">+</span> <span class="s">&#34;) &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;must be equal to or greater than &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;lengthFieldOffset (&#34;</span> <span class="o">+</span> <span class="n">lengthFieldOffset</span> <span class="o">+</span> <span class="s">&#34;) + &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;lengthFieldLength (&#34;</span> <span class="o">+</span> <span class="n">lengthFieldLength</span> <span class="o">+</span> <span class="s">&#34;).&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">maxFrameLength</span> <span class="o">=</span> <span class="n">maxFrameLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">lengthFieldOffset</span> <span class="o">=</span> <span class="n">lengthFieldOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">lengthFieldLength</span> <span class="o">=</span> <span class="n">lengthFieldLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">lengthAdjustment</span> <span class="o">=</span> <span class="n">lengthAdjustment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">lengthFieldEndOffset</span> <span class="o">=</span> <span class="n">lengthFieldOffset</span> <span class="o">+</span> <span class="n">lengthFieldLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">initialBytesToStrip</span> <span class="o">=</span> <span class="n">initialBytesToStrip</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">failFast</span> <span class="o">=</span> <span class="n">failFast</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结-3">总结</h2>
<p>两个问题：</p>
<ol>
<li>解码器抽象的解码过程。
<ul>
<li>ByteToMessageDecoder解码步骤
<ul>
<li>累加字节流</li>
<li>调用子类的decode方法进行解析，累加的字节、list
<ul>
<li><code>protected abstract void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception;</code></li>
</ul>
</li>
<li>将解析到的ByteBuf向下传播</li>
</ul>
</li>
</ul>
</li>
<li>Netty里面有哪些拆箱即用的解码器？
<ul>
<li>FixedLengthFrameDecoder</li>
<li>DelimiterBasedFrameDecoder</li>
<li>LineBasedFrameDecoder</li>
<li>LengthFieldBasedFrameDecoder</li>
</ul>
</li>
</ol>
<h1 id="9-netty的编码逻辑">9. Netty的编码逻辑</h1>
<ul>
<li>如何把对象变成字节流，最终写到Socket底层？
<ul>
<li>writeAndFlush()，大体步骤：
<ul>
<li>Head &lt;-&gt; encoder &lt;-&gt; &hellip; &lt;-&gt; biz(wreiteAndFlush(user)) &lt;-&gt; Tail</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Encode a message into a {@link ByteBuf}. This method will be called for each written message that can be handled
</span></span></span><span class="line"><span class="cl"><span class="cm">* by this encoder.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param ctx           the {@link ChannelHandlerContext} which this {@link MessageToByteEncoder} belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param msg           the message to encode
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param out           the {@link ByteBuf} into which the encoded message will be written
</span></span></span><span class="line"><span class="cl"><span class="cm">* @throws Exception    is thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">I</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="writeandflush">writeAndFlush</h2>
<ul>
<li>从tail节点开始往前传播</li>
<li>逐个调用channelHandler的write方法</li>
<li>逐个调用channelHandler的flush方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">newPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flush</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isNotValidPromise</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">(</span><span class="n">flush</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">MASK_WRITE</span> <span class="o">|</span> <span class="n">MASK_FLUSH</span><span class="o">)</span> <span class="o">:</span> <span class="n">MASK_WRITE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeWriteAndFlush</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeWrite</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">WriteTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">WriteTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">flush</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="o">!</span><span class="n">flush</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// We failed to submit the WriteTask. We need to cancel it so we decrement the pending bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// and put it back in the Recycler for re-use later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// See https://github.com/netty/netty/issues/8343.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">safeExecute</span><span class="o">(</span><span class="n">EventExecutor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">runnable</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">lazy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">lazy</span> <span class="o">&amp;&amp;</span> <span class="n">executor</span> <span class="k">instanceof</span> <span class="n">AbstractEventExecutor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">((</span><span class="n">AbstractEventExecutor</span><span class="o">)</span> <span class="n">executor</span><span class="o">).</span><span class="na">lazyExecute</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">invokeWriteAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeWrite0</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeFlush0</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">invokeWrite</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeWrite0</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeWrite0</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelOutboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">write</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyOutboundHandlerException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">acceptOutboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">cast</span> <span class="o">=</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">preferDirect</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">encode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">cast</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EncoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">EncoderException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeFlush0</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelOutboundHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">()).</span><span class="na">flush</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invokeExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="编码器处理逻辑messgetobyteencoder">编码器处理逻辑：MessgeToByteEncoder</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ChannelOutboundHandlerAdapter} which encodes message in a stream-like fashion from one message to an
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Example implementation which encodes {@link Integer}s to a {@link ByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     public class IntegerEncoder extends {@link MessageToByteEncoder}&amp;lt;{@link Integer}&amp;gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm"> *         {@code @Override}
</span></span></span><span class="line"><span class="cl"><span class="cm"> *         public void encode({@link ChannelHandlerContext} ctx, {@link Integer} msg, {@link ByteBuf} out)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *                 throws {@link Exception} {
</span></span></span><span class="line"><span class="cl"><span class="cm"> *             out.writeInt(msg);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *         }
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     }
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">MessageToByteEncoder</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ChannelOutboundHandlerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TypeParameterMatcher</span> <span class="n">matcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">preferDirect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #MessageToByteEncoder(boolean)} with {@code true} as boolean parameter.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">MessageToByteEncoder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #MessageToByteEncoder(Class, boolean)} with {@code true} as boolean value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">MessageToByteEncoder</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">outboundMessageType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">outboundMessageType</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance which will try to detect the types to match out of the type parameter of the class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param preferDirect          {@code true} if a direct {@link ByteBuf} should be tried to be used as target for
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              the encoded messages. If {@code false} is used it will allocate a heap
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              {@link ByteBuf}, which is backed by an byte array.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">MessageToByteEncoder</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">preferDirect</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">MessageToByteEncoder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;I&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">preferDirect</span> <span class="o">=</span> <span class="n">preferDirect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param outboundMessageType   The type of messages to match
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param preferDirect          {@code true} if a direct {@link ByteBuf} should be tried to be used as target for
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              the encoded messages. If {@code false} is used it will allocate a heap
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              {@link ByteBuf}, which is backed by an byte array.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">MessageToByteEncoder</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">outboundMessageType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">preferDirect</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">outboundMessageType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">preferDirect</span> <span class="o">=</span> <span class="n">preferDirect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>匹配对象，能处理自己来处理，否则仍会前一个处理器</li>
<li>内存分配，在ByteBuffer中申请空间</li>
<li>编码试下，覆盖encode方法，可以实现自定义的编码协议</li>
<li>释放对象，转换前的ByteBuffer可以释放，节省内存，不需要在encode中释放对象</li>
<li>传播数据，此处数据为二进制数据</li>
<li>释放内存，出现异常等情况需要释放内存</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">acceptOutboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">cast</span> <span class="o">=</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">preferDirect</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">encode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">cast</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EncoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">EncoderException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if the given message should be handled. If {@code false} it will be passed to the next
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelOutboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">acceptOutboundMessage</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">matcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">match</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReflectiveMatcher</span> <span class="kd">extends</span> <span class="n">TypeParameterMatcher</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ReflectiveMatcher</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">match</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认分配堆外内存。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Allocate a {@link ByteBuf} which will be used as argument of {@link #encode(ChannelHandlerContext, I, ByteBuf)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sub-classes may override this method to return {@link ByteBuf} with a perfect matching {@code initialCapacity}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">allocateBuffer</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unused&#34;</span><span class="o">)</span> <span class="n">I</span> <span class="n">msg</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                               <span class="kt">boolean</span> <span class="n">preferDirect</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">preferDirect</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">ioBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">heapBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Try to call {@link ReferenceCounted#release()} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">((</span><span class="n">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Try to call {@link ReferenceCounted#release(int)} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">decrement</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkPositive</span><span class="o">(</span><span class="n">decrement</span><span class="o">,</span> <span class="s">&#34;decrement&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">((</span><span class="n">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">(</span><span class="n">decrement</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Try to call {@link ReferenceCounted#release()} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Unlike {@link #release(Object)} this method catches an exception raised by {@link ReferenceCounted#release()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and logs it, rather than rethrowing it to the caller.  It is usually recommended to use {@link #release(Object)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * instead, unless you absolutely need to swallow an exception.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">safeRelease</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to release a message: {}&#34;</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Try to call {@link ReferenceCounted#release(int)} if the specified message implements {@link ReferenceCounted}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the specified message doesn&#39;t implement {@link ReferenceCounted}, this method does nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Unlike {@link #release(Object)} this method catches an exception raised by {@link ReferenceCounted#release(int)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and logs it, rather than rethrowing it to the caller.  It is usually recommended to use
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link #release(Object, int)} instead, unless you absolutely need to swallow an exception.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">safeRelease</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">decrement</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkPositive</span><span class="o">(</span><span class="n">decrement</span><span class="o">,</span> <span class="s">&#34;decrement&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">release</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">decrement</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to release a message: {} (decrement: {})&#34;</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">decrement</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Request to write a message via this {@link ChannelHandlerContext} through the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This method will not request to actual flush, so be sure to call {@link #flush()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * once you want to request to flush all pending data to the actual transport.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="写buffer队列">写Buffer队列</h2>
<ol>
<li>direct化bytebuf，堆内存调整为堆外内存。</li>
<li>插入写队列</li>
<li>设置写状态</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">acceptOutboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">cast</span> <span class="o">=</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">preferDirect</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">encode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">cast</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EncoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">EncoderException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flush</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isNotValidPromise</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">(</span><span class="n">flush</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">MASK_WRITE</span> <span class="o">|</span> <span class="n">MASK_FLUSH</span><span class="o">)</span> <span class="o">:</span> <span class="n">MASK_WRITE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeWriteAndFlush</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeWrite</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">WriteTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">WriteTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">flush</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="o">!</span><span class="n">flush</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// We failed to submit the WriteTask. We need to cancel it so we decrement the pending bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// and put it back in the Recycler for re-use later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// See https://github.com/netty/netty/issues/8343.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundBuffer</span> <span class="n">outboundBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">outboundBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">outboundBuffer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// release message now to prevent resource-leak
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If the outboundBuffer is null we know the channel was closed and so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// need to fail the future right away. If it is not null the handling of the rest
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// will be done in flush0()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/2362
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClosedChannelException</span><span class="o">(</span><span class="n">initialCloseCause</span><span class="o">,</span> <span class="s">&#34;write(Object, ChannelPromise)&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="n">filterOutboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">estimatorHandle</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">outboundBuffer</span><span class="o">.</span><span class="na">addMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">filterOutboundMessage</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ByteBuf</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isDirect</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">newDirectBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">FileRegion</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;unsupported message type: &#34;</span> <span class="o">+</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">simpleClassName</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">+</span> <span class="n">EXPECTED_TYPES</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns an off-heap copy of the specified {@link ByteBuf}, and releases the original one.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Note that this method does not create an off-heap copy if the allocation / deallocation cost is too high,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * but just returns the original {@link ByteBuf}..
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">readableBytes</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">readableBytes</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">safeRelease</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ByteBufAllocator</span> <span class="n">alloc</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">alloc</span><span class="o">.</span><span class="na">isDirectBufferPooled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteBuf</span> <span class="n">directBuf</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="n">readableBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">directBuf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(),</span> <span class="n">readableBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">safeRelease</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">directBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">directBuf</span> <span class="o">=</span> <span class="n">ByteBufUtil</span><span class="o">.</span><span class="na">threadLocalDirectBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">directBuf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">directBuf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(),</span> <span class="n">readableBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">safeRelease</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">directBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocating and deallocating an unpooled direct buffer is very expensive; give up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="c1">// Entry(flushedEntry) --&gt; ... Entry(unflushedEntry) --&gt; ... Entry(tailEntry)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The Entry that is the first in the linked-list structure that was flushed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Entry</span> <span class="n">flushedEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The Entry which is the first unflushed in the linked-list structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Entry</span> <span class="n">unflushedEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The Entry which represents the tail of the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Entry</span> <span class="n">tailEntry</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Add given message to this {@link ChannelOutboundBuffer}. The given {@link ChannelPromise} will be notified once
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the message was written.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addMessage</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">total</span><span class="o">(</span><span class="n">msg</span><span class="o">),</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tailEntry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">flushedEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Entry</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">tailEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">tail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">tailEntry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">unflushedEntry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unflushedEntry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// increment pending bytes after adding message to the unflushed arrays.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/1619
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">incrementPendingOutboundBytes</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">pendingSize</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">RECYCLER</span> <span class="o">=</span> <span class="n">ObjectPool</span><span class="o">.</span><span class="na">newPool</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Entry</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span><span class="o">[]</span> <span class="n">bufs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">progress</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">total</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pendingSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">cancelled</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Entry</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Entry</span> <span class="nf">newInstance</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">long</span> <span class="n">total</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">RECYCLER</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">pendingSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">total</span> <span class="o">=</span> <span class="n">total</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">.</span><span class="na">promise</span> <span class="o">=</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">cancelled</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">pSize</span> <span class="o">=</span> <span class="n">pendingSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// release message and replace with an empty buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">safeRelease</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">pendingSize</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">total</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">bufs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recycle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">promise</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">total</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pendingSize</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cancelled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">handle</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span> <span class="nf">recycleAndGetNext</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">next</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">incrementPendingOutboundBytes</span><span class="o">(</span><span class="kt">long</span> <span class="n">size</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">newWriteBufferSize</span> <span class="o">=</span> <span class="n">TOTAL_PENDING_SIZE_UPDATER</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">newWriteBufferSize</span> <span class="o">&gt;</span> <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">getWriteBufferHighWaterMark</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setUnwritable</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicLongFieldUpdater</span><span class="o">&lt;</span><span class="n">ChannelOutboundBuffer</span><span class="o">&gt;</span> <span class="n">TOTAL_PENDING_SIZE_UPDATER</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">AtomicLongFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">ChannelOutboundBuffer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;totalPendingSize&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the high water mark of the write buffer.  If the number of bytes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * queued in the write buffer exceeds this value, {@link Channel#isWritable()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will start to return {@code false}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">getWriteBufferHighWaterMark</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_LOW_WATER_MARK</span> <span class="o">=</span> <span class="n">32</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_HIGH_WATER_MARK</span> <span class="o">=</span> <span class="n">64</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">WriteBufferWaterMark</span> <span class="n">DEFAULT</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">WriteBufferWaterMark</span><span class="o">(</span><span class="n">DEFAULT_LOW_WATER_MARK</span><span class="o">,</span> <span class="n">DEFAULT_HIGH_WATER_MARK</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setUnwritable</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">unwritable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">oldValue</span> <span class="o">|</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">UNWRITABLE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">,</span> <span class="n">newValue</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">oldValue</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fireChannelWritabilityChanged</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">fireChannelWritabilityChangedTask</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fireChannelWritabilityChangedTask</span> <span class="o">=</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">};</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="刷新buffer队列">刷新buffer队列</h2>
<ol>
<li>添加刷新标志并设置写状态</li>
<li>遍历buffer队列，过滤Bytebu</li>
<li>调用JDK底层api自旋写数据</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundBuffer</span> <span class="n">outboundBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">outboundBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">outboundBuffer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">outboundBuffer</span><span class="o">.</span><span class="na">addFlush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">flush0</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Add a flush to this {@link ChannelOutboundBuffer}. This means all previous added messages are marked as flushed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and so you will be able to handle them.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFlush</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There is no need to process all entries if there was already a flush before and no new messages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// where added in the meantime.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See https://github.com/netty/netty/issues/2577
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">unflushedEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">flushedEntry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// there is no flushedEntry yet, so start with the entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">flushedEntry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">flushed</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Was cancelled so make sure we free up memory and notify about the freed bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">decrementPendingOutboundBytes</span><span class="o">(</span><span class="n">pending</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// All flushed so reset unflushedEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">unflushedEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">decrementPendingOutboundBytes</span><span class="o">(</span><span class="kt">long</span> <span class="n">size</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">notifyWritability</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">newWriteBufferSize</span> <span class="o">=</span> <span class="n">TOTAL_PENDING_SIZE_UPDATER</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">-</span><span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">notifyWritability</span> <span class="o">&amp;&amp;</span> <span class="n">newWriteBufferSize</span> <span class="o">&lt;</span> <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">getWriteBufferLowWaterMark</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setWritable</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">flush0</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">inFlush0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Avoid re-entrance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">ChannelOutboundBuffer</span> <span class="n">outboundBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">outboundBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">outboundBuffer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">outboundBuffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">inFlush0</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Mark all pending write requests as failure if the channel is inactive.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Check if we need to generate the exception at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(!</span><span class="n">outboundBuffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">isOpen</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">outboundBuffer</span><span class="o">.</span><span class="na">failFlushed</span><span class="o">(</span><span class="k">new</span> <span class="n">NotYetConnectedException</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// Do not trigger channelWritabilityChanged because the channel is closed already.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">outboundBuffer</span><span class="o">.</span><span class="na">failFlushed</span><span class="o">(</span><span class="n">newClosedChannelException</span><span class="o">(</span><span class="n">initialCloseCause</span><span class="o">,</span> <span class="s">&#34;flush0()&#34;</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">inFlush0</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">doWrite</span><span class="o">(</span><span class="n">outboundBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handleWriteError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">inFlush0</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doWrite</span><span class="o">(</span><span class="n">ChannelOutboundBuffer</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">writeSpinCount</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getWriteSpinCount</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Wrote all messages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">clearOpWrite</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Directly return here so incompleteWrite(...) is not called.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeSpinCount</span> <span class="o">-=</span> <span class="n">doWriteInternal</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">writeSpinCount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">incompleteWrite</span><span class="o">(</span><span class="n">writeSpinCount</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">doWriteInternal</span><span class="o">(</span><span class="n">ChannelOutboundBuffer</span> <span class="n">in</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ByteBuf</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">in</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">localFlushedAmount</span> <span class="o">=</span> <span class="n">doWriteBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">localFlushedAmount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">in</span><span class="o">.</span><span class="na">progress</span><span class="o">(</span><span class="n">localFlushedAmount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">in</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">FileRegion</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileRegion</span> <span class="n">region</span> <span class="o">=</span> <span class="o">(</span><span class="n">FileRegion</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">region</span><span class="o">.</span><span class="na">transferred</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">region</span><span class="o">.</span><span class="na">count</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">in</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">localFlushedAmount</span> <span class="o">=</span> <span class="n">doWriteFileRegion</span><span class="o">(</span><span class="n">region</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">localFlushedAmount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">in</span><span class="o">.</span><span class="na">progress</span><span class="o">(</span><span class="n">localFlushedAmount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">region</span><span class="o">.</span><span class="na">transferred</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">region</span><span class="o">.</span><span class="na">count</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">in</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Should not reach here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">WRITE_STATUS_SNDBUF_FULL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the current message to write or {@code null} if nothing was flushed before and so is ready to be written.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">current</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">flushedEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the maximum loop count for a write operation until
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link WritableByteChannel#write(ByteBuffer)} returns a non-zero value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * It is similar to what a spin lock is used for in concurrency programming.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * It improves memory utilization and write throughput depending on
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the platform that JVM runs on.  The default value is {@code 16}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">getWriteSpinCount</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doWriteBytes</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedWrittenBytes</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">javaChannel</span><span class="o">(),</span> <span class="n">expectedWrittenBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">readBytes</span><span class="o">(</span><span class="n">GatheringByteChannel</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkReadableBytes</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readBytes</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">_internalNioBuffer</span><span class="o">(</span><span class="n">readerIndex</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">readerIndex</span> <span class="o">+=</span> <span class="n">readBytes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">readBytes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ByteBuffer</span> <span class="nf">_internalNioBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">duplicate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">duplicate</span> <span class="o">?</span> <span class="n">newInternalNioBuffer</span><span class="o">(</span><span class="n">memory</span><span class="o">)</span> <span class="o">:</span> <span class="n">internalNioBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">length</span><span class="o">).</span><span class="na">position</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">getBytes</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">getBytes</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getBytes</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">internal</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkIndex</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBufUtil</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">alloc</span><span class="o">(),</span> <span class="n">internal</span> <span class="o">?</span> <span class="n">internalNioBuffer</span><span class="o">()</span> <span class="o">:</span> <span class="n">memory</span><span class="o">.</span><span class="na">duplicate</span><span class="o">(),</span> <span class="n">idx</span><span class="o">(</span><span class="n">index</span><span class="o">),</span> <span class="n">length</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">readBytes</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkReadableBytes</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">getBytes</span><span class="o">(</span><span class="n">readerIndex</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">readerIndex</span> <span class="o">+=</span> <span class="n">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Will remove the current message, mark its {@link ChannelPromise} as success and return {@code true}. If no
</span></span></span><span class="line"><span class="cl"><span class="cm">     * flushed message exists at the time this method is called it will return {@code false} to signal that no more
</span></span></span><span class="line"><span class="cl"><span class="cm">     * messages are ready to be handled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">flushedEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clearNioBuffers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">pendingSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">removeEntry</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">cancelled</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// only release message, notify and decrement if it was not canceled before.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">safeRelease</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">safeSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">decrementPendingOutboundBytes</span><span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// recycle the entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">e</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="c1">// Clear all ByteBuffer from the array so these can be GC&#39;ed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// See https://github.com/netty/netty/issues/3837
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">clearNioBuffers</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nioBufferCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">nioBufferCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">NIO_BUFFERS</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">0</span><span class="o">,</span> <span class="n">count</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeEntry</span><span class="o">(</span><span class="n">Entry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(--</span> <span class="n">flushed</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// processed everything
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">flushedEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">tailEntry</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tailEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">unflushedEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">flushedEntry</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="10-netty性能优化工具类">10. Netty性能优化工具类</h1>
<ol>
<li>FastThreadLocal，重新实现了ThreadLocal。</li>
<li>Recycler，实现了对象池的机制。</li>
</ol>
<h2 id="fastthreadlocal">FastThreadLocal</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.util.concurrent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.InternalThreadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.PlatformDependent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.IdentityHashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A special variant of {@link ThreadLocal} that yields higher access performance when accessed from a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link FastThreadLocalThread}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Internally, a {@link FastThreadLocal} uses a constant index in an array, instead of using hash code and hash table,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * to look for a variable.  Although seemingly very subtle, it yields slight performance advantage over using a hash
</span></span></span><span class="line"><span class="cl"><span class="cm"> * table, and it is useful when accessed frequently.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * To take advantage of this thread-local variable, your thread must be a {@link FastThreadLocalThread} or its subtype.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * By default, all threads created by {@link DefaultThreadFactory} are {@link FastThreadLocalThread} due to this reason.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Note that the fast path is only possible on threads that extend {@link FastThreadLocalThread}, because it requires
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a special field to store the necessary state.  An access by any other kind of thread falls back to a regular
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ThreadLocal}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param &lt;V&gt; the type of the thread-local variable
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @see ThreadLocal
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FastThreadLocal</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">variablesToRemoveIndex</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">nextVariableIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes all {@link FastThreadLocal} variables bound to the current thread.  This operation is useful when you
</span></span></span><span class="line"><span class="cl"><span class="cm">     * are in a container environment, and you don&#39;t want to leave the thread local variables in the threads you do not
</span></span></span><span class="line"><span class="cl"><span class="cm">     * manage.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removeAll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">variablesToRemoveIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">variablesToRemove</span> <span class="o">=</span> <span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;[]</span> <span class="n">variablesToRemoveArray</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                        <span class="n">variablesToRemove</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">FastThreadLocal</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">tlv</span><span class="o">:</span> <span class="n">variablesToRemoveArray</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tlv</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the number of thread local variables bound to the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Destroys the data structure that keeps all {@link FastThreadLocal} variables accessed from
</span></span></span><span class="line"><span class="cl"><span class="cm">     * non-{@link FastThreadLocalThread}s.  This operation is useful when you are in a container environment, and you
</span></span></span><span class="line"><span class="cl"><span class="cm">     * do not want to leave the thread local variables in the threads you do not manage.  Call this method when your
</span></span></span><span class="line"><span class="cl"><span class="cm">     * application is being unloaded from the container.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addToVariablesToRemove</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">variable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">variablesToRemoveIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">variablesToRemove</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span> <span class="o">||</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">variablesToRemove</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">newSetFromMap</span><span class="o">(</span><span class="k">new</span> <span class="n">IdentityHashMap</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">setIndexedVariable</span><span class="o">(</span><span class="n">variablesToRemoveIndex</span><span class="o">,</span> <span class="n">variablesToRemove</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">variablesToRemove</span> <span class="o">=</span> <span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">variablesToRemove</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">variable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removeFromVariablesToRemove</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">variable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">variablesToRemoveIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span> <span class="o">||</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">variablesToRemove</span> <span class="o">=</span> <span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">FastThreadLocal</span><span class="o">&lt;?&gt;&gt;)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">variablesToRemove</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">variable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">nextVariableIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the current value for the current thread
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">V</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">initialize</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the current value for the current thread if it exists, {@code null} otherwise.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">V</span> <span class="nf">getIfExists</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">(</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the current value for the specified thread local map.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">V</span> <span class="nf">get</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">initialize</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">V</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">V</span> <span class="n">v</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">initialValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">setIndexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addToVariablesToRemove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the value for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">setKnownNotUnset</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the value for the specified thread local map. The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setKnownNotUnset</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see InternalThreadLocalMap#setIndexedVariable(int, Object).
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setKnownNotUnset</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span><span class="o">.</span><span class="na">setIndexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">addToVariablesToRemove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if and only if this thread-local variable is set.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isSet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">isSet</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if and only if this thread-local variable is set.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isSet</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadLocalMap</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">isIndexedVariableSet</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the value to uninitialized for the specified thread local map.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this, any subsequent call to get() will trigger a new call to initialValue().
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">remove</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the value to uninitialized for the specified thread local map.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this, any subsequent call to get() will trigger a new call to initialValue().
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">removeIndexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">removeFromVariablesToRemove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">onRemoval</span><span class="o">((</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the initial value for this thread-local variable.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">V</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoked when this thread local variable is removed by {@link #remove()}. Be aware that {@link #remove()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is not guaranteed to be called when the `Thread` completes which means you can not depend on this for
</span></span></span><span class="line"><span class="cl"><span class="cm">     * cleanup of the resources in the case of `Thread` completion.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRemoval</span><span class="o">(</span><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;UnusedParameters&#34;</span><span class="o">)</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolThreadLocalCache</span> <span class="kd">extends</span> <span class="n">FastThreadLocal</span><span class="o">&lt;</span><span class="n">PoolThreadCache</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">useCacheForAllThreads</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PoolThreadLocalCache</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">useCacheForAllThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">useCacheForAllThreads</span> <span class="o">=</span> <span class="n">useCacheForAllThreads</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">PoolThreadCache</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">heapArenas</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">directArenas</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadExecutorMap</span><span class="o">.</span><span class="na">currentExecutor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">useCacheForAllThreads</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// If the current thread is a FastThreadLocalThread we will always use the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">current</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// The Thread is used by an EventExecutor, let&#39;s use the cache as the chances are good that we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// will allocate a lot!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="n">PoolThreadCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolThreadCache</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">heapArena</span><span class="o">,</span> <span class="n">directArena</span><span class="o">,</span> <span class="n">smallCacheSize</span><span class="o">,</span> <span class="n">normalCacheSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">DEFAULT_MAX_CACHED_BUFFER_CAPACITY</span><span class="o">,</span> <span class="n">DEFAULT_CACHE_TRIM_INTERVAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">executor</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="n">trimTask</span><span class="o">,</span> <span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">DEFAULT_CACHE_TRIM_INTERVAL_MILLIS</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// No caching so just use 0 as sizes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">PoolThreadCache</span><span class="o">(</span><span class="n">heapArena</span><span class="o">,</span> <span class="n">directArena</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRemoval</span><span class="o">(</span><span class="n">PoolThreadCache</span> <span class="n">threadCache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadCache</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">leastUsedArena</span><span class="o">(</span><span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">arenas</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">arenas</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">arenas</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">minArena</span> <span class="o">=</span> <span class="n">arenas</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//optimized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//If it is the first execution, directly return minarena and reduce the number of for loop comparisons below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">minArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">CACHE_NOT_USED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">minArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arenas</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arena</span> <span class="o">=</span> <span class="n">arenas</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">arena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">minArena</span><span class="o">.</span><span class="na">numThreadCaches</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">minArena</span> <span class="o">=</span> <span class="n">arena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">minArena</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The internal data structure that stores the thread-local variables for Netty and all {@link FastThreadLocal}s.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Note that this class is for internal use only and is subject to change at any time.  Use {@link FastThreadLocal}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * unless you know what you are doing.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InternalThreadLocalMap</span> <span class="kd">extends</span> <span class="n">UnpaddedInternalThreadLocalMap</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">InternalLogger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">InternalLoggerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">InternalThreadLocalMap</span><span class="o">&gt;</span> <span class="n">slowThreadLocalMap</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">InternalThreadLocalMap</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">nextIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_ARRAY_LIST_INITIAL_CAPACITY</span> <span class="o">=</span> <span class="n">8</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ARRAY_LIST_CAPACITY_EXPAND_THRESHOLD</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">30</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reference: https://hg.openjdk.java.net/jdk8/jdk8/jdk/file/tip/src/share/classes/java/util/ArrayList.java#l229
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">8</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STRING_BUILDER_INITIAL_SIZE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STRING_BUILDER_MAX_SIZE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HANDLER_SHARABLE_CACHE_INITIAL_CAPACITY</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">INDEXED_VARIABLE_TABLE_INITIAL_SIZE</span> <span class="o">=</span> <span class="n">32</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">UNSET</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** Used by {@link FastThreadLocal} */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Core thread-locals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">futureListenerStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">localChannelReaderStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">handlerSharableCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IntegerHolder</span> <span class="n">counterHashCode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ThreadLocalRandom</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;</span> <span class="n">typeParameterMatcherGetCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;&gt;</span> <span class="n">typeParameterMatcherFindCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// String-related thread-locals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">StringBuilder</span> <span class="n">stringBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetEncoder</span><span class="o">&gt;</span> <span class="n">charsetEncoderCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetDecoder</span><span class="o">&gt;</span> <span class="n">charsetDecoderCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ArrayList-related thread-locals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">arrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BitSet</span> <span class="n">cleanerFlags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** @deprecated These padding fields will be removed in the future. */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="n">rp1</span><span class="o">,</span> <span class="n">rp2</span><span class="o">,</span> <span class="n">rp3</span><span class="o">,</span> <span class="n">rp4</span><span class="o">,</span> <span class="n">rp5</span><span class="o">,</span> <span class="n">rp6</span><span class="o">,</span> <span class="n">rp7</span><span class="o">,</span> <span class="n">rp8</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">STRING_BUILDER_INITIAL_SIZE</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.threadLocalMap.stringBuilder.initialSize&#34;</span><span class="o">,</span> <span class="n">1024</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.threadLocalMap.stringBuilder.initialSize: {}&#34;</span><span class="o">,</span> <span class="n">STRING_BUILDER_INITIAL_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">STRING_BUILDER_MAX_SIZE</span> <span class="o">=</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.threadLocalMap.stringBuilder.maxSize&#34;</span><span class="o">,</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">4</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.threadLocalMap.stringBuilder.maxSize: {}&#34;</span><span class="o">,</span> <span class="n">STRING_BUILDER_MAX_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">getIfSet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">((</span><span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="n">thread</span><span class="o">).</span><span class="na">threadLocalMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">fastGet</span><span class="o">((</span><span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="n">thread</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">slowGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">fastGet</span><span class="o">(</span><span class="n">FastThreadLocalThread</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">threadLocalMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="o">.</span><span class="na">setThreadLocalMap</span><span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternalThreadLocalMap</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">slowGet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternalThreadLocalMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ret</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="n">thread</span><span class="o">).</span><span class="na">setThreadLocalMap</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">nextVariableIndex</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">nextIndex</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;too many thread-local indexed variables&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">lastVariableIndex</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">nextIndex</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">InternalThreadLocalMap</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">indexedVariables</span> <span class="o">=</span> <span class="n">newIndexedVariableTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">newIndexedVariableTable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">INDEXED_VARIABLE_TABLE_INITIAL_SIZE</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">UNSET</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">array</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">futureListenerStackDepth</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">localChannelReaderStackDepth</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">handlerSharableCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">counterHashCode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">random</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">typeParameterMatcherGetCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">typeParameterMatcherFindCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stringBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">charsetEncoderCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">charsetDecoderCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">arrayList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">:</span> <span class="n">indexedVariables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="n">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">count</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We should subtract 1 from the count because the first element in &#39;indexedVariables&#39; is reserved
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// by &#39;FastThreadLocal&#39; to keep the list of &#39;FastThreadLocal&#39;s to remove on &#39;FastThreadLocal.removeAll()&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">StringBuilder</span> <span class="nf">stringBuilder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">sb</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">STRING_BUILDER_INITIAL_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">capacity</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">STRING_BUILDER_MAX_SIZE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sb</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="n">STRING_BUILDER_INITIAL_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sb</span><span class="o">.</span><span class="na">trimToSize</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">sb</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetEncoder</span><span class="o">&gt;</span> <span class="nf">charsetEncoderCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetEncoder</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">charsetEncoderCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">charsetEncoderCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdentityHashMap</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetEncoder</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetDecoder</span><span class="o">&gt;</span> <span class="nf">charsetDecoderCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetDecoder</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">charsetDecoderCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">charsetDecoderCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdentityHashMap</span><span class="o">&lt;</span><span class="n">Charset</span><span class="o">,</span> <span class="n">CharsetDecoder</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">arrayList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">arrayList</span><span class="o">(</span><span class="n">DEFAULT_ARRAY_LIST_INITIAL_CAPACITY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">arrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;)</span> <span class="n">arrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">minCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;)</span> <span class="n">arrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">ensureCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">futureListenerStackDepth</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">futureListenerStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFutureListenerStackDepth</span><span class="o">(</span><span class="kt">int</span> <span class="n">futureListenerStackDepth</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">futureListenerStackDepth</span> <span class="o">=</span> <span class="n">futureListenerStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ThreadLocalRandom</span> <span class="nf">random</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadLocalRandom</span> <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">random</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocalRandom</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;</span> <span class="nf">typeParameterMatcherGetCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">typeParameterMatcherGetCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">typeParameterMatcherGetCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdentityHashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;&gt;</span> <span class="nf">typeParameterMatcherFindCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">typeParameterMatcherFindCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">typeParameterMatcherFindCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdentityHashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeParameterMatcher</span><span class="o">&gt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IntegerHolder</span> <span class="nf">counterHashCode</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">counterHashCode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCounterHashCode</span><span class="o">(</span><span class="n">IntegerHolder</span> <span class="n">counterHashCode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">counterHashCode</span> <span class="o">=</span> <span class="n">counterHashCode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">handlerSharableCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">handlerSharableCache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Start with small capacity to keep memory overhead as low as possible.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">handlerSharableCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakHashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Boolean</span><span class="o">&gt;(</span><span class="n">HANDLER_SHARABLE_CACHE_INITIAL_CAPACITY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">localChannelReaderStackDepth</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">localChannelReaderStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLocalChannelReaderStackDepth</span><span class="o">(</span><span class="kt">int</span> <span class="n">localChannelReaderStackDepth</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">localChannelReaderStackDepth</span> <span class="o">=</span> <span class="n">localChannelReaderStackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">indexedVariable</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">.</span><span class="na">length</span><span class="o">?</span> <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">:</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@code true} if and only if a new thread-local variable has been created
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setIndexedVariable</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">expandIndexedVariableTableAndSet</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">expandIndexedVariableTableAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">oldArray</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">oldArray</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">newCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_LIST_CAPACITY_EXPAND_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">|=</span> <span class="n">newCapacity</span> <span class="o">&gt;&gt;&gt;</span>  <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">|=</span> <span class="n">newCapacity</span> <span class="o">&gt;&gt;&gt;</span>  <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">|=</span> <span class="n">newCapacity</span> <span class="o">&gt;&gt;&gt;</span>  <span class="n">4</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">|=</span> <span class="n">newCapacity</span> <span class="o">&gt;&gt;&gt;</span>  <span class="n">8</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">|=</span> <span class="n">newCapacity</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">newArray</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">oldArray</span><span class="o">,</span> <span class="n">newCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">newArray</span><span class="o">,</span> <span class="n">oldCapacity</span><span class="o">,</span> <span class="n">newArray</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">UNSET</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newArray</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">indexedVariables</span> <span class="o">=</span> <span class="n">newArray</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeIndexedVariable</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isIndexedVariableSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">!=</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCleanerFlagSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cleanerFlags</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cleanerFlags</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCleanerFlag</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cleanerFlags</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cleanerFlags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BitSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanerFlags</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="init">init</h3>
<p>每一个<code>FastThreadLocal</code>都有一个index，可以作为<code>FastThreadLocal</code>的唯一标识。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">FastThreadLocal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">index</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">nextVariableIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">nextIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Reference: https://hg.openjdk.java.net/jdk8/jdk8/jdk/file/tip/src/share/classes/java/util/ArrayList.java#l229
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">8</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">nextVariableIndex</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">nextIndex</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ARRAY_LIST_CAPACITY_MAX_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;too many thread-local indexed variables&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="get">get</h3>
<ol>
<li>获取ThreadLocalMap</li>
<li>直接通过索引取出对象</li>
<li>初始化</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns the current value for the current thread
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">V</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">indexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">initialize</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fastGet</span><span class="o">((</span><span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="n">thread</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">slowGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">fastGet</span><span class="o">(</span><span class="n">FastThreadLocalThread</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">threadLocalMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="o">.</span><span class="na">setThreadLocalMap</span><span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternalThreadLocalMap</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">slowGet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InternalThreadLocalMap</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternalThreadLocalMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">slowThreadLocalMap</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ret</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fastthreadlocalthread">FastThreadLocalThread</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A special {@link Thread} that provides fast access to {@link FastThreadLocal} variables.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FastThreadLocalThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">InternalLogger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">InternalLoggerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">FastThreadLocalThread</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// This will be set to true if we have a chance to wrap the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">cleanupFastThreadLocals</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">FastThreadLocalRunnable</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">target</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">FastThreadLocalRunnable</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">target</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">FastThreadLocalRunnable</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">target</span><span class="o">),</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">FastThreadLocalRunnable</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">target</span><span class="o">),</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">FastThreadLocalThread</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">long</span> <span class="n">stackSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">FastThreadLocalRunnable</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">target</span><span class="o">),</span> <span class="n">name</span><span class="o">,</span> <span class="n">stackSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cleanupFastThreadLocals</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the internal data structure that keeps the thread-local variables bound to this thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Note that this method is for internal use only, and thus is subject to change at any time.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">InternalThreadLocalMap</span> <span class="nf">threadLocalMap</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;It&#39;s not thread-safe to get &#39;threadLocalMap&#39; &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;which doesn&#39;t belong to the caller thread&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the internal data structure that keeps the thread-local variables bound to this thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Note that this method is for internal use only, and thus is subject to change at any time.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setThreadLocalMap</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;It&#39;s not thread-safe to set &#39;threadLocalMap&#39; &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;which doesn&#39;t belong to the caller thread&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">threadLocalMap</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if {@link FastThreadLocal#removeAll()} will be called once {@link #run()} completes.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">willCleanupFastThreadLocals</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cleanupFastThreadLocals</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if {@link FastThreadLocal#removeAll()} will be called once {@link Thread#run()} completes.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">willCleanupFastThreadLocals</span><span class="o">(</span><span class="n">Thread</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">thread</span> <span class="k">instanceof</span> <span class="n">FastThreadLocalThread</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="o">((</span><span class="n">FastThreadLocalThread</span><span class="o">)</span> <span class="n">thread</span><span class="o">).</span><span class="na">willCleanupFastThreadLocals</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">V</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">V</span> <span class="n">v</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">initialValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">setIndexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addToVariablesToRemove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@code true} if and only if a new thread-local variable has been created
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setIndexedVariable</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">indexedVariables</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="n">UNSET</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">expandIndexedVariableTableAndSet</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="set">set</h3>
<ol>
<li>获取ThreadLocalMap</li>
<li>直接通过索引set对象</li>
<li>如果是UNSET对象则remove对象</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the value for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">setKnownNotUnset</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the value for the specified thread local map. The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setKnownNotUnset</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the value to uninitialized for the specified thread local map.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this, any subsequent call to get() will trigger a new call to initialValue().
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">remove</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">getIfSet</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the value to uninitialized for the specified thread local map.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this, any subsequent call to get() will trigger a new call to initialValue().
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The specified thread local map must be for the current thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">InternalThreadLocalMap</span> <span class="n">threadLocalMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocalMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">threadLocalMap</span><span class="o">.</span><span class="na">removeIndexedVariable</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">removeFromVariablesToRemove</span><span class="o">(</span><span class="n">threadLocalMap</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">UNSET</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">onRemoval</span><span class="o">((</span><span class="n">V</span><span class="o">)</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="recycler">Recycler</h2>
<p><code>Recycler</code>是一个轻量级的对象池实现。通过重用池，可以有效减少YoungGC的次数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Recycler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">InternalLogger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">InternalLoggerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">Recycler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Handle</span><span class="o">&lt;?&gt;</span> <span class="n">NOOP_HANDLE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// NOOP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;NOOP_HANDLE&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD</span> <span class="o">=</span> <span class="n">4</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span> <span class="c1">// Use 4k instances as default.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_MAX_CAPACITY_PER_THREAD</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RATIO</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_QUEUE_CHUNK_SIZE_PER_THREAD</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">BLOCKING_POOL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// In the future, we might have different maxCapacity for different object types.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// e.g. io.netty.recycler.maxCapacity.writeTask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      io.netty.recycler.maxCapacity.outboundBuffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">maxCapacityPerThread</span> <span class="o">=</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.recycler.maxCapacityPerThread&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.recycler.maxCapacity&#34;</span><span class="o">,</span> <span class="n">DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">maxCapacityPerThread</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">maxCapacityPerThread</span> <span class="o">=</span> <span class="n">DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">DEFAULT_MAX_CAPACITY_PER_THREAD</span> <span class="o">=</span> <span class="n">maxCapacityPerThread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEFAULT_QUEUE_CHUNK_SIZE_PER_THREAD</span> <span class="o">=</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.recycler.chunkSize&#34;</span><span class="o">,</span> <span class="n">32</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// By default we allow one push to a Recycler for each 8th try on handles that were never recycled before.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This should help to slowly increase the capacity of the recycler while not be too sensitive to allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// bursts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RATIO</span> <span class="o">=</span> <span class="n">max</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;io.netty.recycler.ratio&#34;</span><span class="o">,</span> <span class="n">8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BLOCKING_POOL</span> <span class="o">=</span> <span class="n">SystemPropertyUtil</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&#34;io.netty.recycler.blocking&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">DEFAULT_MAX_CAPACITY_PER_THREAD</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.maxCapacityPerThread: disabled&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.ratio: disabled&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.chunkSize: disabled&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.blocking: disabled&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.maxCapacityPerThread: {}&#34;</span><span class="o">,</span> <span class="n">DEFAULT_MAX_CAPACITY_PER_THREAD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.ratio: {}&#34;</span><span class="o">,</span> <span class="n">RATIO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.chunkSize: {}&#34;</span><span class="o">,</span> <span class="n">DEFAULT_QUEUE_CHUNK_SIZE_PER_THREAD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;-Dio.netty.recycler.blocking: {}&#34;</span><span class="o">,</span> <span class="n">BLOCKING_POOL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCapacityPerThread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">interval</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">chunkSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">FastThreadLocal</span><span class="o">&lt;</span><span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FastThreadLocal</span><span class="o">&lt;</span><span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">maxCapacityPerThread</span><span class="o">,</span> <span class="n">interval</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRemoval</span><span class="o">(</span><span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">onRemoval</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">handles</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="o">.</span><span class="na">pooledHandles</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">handles</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">Recycler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">DEFAULT_MAX_CAPACITY_PER_THREAD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">Recycler</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacityPerThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">maxCapacityPerThread</span><span class="o">,</span> <span class="n">RATIO</span><span class="o">,</span> <span class="n">DEFAULT_QUEUE_CHUNK_SIZE_PER_THREAD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">Recycler</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacityPerThread</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ratio</span><span class="o">,</span> <span class="kt">int</span> <span class="n">chunkSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">interval</span> <span class="o">=</span> <span class="n">max</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">ratio</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">maxCapacityPerThread</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">maxCapacityPerThread</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">chunkSize</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">maxCapacityPerThread</span> <span class="o">=</span> <span class="n">max</span><span class="o">(</span><span class="n">4</span><span class="o">,</span> <span class="n">maxCapacityPerThread</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">chunkSize</span> <span class="o">=</span> <span class="n">max</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">min</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">maxCapacityPerThread</span> <span class="o">&gt;&gt;</span> <span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="从recycler获取对象">从Recycler获取对象</h4>
<ol>
<li>获取当前线程的LocalPool</li>
<li>从LocalPool里弹出对象</li>
<li>创建对象并绑定到LocalPool中</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">maxCapacityPerThread</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newObject</span><span class="o">((</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">NOOP_HANDLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">localPool</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">localPool</span><span class="o">.</span><span class="na">claim</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="n">obj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">handle</span> <span class="o">=</span> <span class="n">localPool</span><span class="o">.</span><span class="na">newHandle</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj</span> <span class="o">=</span> <span class="n">newObject</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">handle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj</span> <span class="o">=</span> <span class="n">newObject</span><span class="o">((</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">NOOP_HANDLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="回收对象">回收对象</h4>
<ol>
<li>同线程回收对象</li>
<li>不同线程回收对象</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* @deprecated use {@link Handle#recycle(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">T</span> <span class="n">o</span><span class="o">,</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">NOOP_HANDLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">handle</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;object does not belong to handle&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">localPool</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">handles</span> <span class="o">=</span> <span class="n">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">handle</span><span class="o">.</span><span class="na">toAvailable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">handles</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">handles</span><span class="o">.</span><span class="na">relaxedOffer</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">toAvailable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE_AVAILABLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">STATE_AVAILABLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Object has been recycled already.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="defaulthandle">DefaultHandle</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STATE_CLAIMED</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STATE_AVAILABLE</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">STATE_UPDATER</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;?&gt;</span> <span class="n">updater</span> <span class="o">=</span> <span class="n">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">DefaultHandle</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;state&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//noinspection unchecked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">STATE_UPDATER</span> <span class="o">=</span> <span class="o">(</span><span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;?&gt;&gt;)</span> <span class="n">updater</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;FieldMayBeFinal&#34;</span><span class="o">,</span> <span class="s">&#34;unused&#34;</span><span class="o">})</span> <span class="c1">// Updated by STATE_UPDATER.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">state</span><span class="o">;</span> <span class="c1">// State is initialised to STATE_CLAIMED (aka. 0) so they can be released.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">localPool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">T</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">DefaultHandle</span><span class="o">(</span><span class="n">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">localPool</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">localPool</span> <span class="o">=</span> <span class="n">localPool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;object does not belong to handle&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">localPool</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="nf">availableToClaim</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_AVAILABLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE_AVAILABLE</span><span class="o">,</span> <span class="n">STATE_CLAIMED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">toAvailable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE_AVAILABLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">STATE_AVAILABLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Object has been recycled already.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="localpool">LocalPool</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">LocalPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ratioInterval</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ratioCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">LocalPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ratioInterval</span><span class="o">,</span> <span class="kt">int</span> <span class="n">chunkSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">ratioInterval</span> <span class="o">=</span> <span class="n">ratioInterval</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">BLOCKING_POOL</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pooledHandles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockingMessageQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pooledHandles</span> <span class="o">=</span> <span class="o">(</span><span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;)</span> <span class="n">newMpscQueue</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ratioCounter</span> <span class="o">=</span> <span class="n">ratioInterval</span><span class="o">;</span> <span class="c1">// Start at interval so the first one will be recycled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">claim</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">handles</span> <span class="o">=</span> <span class="n">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">handles</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handle</span> <span class="o">=</span> <span class="n">handles</span><span class="o">.</span><span class="na">relaxedPoll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">handle</span><span class="o">.</span><span class="na">availableToClaim</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">handle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">handles</span> <span class="o">=</span> <span class="n">pooledHandles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">handle</span><span class="o">.</span><span class="na">toAvailable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">handles</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handles</span><span class="o">.</span><span class="na">relaxedOffer</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">newHandle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(++</span><span class="n">ratioCounter</span> <span class="o">&gt;=</span> <span class="n">ratioInterval</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ratioCounter</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="blockingmessagequeue">BlockingMessageQueue</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This is an implementation of {@link MessagePassingQueue}, similar to what might be returned from
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link PlatformDependent#newMpscQueue(int)}, but intended to be used for debugging purpose.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The implementation relies on synchronised monitor locks for thread-safety.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@code drain} and {@code fill} bulk operations are not supported by this implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BlockingMessageQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">MessagePassingQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">deque</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BlockingMessageQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">maxCapacity</span> <span class="o">=</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// This message passing queue is backed by an ArrayDeque instance,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// made thread-safe by synchronising on `this` BlockingMessageQueue instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Why ArrayDeque?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We use ArrayDeque instead of LinkedList or LinkedBlockingQueue because it&#39;s more space efficient.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We use ArrayDeque instead of ArrayList because we need the queue APIs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We use ArrayDeque instead of ConcurrentLinkedQueue because CLQ is unbounded and has O(n) size().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We use ArrayDeque instead of ArrayBlockingQueue because ABQ allocates its max capacity up-front,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and these queues will usually have large capacities, in potentially great numbers (one per thread),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// but often only have comparatively few items in them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">deque</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="n">T</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">T</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">T</span> <span class="nf">peek</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">peek</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">capacity</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">relaxedOffer</span><span class="o">(</span><span class="n">T</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">offer</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">T</span> <span class="nf">relaxedPoll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">T</span> <span class="nf">relaxedPeek</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">peek</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">drain</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">fill</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">drain</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">fill</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">drain</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="n">WaitStrategy</span> <span class="n">wait</span><span class="o">,</span> <span class="n">ExitCondition</span> <span class="n">exit</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fill</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">WaitStrategy</span> <span class="n">wait</span><span class="o">,</span> <span class="n">ExitCondition</span> <span class="n">exit</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="objectpool-1">ObjectPool</h2>
<p><code>ObjectPool</code>依赖于<code>Recycler</code>实现对象池。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Light-weight object pool.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param &lt;T&gt; the type of the pooled object
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ObjectPool</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Get a {@link Object} from the {@link ObjectPool}. The returned {@link Object} may be created via
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ObjectCreator#newObject(Handle)} if no pooled {@link Object} is ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">T</span> <span class="nf">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Handle for an pooled {@link Object} that will be used to notify the {@link ObjectPool} once it can
</span></span></span><span class="line"><span class="cl"><span class="cm">     * reuse the pooled {@link Object} again.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Recycle the {@link Object} if possible and so make it ready to be reused.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="n">T</span> <span class="n">self</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new Object which references the given {@link Handle} and calls {@link Handle#recycle(Object)} once
</span></span></span><span class="line"><span class="cl"><span class="cm">     * it can be re-used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt; the type of the pooled object
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Creates an returns a new {@link Object} that can be used and later recycled via
</span></span></span><span class="line"><span class="cl"><span class="cm">         * {@link Handle#recycle(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new {@link ObjectPool} which will use the given {@link ObjectCreator} to create the {@link Object}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that should be pooled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">newPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">RecyclerObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">creator</span><span class="o">,</span> <span class="s">&#34;creator&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecyclerObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Recycler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">recycler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">RecyclerObjectPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">ObjectCreator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="n">recycler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Recycler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="n">T</span> <span class="nf">newObject</span><span class="o">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">creator</span><span class="o">.</span><span class="na">newObject</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">recycler</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结-4">总结</h2>
<ol>
<li><code>FastThreadLocal</code>之所以比<code>ThreadLocal</code>快，主要因为<code>FastThreadLocal</code>使用下标index查找Local，而JDK的ThreadLocal使用的hash等，显然<code>FastThreadLocal</code>的<code>·</code>o(1)`复杂度的操作更快。
<ul>
<li>解决线程变量隔离</li>
</ul>
</li>
<li>轻量级对象池<code>Recycler</code>可以快速取对象，回收也更快，减少了YoungGC的次数。如果对象的属性过少，使用Recycler也可能并不划算。
<ul>
<li>解决对象重用，<code>Recycler</code>依赖于<code>FastThreadLocal</code>。</li>
</ul>
</li>
</ol>
<p>以上两种方法的思想或方法可以直接在具体的项目中使用。</p>
<h1 id="11-netty中的设计模式实现">11. Netty中的设计模式实现</h1>
<h2 id="单例模式">单例模式</h2>
<ol>
<li>一个类全局只有一个对象</li>
<li>延迟创建</li>
<li>避免线程安全问题</li>
</ol>
<h3 id="readtimeoutexception">ReadTimeoutException</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.handler.timeout</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.internal.PlatformDependent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A {@link TimeoutException} raised by {@link ReadTimeoutHandler} when no data
</span></span></span><span class="line"><span class="cl"><span class="cm"> * was read within a certain period of time.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTimeoutException</span> <span class="kd">extends</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">169287984113283421L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ReadTimeoutException</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">7</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">ReadTimeoutException</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ReadTimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ReadTimeoutException</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ReadTimeoutException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">ReadTimeoutException</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">shared</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">shared</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mqttencoder">MqttEncoder</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ChannelHandler.Sharable</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MqttEncoder</span> <span class="kd">extends</span> <span class="n">MessageToMessageEncoder</span><span class="o">&lt;</span><span class="n">MqttMessage</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">MqttEncoder</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MqttEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">MqttEncoder</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="策略模式">策略模式</h2>
<ol>
<li>封装一系列可相互替代的算法家族</li>
<li>动态选择某一个策略，需要路由到具体的策略实现</li>
</ol>
<h3 id="defaulteventexecutorchooserfactory">DefaultEventExecutorChooserFactory</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DefaultEventExecutorChooserFactory</span> <span class="kd">implements</span> <span class="n">EventExecutorChooserFactory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DefaultEventExecutorChooserFactory</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultEventExecutorChooserFactory</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">DefaultEventExecutorChooserFactory</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EventExecutorChooser</span> <span class="nf">newChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 空歌白石：策略模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isPowerOfTwo</span><span class="o">(</span><span class="n">executors</span><span class="o">.</span><span class="na">length</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">PowerOfTwoEventExecutorChooser</span><span class="o">(</span><span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">GenericEventExecutorChooser</span><span class="o">(</span><span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPowerOfTwo</span><span class="o">(</span><span class="kt">int</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">val</span><span class="o">)</span> <span class="o">==</span> <span class="n">val</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PowerOfTwoEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PowerOfTwoEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">executors</span><span class="o">[</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GenericEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Use a &#39;long&#39; counter to avoid non-round-robin behaviour at the 32-bit overflow boundary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// The 64-bit long solves this by placing the overflow so far into the future, that no system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// will encounter this in practice.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">GenericEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">executors</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Factory that creates new {@link EventExecutorChooser}s.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EventExecutorChooserFactory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns a new {@link EventExecutorChooser}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutorChooser</span> <span class="nf">newChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Chooses the next {@link EventExecutor} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@UnstableApi</span>
</span></span><span class="line"><span class="cl">    <span class="kd">interface</span> <span class="nc">EventExecutorChooser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Returns the new {@link EventExecutor} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="装饰者模式">装饰者模式</h2>
<ol>
<li>装饰者和被装饰者继承同一个接口</li>
<li>装饰者给被装饰者动态修改行为</li>
</ol>
<h3 id="wrappedbytebuf">WrappedByteBuf</h3>
<p><code>WrappedByteBuf</code>装饰了<code>ByteBuf</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Wraps another {@link ByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * It&#39;s important that the {@link #readerIndex()} and {@link #writerIndex()} will not do any adjustments on the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * indices on the fly because of internal optimizations made by {@link ByteBufUtil#writeAscii(ByteBuf, CharSequence)}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * and {@link ByteBufUtil#writeUtf8(ByteBuf, CharSequence)}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">WrappedByteBuf</span> <span class="kd">extends</span> <span class="n">ByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">WrappedByteBuf</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">buf</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="s">&#34;buf&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasMemoryAddress</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="na">hasMemoryAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isContiguous</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="na">isContiguous</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unreleasablebytebuf">UnreleasableByteBuf</h3>
<p><code>UnreleasableByteBuf</code>装饰了<code>WrappedByteBuf</code>。<code>release</code>覆盖了<code>WrappedByteBuf</code>的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A {@link ByteBuf} implementation that wraps another buffer to prevent a user from increasing or decreasing the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * wrapped buffer&#39;s reference count.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">UnreleasableByteBuf</span> <span class="kd">extends</span> <span class="n">WrappedByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SwappedByteBuf</span> <span class="n">swappedBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">UnreleasableByteBuf</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">buf</span> <span class="k">instanceof</span> <span class="n">UnreleasableByteBuf</span> <span class="o">?</span> <span class="n">buf</span><span class="o">.</span><span class="na">unwrap</span><span class="o">()</span> <span class="o">:</span> <span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">order</span><span class="o">(</span><span class="n">ByteOrder</span> <span class="n">endianness</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">endianness</span><span class="o">,</span> <span class="s">&#34;endianness&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="n">order</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">SwappedByteBuf</span> <span class="n">swappedBuf</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">swappedBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">swappedBuf</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">swappedBuf</span> <span class="o">=</span> <span class="n">swappedBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SwappedByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">swappedBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">asReadOnly</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">()</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="k">new</span> <span class="n">UnreleasableByteBuf</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">asReadOnly</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="simpleleakawarebytebuf">SimpleLeakAwareByteBuf</h3>
<p><code>SimpleLeakAwareByteBuf</code>装饰了<code>WrappedByteBuf</code>。<code>release</code>覆盖了<code>WrappedByteBuf</code>的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SimpleLeakAwareByteBuf</span> <span class="kd">extends</span> <span class="n">WrappedByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This object&#39;s is associated with the {@link ResourceLeakTracker}. When {@link ResourceLeakTracker#close(Object)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is called this object will be used as the argument. It is also assumed that this object is used when
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ResourceLeakDetector#track(Object)} is called to create {@link #leak}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">trackedByteBuf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ResourceLeakTracker</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">leak</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SimpleLeakAwareByteBuf</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">wrapped</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">trackedByteBuf</span><span class="o">,</span> <span class="n">ResourceLeakTracker</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">leak</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">wrapped</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">trackedByteBuf</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">trackedByteBuf</span><span class="o">,</span> <span class="s">&#34;trackedByteBuf&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">leak</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">leak</span><span class="o">,</span> <span class="s">&#34;leak&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SimpleLeakAwareByteBuf</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">wrapped</span><span class="o">,</span> <span class="n">ResourceLeakTracker</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">leak</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">wrapped</span><span class="o">,</span> <span class="n">wrapped</span><span class="o">,</span> <span class="n">leak</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">slice</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newSharedLeakAwareByteBuf</span><span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">slice</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">release</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">closeLeak</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="kt">int</span> <span class="n">decrement</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">decrement</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">closeLeak</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.util</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ResourceLeakTracker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Records the caller&#39;s current stack trace so that the {@link ResourceLeakDetector} can tell where the leaked
</span></span></span><span class="line"><span class="cl"><span class="cm">     * resource was accessed lastly. This method is a shortcut to {@link #record(Object) record(null)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">record</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Records the caller&#39;s current stack trace and the specified additional arbitrary information
</span></span></span><span class="line"><span class="cl"><span class="cm">     * so that the {@link ResourceLeakDetector} can tell where the leaked resource was accessed lastly.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">record</span><span class="o">(</span><span class="n">Object</span> <span class="n">hint</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Close the leak so that {@link ResourceLeakTracker} does not warn about leaked resources.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this method is called a leak associated with this ResourceLeakTracker should not be reported.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@code true} if called first time, {@code false} if called already
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">close</span><span class="o">(</span><span class="n">T</span> <span class="n">trackedObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="观察者模式">观察者模式</h2>
<ol>
<li>观察者和被观察者</li>
<li>观察者订阅消息，被观察者发布消息</li>
<li>订阅则能收到消息，取消订阅则收不到消息</li>
</ol>
<h3 id="channelfuture">ChannelFuture</h3>
<p><code>addListeners</code>方法是在添加观察者。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelFuture</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns a channel where the I/O operation associated with this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * future takes place.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">addListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">addListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">removeListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">removeListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">sync</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">syncUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">awaitUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if this {@link ChannelFuture} is a void future and so not allow to call any of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * following methods:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #addListener(GenericFutureListener)}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #addListeners(GenericFutureListener[])}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #await()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #await(long, TimeUnit)} ()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #await(long)} ()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #awaitUninterruptibly()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #sync()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *     &lt;li&gt;{@link #syncUninterruptibly()}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isVoid</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="abstractchannelhandlercontext">AbstractChannelHandlerContext</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">newPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建观察者。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">newPromise</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">(),</span> <span class="n">executor</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flush</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isNotValidPromise</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">(</span><span class="n">flush</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">MASK_WRITE</span> <span class="o">|</span> <span class="n">MASK_FLUSH</span><span class="o">)</span> <span class="o">:</span> <span class="n">MASK_WRITE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span><span class="o">.</span><span class="na">invokeWriteAndFlush</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span><span class="o">.</span><span class="na">invokeWrite</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">WriteTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">WriteTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">flush</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="o">!</span><span class="n">flush</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We failed to submit the WriteTask. We need to cancel it so we decrement the pending bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and put it back in the Recycler for re-use later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/8343.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="defaultchannelpromise">DefaultChannelPromise</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The default {@link ChannelPromise} implementation.  It is recommended to use {@link Channel#newPromise()} to create
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a new {@link ChannelPromise} rather than calling the constructor explicitly.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultChannelPromise</span> <span class="kd">extends</span> <span class="n">DefaultPromise</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">ChannelPromise</span><span class="o">,</span> <span class="n">FlushCheckpoint</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">checkpoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param channel
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the {@link Channel} associated with this future
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DefaultChannelPromise</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;channel&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param channel
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        the {@link Channel} associated with this future
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DefaultChannelPromise</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">EventExecutor</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">executor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;channel&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">EventExecutor</span> <span class="nf">executor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventExecutor</span> <span class="n">e</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">channel</span><span class="o">().</span><span class="na">eventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Channel</span> <span class="nf">channel</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">channel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">setSuccess</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">setSuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">setSuccess</span><span class="o">(</span><span class="n">Void</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">trySuccess</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">trySuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">setFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">addListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">addListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">addListeners</span><span class="o">(</span><span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">removeListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">removeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">removeListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">removeListeners</span><span class="o">(</span><span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">sync</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">syncUninterruptibly</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">syncUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">awaitUninterruptibly</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">awaitUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">flushCheckpoint</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">checkpoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flushCheckpoint</span><span class="o">(</span><span class="kt">long</span> <span class="n">checkpoint</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">promise</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkDeadLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">().</span><span class="na">isRegistered</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">checkDeadLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChannelPromise</span> <span class="nf">unvoid</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isVoid</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="defaultpromise">DefaultPromise</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* One or more listeners. Can be a {@link GenericFutureListener} or a {@link DefaultFutureListeners}.
</span></span></span><span class="line"><span class="cl"><span class="cm">* If {@code null}, it means either 1) no listeners were added yet or 2) all listeners were notified.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* Threading - synchronized(this). We must support adding listeners when there is no EventExecutor.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Object</span> <span class="n">listeners</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Threading - synchronized(this). We are required to hold the monitor to use Java&#39;s underlying wait()/notifyAll().
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">short</span> <span class="n">waiters</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Threading - synchronized(this). We must prevent concurrent notification and FIFO listener notification if the
</span></span></span><span class="line"><span class="cl"><span class="cm">* executor changes.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="n">notifyingListeners</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">addListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;...</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="s">&#34;listeners&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">addListener0</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">isDone</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">notifyListeners</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addListener0</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">listeners</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listeners</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">listeners</span> <span class="k">instanceof</span> <span class="n">DefaultFutureListeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">((</span><span class="n">DefaultFutureListeners</span><span class="o">)</span> <span class="n">listeners</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFutureListeners</span><span class="o">((</span><span class="n">GenericFutureListener</span><span class="o">&lt;?&gt;)</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyListeners</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">InternalThreadLocalMap</span> <span class="n">threadLocals</span> <span class="o">=</span> <span class="n">InternalThreadLocalMap</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">stackDepth</span> <span class="o">=</span> <span class="n">threadLocals</span><span class="o">.</span><span class="na">futureListenerStackDepth</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">&lt;</span> <span class="n">MAX_LISTENER_STACK_DEPTH</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadLocals</span><span class="o">.</span><span class="na">setFutureListenerStackDepth</span><span class="o">(</span><span class="n">stackDepth</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">notifyListenersNow</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">threadLocals</span><span class="o">.</span><span class="na">setFutureListenerStackDepth</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyListenersNow</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyListenersNow</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">listeners</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only proceed if there are listeners to notify and we are not already notifying listeners.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">notifyingListeners</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">listeners</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">notifyingListeners</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">listeners</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">listeners</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">listeners</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">listeners</span> <span class="k">instanceof</span> <span class="n">DefaultFutureListeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyListeners0</span><span class="o">((</span><span class="n">DefaultFutureListeners</span><span class="o">)</span> <span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyListener0</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?&gt;)</span> <span class="n">listeners</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">listeners</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Nothing can throw from within this method, so setting notifyingListeners back to false does not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// need to be in a finally block.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">notifyingListeners</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">listeners</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">listeners</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">listeners</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyListeners0</span><span class="o">(</span><span class="n">DefaultFutureListeners</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GenericFutureListener</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">listeners</span><span class="o">.</span><span class="na">listeners</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">listeners</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">notifyListener0</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">&#34;unchecked&#34;</span><span class="o">,</span> <span class="s">&#34;rawtypes&#34;</span> <span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">notifyListener0</span><span class="o">(</span><span class="n">Future</span> <span class="n">future</span><span class="o">,</span> <span class="n">GenericFutureListener</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">l</span><span class="o">.</span><span class="na">operationComplete</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;An exception was thrown by &#34;</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.operationComplete()&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="迭代器模式">迭代器模式</h2>
<p>netty使用迭代器模式，可以做到内存的ZeroCopy。</p>
<ol>
<li>迭代器接口</li>
<li>对容器里面各个对象进行访问</li>
</ol>
<h3 id="bytebuf-1">ByteBuf</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Iterates over the readable bytes of this buffer with the specified {@code processor} in ascending order.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return {@code -1} if the processor iterated to or beyond the end of the readable bytes.
</span></span></span><span class="line"><span class="cl"><span class="cm">*         The last-visited index If the {@link ByteProcessor#process(byte)} returned {@code false}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">forEachByte</span><span class="o">(</span><span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Iterates over the specified area of this buffer with the specified {@code processor} in ascending order.
</span></span></span><span class="line"><span class="cl"><span class="cm">* (i.e. {@code index}, {@code (index + 1)},  .. {@code (index + length - 1)})
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return {@code -1} if the processor iterated to or beyond the end of the specified area.
</span></span></span><span class="line"><span class="cl"><span class="cm">*         The last-visited index If the {@link ByteProcessor#process(byte)} returned {@code false}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">forEachByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Iterates over the readable bytes of this buffer with the specified {@code processor} in descending order.
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return {@code -1} if the processor iterated to or beyond the beginning of the readable bytes.
</span></span></span><span class="line"><span class="cl"><span class="cm">*         The last-visited index If the {@link ByteProcessor#process(byte)} returned {@code false}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">forEachByteDesc</span><span class="o">(</span><span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* Iterates over the specified area of this buffer with the specified {@code processor} in descending order.
</span></span></span><span class="line"><span class="cl"><span class="cm">* (i.e. {@code (index + length - 1)}, {@code (index + length - 2)}, ... {@code index})
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return {@code -1} if the processor iterated to or beyond the beginning of the specified area.
</span></span></span><span class="line"><span class="cl"><span class="cm">*         The last-visited index If the {@link ByteProcessor#process(byte)} returned {@code false}.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">forEachByteDesc</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="abstractbytebuf-1">AbstractByteBuf</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">forEachByte</span><span class="o">(</span><span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ensureAccessible</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">forEachByteAsc0</span><span class="o">(</span><span class="n">readerIndex</span><span class="o">,</span> <span class="n">writerIndex</span><span class="o">,</span> <span class="n">processor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">forEachByteAsc0</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">,</span> <span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">;</span> <span class="o">++</span><span class="n">start</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">processor</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">_getByte</span><span class="o">(</span><span class="n">start</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">start</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="compositebytebuf">CompositeByteBuf</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">forEachByteAsc0</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">,</span> <span class="n">ByteProcessor</span> <span class="n">processor</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">toComponentIndex0</span><span class="o">(</span><span class="n">start</span><span class="o">),</span> <span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Component</span> <span class="n">c</span> <span class="o">=</span> <span class="n">components</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">offset</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="na">endOffset</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span> <span class="c1">// empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">buf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">localStart</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">idx</span><span class="o">(</span><span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">localLength</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">length</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">endOffset</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// avoid additional checks in AbstractByteBuf case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">s</span> <span class="k">instanceof</span> <span class="n">AbstractByteBuf</span>
</span></span><span class="line"><span class="cl">            <span class="o">?</span> <span class="o">((</span><span class="n">AbstractByteBuf</span><span class="o">)</span> <span class="n">s</span><span class="o">).</span><span class="na">forEachByteAsc0</span><span class="o">(</span><span class="n">localStart</span><span class="o">,</span> <span class="n">localStart</span> <span class="o">+</span> <span class="n">localLength</span><span class="o">,</span> <span class="n">processor</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span> <span class="n">s</span><span class="o">.</span><span class="na">forEachByte</span><span class="o">(</span><span class="n">localStart</span><span class="o">,</span> <span class="n">localLength</span><span class="o">,</span> <span class="n">processor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="na">adjustment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">+=</span> <span class="n">localLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">-=</span> <span class="n">localLength</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Add the given {@link ByteBuf} and increase the {@code writerIndex} if {@code increaseWriterIndex} is
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@code true}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link ByteBuf#release()} ownership of {@code buffer} is transferred to this {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param buffer the {@link ByteBuf} to add. {@link ByteBuf#release()} ownership is transferred to this
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">CompositeByteBuf</span> <span class="nf">addComponent</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">increaseWriterIndex</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">addComponent</span><span class="o">(</span><span class="n">increaseWriterIndex</span><span class="o">,</span> <span class="n">componentCount</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Add the given {@link ByteBuf} on the specific index and increase the {@code writerIndex}
</span></span></span><span class="line"><span class="cl"><span class="cm">    * if {@code increaseWriterIndex} is {@code true}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link ByteBuf#release()} ownership of {@code buffer} is transferred to this {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param cIndex the index on which the {@link ByteBuf} will be added.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param buffer the {@link ByteBuf} to add. {@link ByteBuf#release()} ownership is transferred to this
</span></span></span><span class="line"><span class="cl"><span class="cm">    * {@link CompositeByteBuf}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">CompositeByteBuf</span> <span class="nf">addComponent</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">increaseWriterIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cIndex</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="s">&#34;buffer&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">addComponent0</span><span class="o">(</span><span class="n">increaseWriterIndex</span><span class="o">,</span> <span class="n">cIndex</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">consolidateIfNeeded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="责任链模式">责任链模式</h2>
<p>使得多个对象都有机会处理同一请求，避免请求的发送者和接受者的耦合关系。每个处理对象选择是否处理责任链的请求。</p>
<ol>
<li>责任处理器接口</li>
<li>创建责任链，添加删除责任处理器接口</li>
<li>上下文的集合</li>
<li>责任终止机制</li>
</ol>
<p>Head &lt;-&gt; TaskA &lt;-&gt; TaskC &lt;-&gt; TaskB &lt;-&gt; Tail</p>
<h3 id="channelhandler责任处理器接口">ChannelHandler（责任处理器接口）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called after the {@link ChannelHandler} was added to the actual context and it&#39;s ready to handle events.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called after the {@link ChannelHandler} was removed from the actual context and it doesn&#39;t handle events
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anymore.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if a {@link Throwable} was thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated if you want to handle this event you should implement {@link ChannelInboundHandler} and
</span></span></span><span class="line"><span class="cl"><span class="cm">     * implement the method there.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Indicates that the same instance of the annotated {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * can be added to one or more {@link ChannelPipeline}s multiple times
</span></span></span><span class="line"><span class="cl"><span class="cm">     * without a race condition.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If this annotation is not specified, you have to create a new handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * instance every time you add it to a pipeline because it has unshared
</span></span></span><span class="line"><span class="cl"><span class="cm">     * state such as member variables.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This annotation is provided for documentation purpose, just like
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;a href=&#34;http://www.javaconcurrencyinpractice.com/annotations/doc/&#34;&gt;the JCIP annotations&lt;/a&gt;.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Inherited</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Documented</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@interface</span> <span class="n">Sharable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// no value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="channelinboundhandler">ChannelInboundHandler</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ChannelHandler} which adds callbacks for state changes. This allows the user
</span></span></span><span class="line"><span class="cl"><span class="cm"> * to hook in to state changes easily.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelInboundHandler</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was registered with its {@link EventLoop}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was unregistered from its {@link EventLoop}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelUnregistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} is now active
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link Channel} of the {@link ChannelHandlerContext} was registered is now inactive and reached its
</span></span></span><span class="line"><span class="cl"><span class="cm">     * end of lifetime.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoked when the current {@link Channel} has read a message from the peer.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoked when the last message read by the current read operation has been consumed by
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link #channelRead(ChannelHandlerContext, Object)}.  If {@link ChannelOption#AUTO_READ} is off, no further
</span></span></span><span class="line"><span class="cl"><span class="cm">     * attempt to read an inbound data from the current {@link Channel} will be made until
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelHandlerContext#read()} is called.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if an user event was triggered.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called once the writable state of a {@link Channel} changed. You can check the state with
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel#isWritable()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets called if a {@link Throwable} was thrown.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="channeloutboundhandler">ChannelOutboundHandler</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ChannelHandler} which will get notified for IO-outbound-operations.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelOutboundHandler</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a bind operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx           the {@link ChannelHandlerContext} for which the bind operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param localAddress  the {@link SocketAddress} to which it should bound
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise       the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception    thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a connect operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the connect operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param remoteAddress     the {@link SocketAddress} to which it should connect
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param localAddress      the {@link SocketAddress} which is used as source on connect
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a disconnect operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the disconnect operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a close operation is made.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the close operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a deregister operation is made from the current registered {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the close operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">deregister</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Intercepts {@link ChannelHandlerContext#read()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">read</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called once a write operation is made. The write operation will write the messages through the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelPipeline}. Those are then ready to be flushed to the actual {@link Channel} once
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Channel#flush()} is called
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the write operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param msg               the message to write
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param promise           the {@link ChannelPromise} to notify once the operation completes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Called once a flush operation is made. The flush operation will try to flush out all previous written messages
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that are pending.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx               the {@link ChannelHandlerContext} for which the flush operation is made
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception        thrown if an error occurs
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channelpipeline责任链">ChannelPipeline（责任链）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelPipeline</span>
</span></span><span class="line"><span class="cl">        <span class="kd">extends</span> <span class="n">ChannelInboundInvoker</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span><span class="o">,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} at the first position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name     the name of the handler to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler  the handler to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addFirst</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} at the first position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group    the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                 methods
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name     the name of the handler to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler  the handler to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addFirst</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Appends a {@link ChannelHandler} at the last position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name     the name of the handler to append
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler  the handler to append
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Appends a {@link ChannelHandler} at the last position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group    the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                 methods
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name     the name of the handler to append
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler  the handler to append
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} before an existing handler of this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param baseName  the name of the existing handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name      the name of the handler to insert before
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler   the handler to insert before
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such entry with the specified {@code baseName}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified baseName or handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addBefore</span><span class="o">(</span><span class="n">String</span> <span class="n">baseName</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} before an existing handler of this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group     the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  methods
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param baseName  the name of the existing handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name      the name of the handler to insert before
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler   the handler to insert before
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such entry with the specified {@code baseName}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified baseName or handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addBefore</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">baseName</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} after an existing handler of this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param baseName  the name of the existing handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name      the name of the handler to insert after
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler   the handler to insert after
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such entry with the specified {@code baseName}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified baseName or handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addAfter</span><span class="o">(</span><span class="n">String</span> <span class="n">baseName</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts a {@link ChannelHandler} after an existing handler of this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group     the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  methods
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param baseName  the name of the existing handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name      the name of the handler to insert after
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handler   the handler to insert after
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such entry with the specified {@code baseName}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s an entry with the same name already in the pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified baseName or handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addAfter</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">baseName</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts {@link ChannelHandler}s at the first position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handlers  the handlers to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addFirst</span><span class="o">(</span><span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts {@link ChannelHandler}s at the first position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group     the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}s
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handlers  the handlers to insert first
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addFirst</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts {@link ChannelHandler}s at the last position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handlers  the handlers to insert last
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Inserts {@link ChannelHandler}s at the last position of this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param group     the {@link EventExecutorGroup} which will be used to execute the {@link ChannelHandler}s
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                  methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handlers  the handlers to insert last
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes the specified {@link ChannelHandler} from this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  handler          the {@link ChannelHandler} to remove
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such handler in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">remove</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes the {@link ChannelHandler} with the specified name from this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  name             the name under which the {@link ChannelHandler} was stored.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such handler with the specified name in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified name is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes the {@link ChannelHandler} of the specified type from this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt;           the type of the handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param handlerType   the type of the handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if there&#39;s no such handler of the specified type in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified handler type is {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handlerType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes the first {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if this pipeline is empty
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">removeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Removes the last {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if this pipeline is empty
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">removeLast</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Replaces the specified {@link ChannelHandler} with a new handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  oldHandler    the {@link ChannelHandler} to be replaced
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newName       the name under which the replacement should be added
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newHandler    the {@link ChannelHandler} which is used as replacement
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return itself
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified old handler does not exist in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if a handler with the specified new name already exists in this
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         pipeline, except for the handler to be replaced
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified old handler or new handler is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">replace</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">oldHandler</span><span class="o">,</span> <span class="n">String</span> <span class="n">newName</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">newHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Replaces the {@link ChannelHandler} of the specified name with a new handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  oldName       the name of the {@link ChannelHandler} to be replaced
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newName       the name under which the replacement should be added
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newHandler    the {@link ChannelHandler} which is used as replacement
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the handler with the specified old name does not exist in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if a handler with the specified new name already exists in this
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         pipeline, except for the handler to be replaced
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified old handler or new handler is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">replace</span><span class="o">(</span><span class="n">String</span> <span class="n">oldName</span><span class="o">,</span> <span class="n">String</span> <span class="n">newName</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">newHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Replaces the {@link ChannelHandler} of the specified type with a new handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  oldHandlerType   the type of the handler to be removed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newName          the name under which the replacement should be added
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param  newHandler       the {@link ChannelHandler} which is used as replacement
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the removed handler
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NoSuchElementException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the handler of the specified old handler type does not exist
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         in this pipeline
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws IllegalArgumentException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if a handler with the specified new name already exists in this
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         pipeline, except for the handler to be replaced
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         if the specified old handler or new handler is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">replace</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">oldHandlerType</span><span class="o">,</span> <span class="n">String</span> <span class="n">newName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">ChannelHandler</span> <span class="n">newHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the first {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the first handler.  {@code null} if this pipeline is empty.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">first</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the context of the first {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the context of the first handler.  {@code null} if this pipeline is empty.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">firstContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the last {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the last handler.  {@code null} if this pipeline is empty.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">last</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the context of the last {@link ChannelHandler} in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the context of the last handler.  {@code null} if this pipeline is empty.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">lastContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link ChannelHandler} with the specified name in this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the handler with the specified name.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null} if there&#39;s no such handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link ChannelHandler} of the specified type in this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the handler of the specified handler type.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null} if there&#39;s no such handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">handlerType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the context object of the specified {@link ChannelHandler} in
</span></span></span><span class="line"><span class="cl"><span class="cm">     * this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the context object of the specified handler.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null} if there&#39;s no such handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">context</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the context object of the {@link ChannelHandler} with the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * specified name in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the context object of the handler with the specified name.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null} if there&#39;s no such handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">context</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the context object of the {@link ChannelHandler} of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * specified type in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the context object of the handler of the specified type.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *         {@code null} if there&#39;s no such handler in this pipeline.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">context</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span><span class="o">&gt;</span> <span class="n">handlerType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link Channel} that this pipeline is attached to.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the channel. {@code null} if this pipeline is not attached yet.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link List} of the handler names.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">names</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Converts this pipeline into an ordered {@link Map} whose keys are
</span></span></span><span class="line"><span class="cl"><span class="cm">     * handler names and whose values are handlers.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">&gt;</span> <span class="nf">toMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelUnregistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelInactive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireUserEventTriggered</span><span class="o">(</span><span class="n">Object</span> <span class="n">event</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelReadComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">flush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channelhandlercontext上下文">ChannelHandlerContext（上下文）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandlerContext</span> <span class="kd">extends</span> <span class="n">AttributeMap</span><span class="o">,</span> <span class="n">ChannelInboundInvoker</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the {@link Channel} which is bound to the {@link ChannelHandlerContext}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns the {@link EventExecutor} which is used to execute an arbitrary task.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="nf">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The unique name of the {@link ChannelHandlerContext}.The name was used when then {@link ChannelHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * was added to the {@link ChannelPipeline}. This name can also be used to access the registered
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelHandler} from the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">name</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The {@link ChannelHandler} that is bound this {@link ChannelHandlerContext}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandler</span> <span class="nf">handler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return {@code true} if the {@link ChannelHandler} which belongs to this context was removed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * from the {@link ChannelPipeline}. Note that this method is only meant to be called from with in the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link EventLoop}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isRemoved</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelUnregistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelInactive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireUserEventTriggered</span><span class="o">(</span><span class="n">Object</span> <span class="n">evt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelReadComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelHandlerContext</span> <span class="nf">flush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the assigned {@link ChannelPipeline}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the assigned {@link ByteBufAllocator} which will be used to allocate {@link ByteBuf}s.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBufAllocator</span> <span class="nf">alloc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated Use {@link Channel#attr(AttributeKey)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Attribute</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">attr</span><span class="o">(</span><span class="n">AttributeKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated Use {@link Channel#hasAttr(AttributeKey)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">hasAttr</span><span class="o">(</span><span class="n">AttributeKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="责任终止机制">责任终止机制</h3>
<p>通过链表来向下传播，或向上终止。</p>
<h4 id="channelhandlercontext-1">ChannelHandlerContext</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelUnregistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelInactive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireUserEventTriggered</span><span class="o">(</span><span class="n">Object</span> <span class="n">evt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelReadComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="channelinboundhandleradapter">ChannelInboundHandlerAdapter</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Calls {@link ChannelHandlerContext#fireChannelActive()} to forward
</span></span></span><span class="line"><span class="cl"><span class="cm">    * to the next {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Sub-classes may override this method to change behavior.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Skip</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Calls {@link ChannelHandlerContext#fireChannelRead(Object)} to forward
</span></span></span><span class="line"><span class="cl"><span class="cm">    * to the next {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Sub-classes may override this method to change behavior.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Skip</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="12-netty应用的性能优化">12. Netty应用的性能优化</h1>
<ol>
<li>单机百万连接调优</li>
<li>Netty应用级别性能优化</li>
</ol>
<h2 id="单机百万连接调优">单机百万连接调优</h2>
<ol>
<li>如何模拟百万连接</li>
<li>突破局部文件句柄限制
<ul>
<li>一个TCP连接就对应一个局部文件句柄</li>
</ul>
</li>
<li>突破全局文件句柄限制</li>
</ol>
<h3 id="如何模拟百万连接">如何模拟百万连接</h3>
<ul>
<li>Server -&gt; Port:8000</li>
<li>Cient -&gt; 1025-&gt;65535
<ul>
<li>一般只有6万个左右的连接</li>
</ul>
</li>
</ul>
<p>两种方式</p>
<ol>
<li>同时启动多个客户端
<ul>
<li>并不太实际，要启动100个客户端</li>
</ul>
</li>
<li>Server启动8000-81000端口，Client启动1025-&gt;65535
<ul>
<li>由Server的增加100倍，就可以默认百万连接。</li>
<li>TCP连接的四维参数：Server + ServerPort + Client + ClientPort</li>
</ul>
</li>
</ol>
<h3 id="突破局部文件句柄限制">突破局部文件句柄限制</h3>
<p>操作步骤：</p>
<ul>
<li><code>ulimit -n</code> 查看最大文件数
<ul>
<li>一个进程可以打开的最大文件数</li>
<li>一个TCP连接在liunx中对应的是一个文件</li>
</ul>
</li>
<li>打开<code>/etc/security/limits.conf</code>
<ul>
<li>添加以下两行代码 * 表示当前用户
<ul>
<li><code>* hard nofile 1000000</code></li>
<li><code>* soft nofile 1000000</code></li>
</ul>
</li>
</ul>
</li>
<li>重启VM
<ul>
<li>其中会有<code>booting VM</code>的日志信息</li>
</ul>
</li>
</ul>
<h3 id="突破全局文件句柄限制">突破全局文件句柄限制</h3>
<p>操作步骤：</p>
<ul>
<li><code>cat /proc/sys/fs/file-max</code>
<ul>
<li>可以看到全局文件句柄数量限制，一般是<code>10000</code></li>
</ul>
</li>
<li><code>sudo -s</code></li>
<li><code>echo 20000 &gt; /proc/sys/fs/file-max</code>
<ul>
<li>将最大数量限制从<code>10000</code>修改为<code>20000</code></li>
</ul>
</li>
<li><code>exit</code></li>
</ul>
<p>以上方法重启VM，最大全局句柄限制仍然会恢复原值。</p>
<ul>
<li>打开<code>/etc/sysctl.conf</code></li>
<li>添加以下内容
<ul>
<li><code>fs.file-max=1000000</code>，表示全局文件句柄限制为一百万。</li>
</ul>
</li>
<li><code>sudo sysctl -p</code>
<ul>
<li>将修改内容生效。</li>
</ul>
</li>
</ul>
<p>以上方法重启VM，最大全局句柄限制file-max不会改变。</p>
<p><code>htop</code>查看性能。</p>
<h2 id="netty应用级别性能优化">Netty应用级别性能优化</h2>
<p>建立客户端和服务端连接，每隔一段时间进行通信。需要分析block的具体哪块代码或逻辑中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TypeParameterMatcher</span> <span class="n">matcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #SimpleChannelInboundHandler(boolean)} with {@code true} as boolean parameter.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance which will try to detect the types to match out of the type parameter of the class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param autoRelease   {@code true} if handled messages should be released automatically by passing them to
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                      {@link ReferenceCountUtil#release(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;I&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">autoRelease</span> <span class="o">=</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * see {@link #SimpleChannelInboundHandler(Class, boolean)} with {@code true} as boolean value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">inboundMessageType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">inboundMessageType</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param inboundMessageType    The type of messages to match
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param autoRelease           {@code true} if handled messages should be released automatically by passing them to
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                              {@link ReferenceCountUtil#release(Object)}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">SimpleChannelInboundHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">inboundMessageType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">autoRelease</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matcher</span> <span class="o">=</span> <span class="n">TypeParameterMatcher</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inboundMessageType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">autoRelease</span> <span class="o">=</span> <span class="n">autoRelease</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns {@code true} if the given message should be handled. If {@code false} it will be passed to the next
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelInboundHandler} in the {@link ChannelPipeline}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">acceptInboundMessage</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">matcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">release</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">acceptInboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">imsg</span> <span class="o">=</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">channelRead0</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">imsg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">release</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">autoRelease</span> <span class="o">&amp;&amp;</span> <span class="n">release</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Is called for each message of type {@link I}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ctx           the {@link ChannelHandlerContext} which this {@link SimpleChannelInboundHandler}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                      belongs to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param msg           the message to handle
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception    is thrown if an error occurred
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">I</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="自建executorservice">自建ExecutorService</h3>
<ol>
<li>将业务逻辑从主线程中剥离，放在独立的业务线程中处理。</li>
<li>调整业务线程池线程数量
<ul>
<li>全部的线程可能在某些情况全部被占用处理新的请求</li>
<li>后续的请求仍然是在排队中，造成响应时间上升</li>
<li>线程数量不能无限制扩大，会线程上下文切换的消耗</li>
</ul>
</li>
</ol>
<h3 id="利用netty原生的线程池">利用Netty原生的线程池</h3>
<p>使用<code>EventLoopGroup group = new NioEventLoopGroup(n);</code>替换自定义的<code>ExecutorService</code>。</p>
<h4 id="eventloopgroup">EventLoopGroup</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.channel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.concurrent.EventExecutorGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Special {@link EventExecutorGroup} which allows registering {@link Channel}s that get
</span></span></span><span class="line"><span class="cl"><span class="cm"> * processed for later selection during the event loop.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EventLoopGroup</span> <span class="kd">extends</span> <span class="n">EventExecutorGroup</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Return the next {@link EventLoop} to use
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoop</span> <span class="nf">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Register a {@link Channel} with this {@link EventLoop}. The returned {@link ChannelFuture}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will get notified once the registration was complete.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Register a {@link Channel} with this {@link EventLoop} using a {@link ChannelFuture}. The passed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link ChannelFuture} will get notified once the registration was complete and also will get returned.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Register a {@link Channel} with this {@link EventLoop}. The passed {@link ChannelFuture}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will get notified once the registration was complete and also will get returned.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated Use {@link #register(ChannelPromise)} instead.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nioeventloopgroup">NioEventLoopGroup</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">io.netty.channel.nio</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.DefaultSelectStrategyFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.EventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopTaskQueueFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.MultithreadEventLoopGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.SelectStrategyFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.channel.SingleThreadEventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.concurrent.EventExecutor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.concurrent.EventExecutorChooserFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.concurrent.RejectedExecutionHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.netty.util.concurrent.RejectedExecutionHandlers</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.nio.channels.Selector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.nio.channels.spi.SelectorProvider</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.ThreadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link MultithreadEventLoopGroup} implementations which is used for NIO {@link Selector} based {@link Channel}s.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NioEventLoopGroup</span> <span class="kd">extends</span> <span class="n">MultithreadEventLoopGroup</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance using the default number of threads, the default {@link ThreadFactory} and
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance using the specified number of threads, {@link ThreadFactory} and the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="o">(</span><span class="n">Executor</span><span class="o">)</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance using the default number of threads, the given {@link ThreadFactory} and the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="n">SelectorProvider</span><span class="o">.</span><span class="na">provider</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance using the specified number of threads, the given {@link ThreadFactory} and the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="n">SelectorProvider</span><span class="o">.</span><span class="na">provider</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">SelectorProvider</span><span class="o">.</span><span class="na">provider</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a new instance using the specified number of threads, the given {@link ThreadFactory} and the given
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link SelectorProvider}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">DefaultSelectStrategyFactory</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span> <span class="n">RejectedExecutionHandlers</span><span class="o">.</span><span class="na">reject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">DefaultSelectStrategyFactory</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span> <span class="n">RejectedExecutionHandlers</span><span class="o">.</span><span class="na">reject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">RejectedExecutionHandlers</span><span class="o">.</span><span class="na">reject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span> <span class="n">rejectedExecutionHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kd">final</span> <span class="n">EventLoopTaskQueueFactory</span> <span class="n">taskQueueFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">rejectedExecutionHandler</span><span class="o">,</span> <span class="n">taskQueueFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param nThreads the number of threads that will be used by this instance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param executor the Executor to use, or {@code null} if default one should be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param chooserFactory the {@link EventExecutorChooserFactory} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param selectorProvider the {@link SelectorProvider} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param selectStrategyFactory the {@link SelectStrategyFactory} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param rejectedExecutionHandler the {@link RejectedExecutionHandler} to use.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param taskQueueFactory the {@link EventLoopTaskQueueFactory} to use for
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                         {@link SingleThreadEventLoop#execute(Runnable)},
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                         or {@code null} if default one should be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param tailTaskQueueFactory the {@link EventLoopTaskQueueFactory} to use for
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                             {@link SingleThreadEventLoop#executeAfterEventLoopIteration(Runnable)},
</span></span></span><span class="line"><span class="cl"><span class="cm">     *                             or {@code null} if default one should be used.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">EventLoopTaskQueueFactory</span> <span class="n">taskQueueFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">EventLoopTaskQueueFactory</span> <span class="n">tailTaskQueueFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span> <span class="n">selectStrategyFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">rejectedExecutionHandler</span><span class="o">,</span> <span class="n">taskQueueFactory</span><span class="o">,</span> <span class="n">tailTaskQueueFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the percentage of the desired amount of time spent for I/O in the child event loops.  The default value is
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@code 50}, which means the event loop will try to spend the same amount of time for I/O as for non-I/O tasks.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIoRatio</span><span class="o">(</span><span class="kt">int</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">EventExecutor</span> <span class="n">e</span><span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">NioEventLoop</span><span class="o">)</span> <span class="n">e</span><span class="o">).</span><span class="na">setIoRatio</span><span class="o">(</span><span class="n">ioRatio</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Replaces the current {@link Selector}s of the child event loops with newly created {@link Selector}s to work
</span></span></span><span class="line"><span class="cl"><span class="cm">     * around the  infamous epoll 100% CPU bug.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rebuildSelectors</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">EventExecutor</span> <span class="n">e</span><span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">NioEventLoop</span><span class="o">)</span> <span class="n">e</span><span class="o">).</span><span class="na">rebuildSelector</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">EventLoop</span> <span class="nf">newChild</span><span class="o">(</span><span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SelectorProvider</span> <span class="n">selectorProvider</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectorProvider</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">SelectStrategyFactory</span> <span class="n">selectStrategyFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectStrategyFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">RejectedExecutionHandler</span> <span class="n">rejectedExecutionHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">RejectedExecutionHandler</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">2</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventLoopTaskQueueFactory</span> <span class="n">taskQueueFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventLoopTaskQueueFactory</span> <span class="n">tailTaskQueueFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">argsLength</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">argsLength</span> <span class="o">&gt;</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">taskQueueFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">EventLoopTaskQueueFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">3</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">argsLength</span> <span class="o">&gt;</span> <span class="n">4</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tailTaskQueueFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">EventLoopTaskQueueFactory</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">4</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">NioEventLoop</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">selectorProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">selectStrategyFactory</span><span class="o">.</span><span class="na">newSelectStrategy</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">rejectedExecutionHandler</span><span class="o">,</span> <span class="n">taskQueueFactory</span><span class="o">,</span> <span class="n">tailTaskQueueFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="总结-5">总结</h3>
<p>耗时较长的操作，比如数据库或网络，99%都很快，1%比较慢，需要把请求放到单独的线程池处理，如果更精细的话，可以将1%的放在单独的线程池处理。这些都需要大量的调优尝试才可以。没有一成不变的通用方法。</p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">空歌白石</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-07-31
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://en.wikipedia.org/wiki/Wikipedia:Text_of_Creative_Commons_Attribution-ShareAlike_3.0_Unported_License" target="_blank">Creative Commons Attribution-ShareAlike License</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/netty/">Netty</a>
          <a href="/tags/%E6%BA%90%E7%A0%81/">源码</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/java%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7heap-memory%E5%92%8Cnative-memory/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Java性能监控与故障处理分析工具（Heap memory和Native memory）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/01.-what-is-operational-research/">
            <span class="next-text nav-default">【程序员学习运筹学】（一）什么是运筹学</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:liubr1491@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/liubr1491" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/2631831764" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/maybe1491" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com/people/196351890" class="iconfont icon-douban" title="douban"></a>
      <a href="https://space.bilibili.com/473428902" class="iconfont icon-bilibili" title="bilibili"></a>
      <a href="https://juejin.cn/user/1310273590294168" class="iconfont icon-link" title="link"></a>
  <a href="https://liubr1491.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2020 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>空歌白石</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>








</body>
</html>
